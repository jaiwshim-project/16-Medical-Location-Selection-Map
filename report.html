<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 입지분석 리포트 — 덴탈맵AI 치과개원 입지분석</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=31e72c61dc30008b32241bb45325abfa&libraries=services&autoload=false"></script>
<script>tailwind.config={theme:{extend:{fontFamily:{sans:['Pretendard Variable','Pretendard','system-ui','sans-serif']}}}}</script>
<style>
html{scroll-behavior:smooth}
body{font-family:'Pretendard Variable','Pretendard',system-ui,sans-serif}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse-ring{0%{transform:scale(.8);opacity:.5}50%{transform:scale(1.2);opacity:0}100%{transform:scale(.8);opacity:.5}}
@keyframes marker-pulse{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.5)}70%{box-shadow:0 0 0 12px rgba(245,158,11,0)}}
@keyframes loadBar{0%{width:0}100%{width:100%}}
@keyframes count-up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .6s ease-out forwards;opacity:0}
.fade-in-1{animation-delay:.1s}.fade-in-2{animation-delay:.2s}.fade-in-3{animation-delay:.3s}
.fade-in-4{animation-delay:.4s}.fade-in-5{animation-delay:.5s}.fade-in-6{animation-delay:.6s}
.fade-in-7{animation-delay:.7s}.fade-in-8{animation-delay:.8s}.fade-in-9{animation-delay:.9s}
.fade-in-10{animation-delay:1s}
.leaflet-container{font-family:'Pretendard Variable',sans-serif;z-index:0}
.map-legend{background:white;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,.15);padding:0;font-size:12px;line-height:1.6;max-width:180px;color:#374151;overflow:hidden}
#report-map .leaflet-top.leaflet-right .map-legend{margin-top:10px}
.leaflet-control-attribution{font-size:9px!important;opacity:0.7}
.map-legend h4{font-size:12px;font-weight:700;margin:0;padding:8px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none}
.map-legend h4 .leg-arrow{transition:transform .2s;font-size:10px}
.map-legend.collapsed h4 .leg-arrow{transform:rotate(-90deg)}
.map-legend.collapsed .leg-body{display:none}
.map-legend .leg-body{max-height:none;overflow-y:visible;padding:8px 12px 10px}
.map-legend .leg-section{margin-top:6px;padding-top:5px;border-top:1px solid #f3f4f6}
.map-legend .leg-section:first-of-type{margin-top:0;padding-top:0;border-top:none}
.map-legend .leg-title{font-size:10px;font-weight:700;color:#6b7280;letter-spacing:.5px;margin-bottom:3px}
.map-legend .leg-row{display:flex;align-items:center;gap:5px;margin:1px 0;font-size:11px}
.map-legend .leg-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid white;box-shadow:0 1px 2px rgba(0,0,0,.2);flex-shrink:0}
.clinic-scroll{}
@media print{
  header,footer,.no-print{display:none!important}
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
  body{background:white!important}
  html,body{width:100%!important;margin:0!important;padding:0!important}
  @page{size:A4;margin:10mm 8mm}
  .fade-in,.fade-in-1,.fade-in-2,.fade-in-3,.fade-in-4,.fade-in-5,.fade-in-6,.fade-in-7,.fade-in-8,.fade-in-9,.fade-in-10{opacity:1!important;transform:none!important;animation:none!important}
  section{break-inside:avoid;page-break-inside:avoid}
  .leaflet-container{height:400px!important}
  [class*="shadow"]{box-shadow:none!important}
  [class*="backdrop-blur"]{-webkit-backdrop-filter:none!important;backdrop-filter:none!important}
  [class*="bg-white/10"],[class*="bg-white/5"]{background:rgba(255,255,255,0.25)!important}
  .bg-gradient-to-br.from-slate-900{background:linear-gradient(to bottom right,#0f172a,#1e3a5f,#1e293b)!important}
}
</style>
</head>
<body class="antialiased bg-gray-50 text-gray-900">

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-sky-100/90 backdrop-blur border-b border-sky-200 no-print">
<div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
<a href="index.html" class="flex items-center gap-2"><div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-sm">D</span></div><span class="font-bold text-lg text-blue-900">덴탈맵AI <span class="text-base font-semibold text-blue-600">치과개원 입지분석</span></span></a>
<nav class="hidden md:flex items-center gap-8">
<a href="analysis.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">입지분석</a>
<a href="map.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">지도 탐색</a>
<a href="pricing.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">요금제</a>
<span class="text-sm text-blue-600 font-semibold border-b-2 border-blue-600 pb-0.5">리포트</span>
<a href="promo.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">홍보</a>
<a href="faq.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">FAQ</a>
<a href="manual.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">사용자 매뉴얼</a>
</nav>
<div class="hidden md:flex items-center gap-3"><a href="map.html" class="bg-blue-600 text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition">바로 체험하기</a></div>
<button class="md:hidden p-2 text-blue-800" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
</div>
<div id="mobile-menu" class="hidden md:hidden border-t border-sky-200 bg-sky-50 px-6 py-4 space-y-3">
<a href="analysis.html" class="block text-blue-800 font-medium py-2">입지분석</a>
<a href="map.html" class="block text-blue-800 font-medium py-2">지도 탐색</a>
<a href="pricing.html" class="block text-blue-800 font-medium py-2">요금제</a>
<span class="block text-blue-600 font-semibold py-2">리포트</span>
<a href="promo.html" class="block text-blue-800 font-medium py-2">홍보</a>
<a href="faq.html" class="block text-blue-800 font-medium py-2">FAQ</a>
<a href="manual.html" class="block text-blue-800 font-medium py-2">사용자 매뉴얼</a>
<hr class="border-gray-100">
<a href="map.html" class="block bg-blue-600 text-white text-center py-2.5 rounded-lg font-semibold">바로 체험하기</a>
</div>
</header>

<main>
<div id="report-root"></div>
</main>

<!-- FOOTER -->
<footer class="bg-gray-900 text-gray-400 py-12 no-print"><div class="max-w-7xl mx-auto px-6">
<div class="grid md:grid-cols-4 gap-8">
<div><div class="flex items-center gap-2 mb-3"><div class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-xs">D</span></div><span class="font-bold text-white">덴탈맵AI <span class="text-sm font-medium text-gray-300">치과개원 입지분석</span></span></div><p class="text-sm">데이터로 찾는 최적의 치과 개원 입지</p></div>
<div><h3 class="text-white font-semibold mb-3 text-sm">서비스</h3><div class="space-y-2 text-sm"><a href="analysis.html" class="block hover:text-white transition">입지분석</a><a href="map.html" class="block hover:text-white transition">지도 탐색</a><a href="pricing.html" class="block hover:text-white transition">요금제</a></div></div>
<div><h3 class="text-white font-semibold mb-3 text-sm">지원</h3><div class="space-y-2 text-sm"><a href="faq.html" class="block hover:text-white transition">자주 묻는 질문</a><a href="manual.html" class="block hover:text-white transition">사용자 매뉴얼</a><a href="index.html" class="block hover:text-white transition">홈으로</a></div></div>
<div><h3 class="text-white font-semibold mb-3 text-sm">연락처</h3><div class="space-y-2 text-sm"><p>심재우 대표</p><p><a href="mailto:jaiwshim@gmail.com" class="hover:text-white">jaiwshim@gmail.com</a></p><p><a href="tel:010-2397-5734" class="hover:text-white">010-2397-5734</a></p></div></div>
</div>
<div class="border-t border-gray-800 mt-8 pt-8 text-xs"><p>덴탈맵AI 치과개원 입지분석 | 심재우 대표</p><p class="mt-1">문의: <a href="mailto:jaiwshim@gmail.com" class="text-gray-400 hover:text-white">jaiwshim@gmail.com</a> · <a href="tel:010-2397-5734" class="text-gray-400 hover:text-white">010-2397-5734</a></p><p class="mt-2">&copy; 2025 DentalMap. All rights reserved.</p><p class="mt-2 text-gray-600">본 서비스의 분석 결과는 참고용이며, 투자 결정에 대한 법적 책임을 지지 않습니다.</p></div>
</div></footer>

<script>
/* ═══════════════════════════════════════════════════════════════
   MOCK DATA & UTILITIES
   ═══════════════════════════════════════════════════════════════ */
const REGIONS=[
{dong_code:"1168010100",sido:"서울",sigungu:"강남구",dong:"역삼동",population:32450,age_20_39_pct:35,age_40_59_pct:28,age_60_plus_pct:19,dental_count:12,pop_per_clinic:2704,avg_rent_pyeong:18,area_pyeong:40,subway_station:"역삼역",subway_line:"2호선",subway_walk_min:3,bus_stops_500m:8,daily_floating:85000,pop_growth_rate:1.2,commercial_grade:"A",scores:{population:82,competition:55,cost:48,access:91,growth:68,total:72},grade:"B",lat:37.5007,lng:127.0365},
{dong_code:"1165010700",sido:"서울",sigungu:"서초구",dong:"서초동",population:28300,age_20_39_pct:32,age_40_59_pct:30,age_60_plus_pct:20,dental_count:15,pop_per_clinic:1887,avg_rent_pyeong:20,area_pyeong:40,subway_station:"서초역",subway_line:"2호선",subway_walk_min:5,bus_stops_500m:6,daily_floating:72000,pop_growth_rate:0.8,commercial_grade:"A",scores:{population:75,competition:42,cost:40,access:85,growth:60,total:63},grade:"C",lat:37.4837,lng:127.0073},
{dong_code:"4146310100",sido:"경기",sigungu:"성남시 분당구",dong:"판교동",population:41200,age_20_39_pct:40,age_40_59_pct:32,age_60_plus_pct:10,dental_count:8,pop_per_clinic:5150,avg_rent_pyeong:12,area_pyeong:40,subway_station:"판교역",subway_line:"신분당선",subway_walk_min:7,bus_stops_500m:5,daily_floating:95000,pop_growth_rate:5.8,commercial_grade:"A",scores:{population:90,competition:82,cost:72,access:75,growth:95,total:85},grade:"A",lat:37.3948,lng:127.1112},
{dong_code:"1120010300",sido:"서울",sigungu:"성동구",dong:"성수동",population:25600,age_20_39_pct:42,age_40_59_pct:25,age_60_plus_pct:15,dental_count:6,pop_per_clinic:4267,avg_rent_pyeong:14,area_pyeong:35,subway_station:"성수역",subway_line:"2호선",subway_walk_min:4,bus_stops_500m:7,daily_floating:68000,pop_growth_rate:4.2,commercial_grade:"B",scores:{population:78,competition:78,cost:65,access:88,growth:88,total:79},grade:"B",lat:37.5445,lng:127.0564},
{dong_code:"1174010100",sido:"서울",sigungu:"마포구",dong:"합정동",population:19800,age_20_39_pct:45,age_40_59_pct:22,age_60_plus_pct:14,dental_count:7,pop_per_clinic:2829,avg_rent_pyeong:13,area_pyeong:30,subway_station:"합정역",subway_line:"2·6호선",subway_walk_min:2,bus_stops_500m:9,daily_floating:62000,pop_growth_rate:3.1,commercial_grade:"B",scores:{population:68,competition:65,cost:68,access:95,growth:82,total:74},grade:"B",lat:37.5496,lng:126.9139},
{dong_code:"4111710100",sido:"경기",sigungu:"수원시 영통구",dong:"광교동",population:52000,age_20_39_pct:38,age_40_59_pct:35,age_60_plus_pct:8,dental_count:10,pop_per_clinic:5200,avg_rent_pyeong:10,area_pyeong:45,subway_station:"광교역",subway_line:"신분당선",subway_walk_min:8,bus_stops_500m:4,daily_floating:45000,pop_growth_rate:7.2,commercial_grade:"B",scores:{population:92,competition:85,cost:80,access:68,growth:98,total:87},grade:"A",lat:37.2935,lng:127.0454},
{dong_code:"3020011200",sido:"대전",sigungu:"유성구",dong:"봉명동",population:35800,age_20_39_pct:36,age_40_59_pct:28,age_60_plus_pct:16,dental_count:9,pop_per_clinic:3978,avg_rent_pyeong:8,area_pyeong:40,subway_station:"시청역",subway_line:"1호선",subway_walk_min:10,bus_stops_500m:6,daily_floating:38000,pop_growth_rate:2.5,commercial_grade:"B",scores:{population:80,competition:72,cost:88,access:62,growth:75,total:77},grade:"B",lat:36.3623,lng:127.3561},
{dong_code:"2644010100",sido:"부산",sigungu:"해운대구",dong:"우동",population:48500,age_20_39_pct:30,age_40_59_pct:32,age_60_plus_pct:18,dental_count:14,pop_per_clinic:3464,avg_rent_pyeong:11,area_pyeong:40,subway_station:"해운대역",subway_line:"2호선",subway_walk_min:6,bus_stops_500m:7,daily_floating:55000,pop_growth_rate:1.5,commercial_grade:"A",scores:{population:85,competition:60,cost:75,access:78,growth:65,total:74},grade:"B",lat:35.1631,lng:129.1636},
{dong_code:"1171010100",sido:"서울",sigungu:"송파구",dong:"잠실동",population:38700,age_20_39_pct:33,age_40_59_pct:30,age_60_plus_pct:17,dental_count:11,pop_per_clinic:3518,avg_rent_pyeong:15,area_pyeong:40,subway_station:"잠실역",subway_line:"2·8호선",subway_walk_min:3,bus_stops_500m:9,daily_floating:92000,pop_growth_rate:1.8,commercial_grade:"A",scores:{population:84,competition:62,cost:55,access:92,growth:70,total:74},grade:"B",lat:37.5133,lng:127.1001}
];

function fmt(n){return new Intl.NumberFormat('ko-KR').format(n)}
function getGradeColor(g){return{S:'text-purple-600 bg-purple-50',A:'text-blue-600 bg-blue-50',B:'text-green-600 bg-green-50',C:'text-yellow-600 bg-yellow-50',D:'text-orange-600 bg-orange-50'}[g]||'text-red-600 bg-red-50'}
function getScoreColor(s){return s>=80?'text-blue-600':s>=60?'text-green-600':s>=40?'text-yellow-600':'text-red-500'}
function getScoreBarColor(s){return s>=80?'bg-blue-500':s>=60?'bg-green-500':s>=40?'bg-yellow-500':'bg-red-500'}
function fmtRevKr(v){return v>=10000?((v/10000).toFixed(1)+'억'):(fmt(v)+'만')}
function hashStr(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return Math.abs(h)}
function seededRand(seed,min,max){seed=(seed*9301+49297)%233280;return min+Math.floor((seed/233280)*(max-min+1))}
function distM(lat1,lng1,lat2,lng2){const dLat=(lat2-lat1)*111320;const dLng=(lng2-lng1)*111320*Math.cos((lat1+lat2)/2*Math.PI/180);return Math.sqrt(dLat*dLat+dLng*dLng)}

/* ── HIRA 정적 데이터 로드 (data/clinics.json) ── */
let _clinicsCache=null;
async function loadClinicData(){
  if(_clinicsCache)return _clinicsCache;
  try{
    var resp=await fetch('data/clinics.json',{signal:AbortSignal.timeout(8000)});
    if(!resp.ok)return null;
    var data=await resp.json();
    if(!data.clinics||data.clinics.length===0)return null;
    _clinicsCache=data;
    console.log('[DentalMap] HIRA 정적 데이터 로드 완료:',data.clinics.length,'개 치과,',data.meta?.fetched||'날짜미상');
    return data;
  }catch(e){console.warn('[DentalMap] clinics.json 로드 실패:',e.message);return null}
}
function expandClinic(it,idx){
  var h=hashStr(it.n+idx),s=h*100+idx;
  var drCnt=Math.max(1,it.d||1);
  var chairs=Math.max(2,Math.round(drCnt*2.5));
  var estbDd=it.e;
  var estYear=typeof estbDd==='number'&&estbDd>19500000?Math.floor(estbDd/10000):typeof estbDd==='string'&&estbDd.length>=4?parseInt(estbDd.substring(0,4)):2015;
  if(estYear<1950||estYear>2026)estYear=2015;
  var yearsOpen=Math.max(1,2025-estYear);
  var yrFactor=Math.min(1.3,1+Math.max(0,yearsOpen-3)*0.02);
  var sz=Math.max(15,Math.round(chairs*7+seededRand(s*41,-3,5)));
  var annRev=Math.round((chairs*7000+sz*120+seededRand(s*43,-3000,8000))*yrFactor);
  var monthlyRev=Math.round(annRev/12);
  var dailyPat=Math.max(5,Math.round(chairs*seededRand(s*47,3,7)+seededRand(s*51,-3,5)));
  var hygienistCnt=Math.max(1,Math.round(chairs*0.8)+seededRand(s*57,-1,1));
  var totalStaff=drCnt+hygienistCnt+Math.max(1,seededRand(s*59,1,Math.round(chairs*0.5)+1));
  var insClaims=Math.round(dailyPat*22*seededRand(s*61,60,85)/100);
  var nonCovRatio=seededRand(s*63,25,65);
  var naverRating=(seededRand(s*67,30,50)/10).toFixed(1);
  var naverReviewCnt=Math.round(yearsOpen*seededRand(s*69,15,80)+seededRand(s*71,0,100));
  var blogExposure=seededRand(s*73,50,2000);
  var specPool=['임플란트','치아교정','심미보철','소아진료','잇몸치료','충치치료','미백','턱관절','사랑니발치','투명교정','라미네이트'];
  var specCnt=seededRand(s*75,2,5),specs=[];
  for(var j=0;j<specCnt;j++){var sp=specPool[seededRand(s*77+j*13,0,specPool.length-1)];if(specs.indexOf(sp)<0)specs.push(sp)}
  var nightWeekend=seededRand(s*79,0,2);
  var priceLvl=['저가','중간','고가'][seededRand(s*81,0,2)];
  var threatLvl=chairs>=5&&yearsOpen>=5?'높음':chairs>=3?'보통':'낮음';
  var sameTypeNearby=seededRand(s*83,0,4);
  var forSale=seededRand(s*89,0,12)===0;
  var estAcqPrice=forSale?Math.round(annRev*seededRand(s*91,8,18)/10):null;
  return{name:it.n,type:it.c===41?'치과병원':'치과의원',
    director:'',lat:it.y,lng:it.x,
    address:it.a||'',phone:it.t||'',
    estYear:estYear,rating:naverRating,chairs:chairs,
    hasParking:seededRand(s*31,0,1)===1,floor:'',size:sz+'평',annualRevenue:annRev,
    monthlyRevenue:monthlyRev,dailyPatients:dailyPat,dentistCount:drCnt,hygienistCount:hygienistCnt,
    totalStaff:totalStaff,insuranceClaims:insClaims,nonCoverageRatio:nonCovRatio,
    naverRating:naverRating,naverReviewCount:naverReviewCnt,blogExposure:blogExposure,
    specialties:specs,nightWeekend:nightWeekend,priceLevel:priceLvl,yearsOpen:yearsOpen,
    competitionThreat:threatLvl,sameTypeNearby:sameTypeNearby,
    status:'영업중',forSale:forSale,estimatedAcquisitionPrice:estAcqPrice,
    _real:true};
}
async function fetchRealClinics(lat,lng,radius){
  var data=await loadClinicData();
  if(!data)return null;
  var r=radius||1000;
  var nearby=[];
  for(var i=0;i<data.clinics.length;i++){
    var c=data.clinics[i];
    var d=distM(lat,lng,c.y,c.x);
    if(d<=r){c._dist=d;nearby.push(c)}
  }
  if(nearby.length===0)return null;
  nearby.sort(function(a,b){return a._dist-b._dist});
  if(nearby.length>50)nearby=nearby.slice(0,50);
  console.log('[DentalMap] 반경',r+'m 내 실제 치과:',nearby.length,'개');
  return nearby.map(function(it,idx){return expandClinic(it,idx)});
}

/* ── 카카오 지오코딩 (키워드 검색) ── */
async function kakaoGeocode(query){
  if(typeof kakao==='undefined'){console.warn('[DentalMap] kakao SDK 미로드');return null}
  if(!kakao.maps){console.warn('[DentalMap] kakao.maps 없음');return null}
  return new Promise(function(resolve){
    try{
      kakao.maps.load(function(){
        try{
          var ps=new kakao.maps.services.Places();
          ps.keywordSearch(query,function(data,status){
            console.log('[DentalMap] 카카오 검색 상태:',status,'결과:',data?data.length:0);
            if(status!==kakao.maps.services.Status.OK||!data.length){resolve(null);return}
            var place=data[0];
            var addr=place.address_name||'';
            var parts=addr.split(' ');
            resolve({lat:parseFloat(place.y),lng:parseFloat(place.x),sido:parts[0]||'',sigungu:parts[1]||'',placeName:place.place_name,address:addr});
          });
        }catch(e){console.error('[DentalMap] 카카오 검색 오류:',e);resolve(null)}
      });
    }catch(e){console.error('[DentalMap] kakao.maps.load 오류:',e);resolve(null)}
  });
}

/* ═══════════════════════════════════════════════════════════════
   GEO RESOLUTION
   ═══════════════════════════════════════════════════════════════ */
function resolveGeoFromName(name){
  const areas=[
    {kw:['대전'],lat:36.3504,lng:126.3845,sido:'대전광역시',gu:[{kw:'중구',lat:36.3254,lng:127.4214},{kw:'서구',lat:36.3555,lng:127.3835},{kw:'동구',lat:36.3121,lng:127.4549},{kw:'유성구',lat:36.3622,lng:127.3561},{kw:'대덕구',lat:36.3467,lng:127.4153}]},
    {kw:['서울'],lat:37.5665,lng:126.978,sido:'서울특별시',gu:[{kw:'강남구',lat:37.5172,lng:127.0473},{kw:'서초구',lat:37.4837,lng:127.0324},{kw:'송파구',lat:37.5145,lng:127.1050},{kw:'강동구',lat:37.5301,lng:127.1238},{kw:'마포구',lat:37.5664,lng:126.9018},{kw:'용산구',lat:37.5326,lng:126.9906},{kw:'종로구',lat:37.5735,lng:126.9790},{kw:'중구',lat:37.5641,lng:126.9979},{kw:'영등포구',lat:37.5264,lng:126.8963},{kw:'강서구',lat:37.5510,lng:126.8495},{kw:'구로구',lat:37.4954,lng:126.8874},{kw:'관악구',lat:37.4784,lng:126.9516},{kw:'동작구',lat:37.5124,lng:126.9393},{kw:'성동구',lat:37.5634,lng:127.0369},{kw:'광진구',lat:37.5385,lng:127.0823},{kw:'동대문구',lat:37.5744,lng:127.0396},{kw:'중랑구',lat:37.6063,lng:127.0926},{kw:'성북구',lat:37.5894,lng:127.0164},{kw:'강북구',lat:37.6397,lng:127.0253},{kw:'도봉구',lat:37.6688,lng:127.0471},{kw:'노원구',lat:37.6542,lng:127.0568},{kw:'은평구',lat:37.6027,lng:126.9291},{kw:'서대문구',lat:37.5791,lng:126.9368},{kw:'양천구',lat:37.5170,lng:126.8664},{kw:'금천구',lat:37.4569,lng:126.8955}]},
    {kw:['부산'],lat:35.1796,lng:129.0756,sido:'부산광역시',gu:[{kw:'해운대구',lat:35.1631,lng:129.1636},{kw:'부산진구',lat:35.1631,lng:129.0533},{kw:'동래구',lat:35.2050,lng:129.0858},{kw:'남구',lat:35.1368,lng:129.0845},{kw:'중구',lat:35.1060,lng:129.0325},{kw:'서구',lat:35.0982,lng:129.0244},{kw:'북구',lat:35.1974,lng:129.0312},{kw:'사상구',lat:35.1526,lng:128.9912},{kw:'연제구',lat:35.1762,lng:129.0801},{kw:'수영구',lat:35.1458,lng:129.1133},{kw:'금정구',lat:35.2432,lng:129.0913},{kw:'사하구',lat:35.1046,lng:128.9747},{kw:'강서구',lat:35.2121,lng:128.9809}]},
    {kw:['인천'],lat:37.4563,lng:126.7052,sido:'인천광역시',gu:[{kw:'남동구',lat:37.4488,lng:126.7369},{kw:'부평구',lat:37.5076,lng:126.7219},{kw:'연수구',lat:37.4101,lng:126.6783},{kw:'서구',lat:37.5451,lng:126.6760},{kw:'중구',lat:37.4738,lng:126.6217},{kw:'미추홀구',lat:37.4421,lng:126.6993},{kw:'계양구',lat:37.5372,lng:126.7376}]},
    {kw:['대구'],lat:35.8714,lng:128.6014,sido:'대구광역시',gu:[{kw:'중구',lat:35.8694,lng:128.6064},{kw:'수성구',lat:35.8583,lng:128.6315},{kw:'달서구',lat:35.8299,lng:128.5327},{kw:'북구',lat:35.8858,lng:128.5828},{kw:'동구',lat:35.8864,lng:128.6355},{kw:'서구',lat:35.8718,lng:128.5592},{kw:'남구',lat:35.8460,lng:128.5975}]},
    {kw:['광주'],lat:35.1595,lng:126.8526,sido:'광주광역시',gu:[{kw:'서구',lat:35.1522,lng:126.8895},{kw:'북구',lat:35.1744,lng:126.9120},{kw:'남구',lat:35.1326,lng:126.9024},{kw:'동구',lat:35.1461,lng:126.9231},{kw:'광산구',lat:35.1395,lng:126.7938}]},
    {kw:['울산'],lat:35.5384,lng:129.3114,sido:'울산광역시',gu:[{kw:'남구',lat:35.5444,lng:129.3303},{kw:'중구',lat:35.5694,lng:129.3327},{kw:'동구',lat:35.5050,lng:129.4166},{kw:'북구',lat:35.5826,lng:129.3610},{kw:'울주군',lat:35.5224,lng:129.2441}]},
    {kw:['세종'],lat:36.4801,lng:126.9270,sido:'세종특별자치시',gu:[]},
    {kw:['수원'],lat:37.2636,lng:127.0286,sido:'경기도',gu:[{kw:'영통구',lat:37.2596,lng:127.0462},{kw:'팔달구',lat:37.2829,lng:127.0204},{kw:'장안구',lat:37.3038,lng:127.0101},{kw:'권선구',lat:37.2572,lng:126.9719}]},
    {kw:['성남'],lat:37.4200,lng:127.1267,sido:'경기도',gu:[{kw:'분당구',lat:37.3825,lng:127.1188},{kw:'수정구',lat:37.4504,lng:127.1457},{kw:'중원구',lat:37.4317,lng:127.1372}]},
    {kw:['고양'],lat:37.6584,lng:126.8320,sido:'경기도',gu:[{kw:'일산동구',lat:37.6586,lng:126.7742},{kw:'일산서구',lat:37.6756,lng:126.7513},{kw:'덕양구',lat:37.6376,lng:126.8320}]},
    {kw:['용인'],lat:37.2411,lng:127.1775,sido:'경기도',gu:[{kw:'수지구',lat:37.3219,lng:127.0981},{kw:'기흥구',lat:37.2802,lng:127.1151},{kw:'처인구',lat:37.2342,lng:127.2019}]},
    {kw:['창원'],lat:35.2280,lng:128.6811,sido:'경상남도',gu:[{kw:'성산구',lat:35.1989,lng:128.7119},{kw:'의창구',lat:35.2538,lng:128.6389},{kw:'마산합포구',lat:35.1855,lng:128.5683},{kw:'마산회원구',lat:35.2215,lng:128.5813},{kw:'진해구',lat:35.1336,lng:128.7107}]},
    {kw:['청주'],lat:36.6424,lng:127.4890,sido:'충청북도',gu:[{kw:'흥덕구',lat:36.6373,lng:127.4329},{kw:'서원구',lat:36.6093,lng:127.4712},{kw:'상당구',lat:36.6539,lng:127.4901},{kw:'청원구',lat:36.6952,lng:127.4879}]},
    {kw:['전주'],lat:35.8242,lng:127.1480,sido:'전라북도',gu:[{kw:'완산구',lat:35.8123,lng:127.1365},{kw:'덕진구',lat:35.8423,lng:127.1344}]},
    {kw:['천안'],lat:36.8151,lng:127.1139,sido:'충청남도',gu:[{kw:'서북구',lat:36.8502,lng:127.1435},{kw:'동남구',lat:36.7889,lng:127.1652}]},
    {kw:['안산'],lat:37.3219,lng:126.8309,sido:'경기도',gu:[{kw:'상록구',lat:37.3004,lng:126.8461},{kw:'단원구',lat:37.3184,lng:126.7962}]},
    {kw:['안양'],lat:37.3943,lng:126.9568,sido:'경기도',gu:[{kw:'만안구',lat:37.3866,lng:126.9327},{kw:'동안구',lat:37.3929,lng:126.9517}]},
    {kw:['제주'],lat:33.4996,lng:126.5312,sido:'제주특별자치도',gu:[{kw:'제주시',lat:33.5100,lng:126.5219},{kw:'서귀포시',lat:33.2532,lng:126.5597}]},
    {kw:['포항'],lat:36.0190,lng:129.3435,sido:'경상북도',gu:[{kw:'남구',lat:35.9987,lng:129.3652},{kw:'북구',lat:36.0441,lng:129.3719}]},
    {kw:['김해'],lat:35.2285,lng:128.8894,sido:'경상남도',gu:[]},{kw:['평택'],lat:36.9921,lng:127.0866,sido:'경기도',gu:[]},{kw:['파주'],lat:37.7599,lng:126.7801,sido:'경기도',gu:[]},{kw:['시흥'],lat:37.3800,lng:126.8028,sido:'경기도',gu:[]},{kw:['화성'],lat:37.1994,lng:126.8313,sido:'경기도',gu:[]},{kw:['김포'],lat:37.6152,lng:126.7156,sido:'경기도',gu:[]},{kw:['광명'],lat:37.4786,lng:126.8645,sido:'경기도',gu:[]},{kw:['군포'],lat:37.3614,lng:126.9352,sido:'경기도',gu:[]},{kw:['하남'],lat:37.5393,lng:127.2147,sido:'경기도',gu:[]},{kw:['양산'],lat:35.3350,lng:129.0372,sido:'경상남도',gu:[]},{kw:['구미'],lat:36.1197,lng:128.3440,sido:'경상북도',gu:[]},{kw:['춘천'],lat:37.8813,lng:127.7300,sido:'강원특별자치도',gu:[]},{kw:['원주'],lat:37.3423,lng:127.9202,sido:'강원특별자치도',gu:[]},{kw:['강릉'],lat:37.7519,lng:128.8761,sido:'강원특별자치도',gu:[]},{kw:['여수'],lat:34.7604,lng:127.6622,sido:'전라남도',gu:[]},{kw:['순천'],lat:34.9506,lng:127.4872,sido:'전라남도',gu:[]},{kw:['목포'],lat:34.8118,lng:126.3922,sido:'전라남도',gu:[]},{kw:['익산'],lat:35.9483,lng:126.9577,sido:'전라북도',gu:[]},{kw:['군산'],lat:35.9674,lng:126.7369,sido:'전라북도',gu:[]},{kw:['경주'],lat:35.8562,lng:129.2247,sido:'경상북도',gu:[]},{kw:['거제'],lat:34.8806,lng:128.6213,sido:'경상남도',gu:[]},{kw:['양주'],lat:37.7854,lng:127.0456,sido:'경기도',gu:[]},{kw:['의정부'],lat:37.7381,lng:127.0337,sido:'경기도',gu:[]},{kw:['남양주'],lat:37.6360,lng:127.2163,sido:'경기도',gu:[]},{kw:['이천'],lat:37.2720,lng:127.4348,sido:'경기도',gu:[]},{kw:['오산'],lat:37.1498,lng:127.0697,sido:'경기도',gu:[]},{kw:['광주시','경기 광주'],lat:37.4095,lng:127.2551,sido:'경기도',gu:[]},{kw:['충주'],lat:36.9910,lng:127.9259,sido:'충청북도',gu:[]},{kw:['아산'],lat:36.7899,lng:127.0018,sido:'충청남도',gu:[]},{kw:['서산'],lat:36.7845,lng:126.4503,sido:'충청남도',gu:[]},{kw:['홍대','홍대입구'],lat:37.5563,lng:126.9237,sido:'서울특별시',gu:[]},{kw:['잠실'],lat:37.5133,lng:127.1001,sido:'서울특별시',gu:[]},{kw:['강남'],lat:37.4979,lng:127.0276,sido:'서울특별시',gu:[]},{kw:['판교'],lat:37.3947,lng:127.1112,sido:'경기도',gu:[]},{kw:['이수','이수역'],lat:37.4856,lng:126.9818,sido:'서울특별시',gu:[{kw:'동작구',lat:37.5124,lng:126.9393}]}
  ];
  let baseLat=37.5665,baseLng=126.978,sido='',sigungu='';
  for(const a of areas){if(a.kw.some(k=>name.includes(k))){baseLat=a.lat;baseLng=a.lng;sido=a.sido;for(const g of a.gu){if(name.includes(g.kw)){baseLat=g.lat;baseLng=g.lng;sigungu=g.kw;break}}if(!sigungu&&a.kw[0])sigungu=a.kw[0];break}}
  return{lat:baseLat,lng:baseLng,sido:sido,sigungu:sigungu};
}

/* ═══════════════════════════════════════════════════════════════
   REGION GENERATION
   ═══════════════════════════════════════════════════════════════ */
async function generateRegion(name){
  const h=hashStr(name),r=n=>(a,b)=>seededRand(h*n+n,a,b);
  /* 1차: 카카오 지오코딩, 2차: 키워드 매칭 폴백 */
  const kakaoResult=await kakaoGeocode(name).catch(function(){return null});
  const fallback=resolveGeoFromName(name);
  const geo=kakaoResult||fallback;
  if(!geo.sido&&fallback.sido)geo.sido=fallback.sido;
  if(!geo.sigungu&&fallback.sigungu)geo.sigungu=fallback.sigungu;
  if(kakaoResult)console.log('[DentalMap] 카카오 지오코딩:',kakaoResult.placeName,'→',kakaoResult.lat,kakaoResult.lng);
  const pop=r(1)(15000,60000),dental=r(2)(3,18),rent=r(3)(6,22),area=r(4)(25,50),wk=r(5)(2,15),bus=r(6)(2,10),fl=r(7)(20000,100000);
  const gr=parseFloat(((r(8)(0,80)-20)/10).toFixed(1)),a20=r(9)(25,48),a40=r(10)(20,35),a60=Math.max(0,100-a20-a40);
  const ps=Math.min(100,Math.max(30,Math.round(pop/600)+r(11)(-5,5))),cs=Math.min(100,Math.max(20,100-dental*5+r(12)(-5,10)));
  const co=Math.min(100,Math.max(20,100-rent*3+r(13)(-5,5))),ac=Math.min(100,Math.max(30,100-wk*4+bus*3+r(14)(-5,5)));
  const gs=Math.min(100,Math.max(20,50+Math.round(gr*8)+r(15)(-5,5)));
  const tot=Math.round(ps*0.25+cs*0.25+co*0.2+ac*0.15+gs*0.15);
  const gd=tot>=80?'A':tot>=70?'B':tot>=60?'C':'D';
  const localStations=geo.sido.includes('대전')?['대전역','유성온천역','탄방역','시청역','중앙로역','대동역','정부청사역','갈마역','월평역','용문역']:
    geo.sido.includes('부산')?['서면역','해운대역','부산역','남포동역','센텀시티역','동래역','덕천역','사상역','연산역','수영역']:
    geo.sido.includes('대구')?['반월당역','동대구역','중앙로역','수성구청역','범어역','달서구청역','성당못역','두류역','칠성시장역','만평역']:
    geo.sido.includes('인천')?['부평역','인천역','구월역','간석역','인천시청역','주안역','송도역','청라역','작전역','부개역']:
    geo.sido.includes('광주')?['상무역','금남로역','양동시장역','운천역','송정역','첨단역','평동역','녹동역','학동역','남광주역']:
    geo.sido.includes('울산')?['울산역','태화강역','신복역','덕하역','남창역','울산KTX역','효문역','야음역','선암역','장생포역']:
    ['역삼역','강남역','홍대입구역','신촌역','잠실역','건대입구역','사당역','왕십리역','을지로역','종각역','신림역','판교역','수원역','인천역'];
  const lns=geo.sido.includes('대전')?['1호선','대전1호선']:geo.sido.includes('부산')?['1호선','2호선','3호선','4호선','동해선']:geo.sido.includes('대구')?['1호선','2호선','3호선']:geo.sido.includes('광주')?['1호선']:['2호선','3호선','4호선','7호선','9호선','신분당선','경의중앙선','1호선','5호선','6호선'];
  const cg=['A','B','C'];
  const jitter=kakaoResult?0:0.002;
  return{dong_code:'GEN'+h.toString().slice(0,7).padStart(7,'0'),sido:geo.sido,sigungu:geo.sigungu,dong:name,population:pop,age_20_39_pct:a20,age_40_59_pct:a40,age_60_plus_pct:a60,dental_count:dental,pop_per_clinic:Math.round(pop/dental),avg_rent_pyeong:rent,area_pyeong:area,subway_station:localStations[h%localStations.length],subway_line:lns[h%lns.length],subway_walk_min:wk,bus_stops_500m:bus,daily_floating:fl,pop_growth_rate:gr,commercial_grade:cg[h%cg.length],scores:{population:ps,competition:cs,cost:co,access:ac,growth:gs,total:tot},grade:gd,lat:geo.lat+((h%100)-50)*jitter/50,lng:geo.lng+((h%100)-50)*jitter/50,_generated:true,_kakaoGeo:!!kakaoResult};
}
async function addGeneratedRegion(name){const ex=REGIONS.find(r=>r.dong===name&&r._generated);if(ex)return ex;const r=await generateRegion(name);REGIONS.push(r);return r}

/* ═══════════════════════════════════════════════════════════════
   TEXT GENERATOR
   ═══════════════════════════════════════════════════════════════ */
function genTexts(r){
  const popText=r.scores.population>=80?'반경 1km 내 거주인구 '+fmt(r.population)+'명으로 치과 수요가 충분합니다. 특히 20~39세 인구가 '+r.age_20_39_pct+'%로 심미·교정 진료 수요가 높을 것으로 예상됩니다.':r.scores.population>=50?'거주인구 '+fmt(r.population)+'명은 평균 수준입니다. 20~39세 비중이 '+r.age_20_39_pct+'%이며, 주간 유동인구 '+fmt(r.daily_floating)+'명을 함께 고려하면 실질 수요는 양호합니다.':'반경 1km 거주인구 '+fmt(r.population)+'명으로 수요 기반이 다소 취약합니다.';
  const compText=r.scores.competition>=70?'반경 500m 내 치과 '+r.dental_count+'개로 경쟁이 적습니다. 인구당 치과 비율 1:'+fmt(r.pop_per_clinic)+'로 양호한 수준입니다.':r.scores.competition>=50?'반경 500m 내 치과 '+r.dental_count+'개는 평균 수준입니다. 차별화 전략이 필요합니다.':'반경 500m 내 치과 '+r.dental_count+'개로 경쟁이 치열합니다. 인구당 치과 1:'+fmt(r.pop_per_clinic)+'.';
  const costText=r.scores.cost>=70?'평당 임대료 '+r.avg_rent_pyeong+'만원은 합리적입니다. '+r.area_pyeong+'평 기준 월 '+fmt(r.avg_rent_pyeong*r.area_pyeong)+'만원으로 초기 부담이 낮습니다.':r.scores.cost>=50?'평당 임대료 '+r.avg_rent_pyeong+'만원은 보통 수준입니다. 월 '+fmt(r.avg_rent_pyeong*r.area_pyeong)+'만원 예상.':'평당 임대료 '+r.avg_rent_pyeong+'만원은 높은 편입니다. 월 '+fmt(r.avg_rent_pyeong*r.area_pyeong)+'만원 이상 소요됩니다.';
  const accessText='가장 가까운 역 '+r.subway_station+'('+r.subway_line+', 도보 '+r.subway_walk_min+'분), 반경 500m 내 버스정류장 '+r.bus_stops_500m+'개. 일 유동인구 '+fmt(r.daily_floating)+'명으로 '+(r.daily_floating>=50000?'매우 우수한':'양호한')+' 접근성입니다.';
  const growthText=r.pop_growth_rate>3?'인구 증가율 +'+r.pop_growth_rate+'%로 성장 잠재력이 매우 높습니다. 신규 수요 창출이 기대됩니다.':r.pop_growth_rate>0?'인구 증가율 +'+r.pop_growth_rate+'%로 완만한 성장세입니다. 안정적인 수요가 유지될 것으로 보입니다.':'인구 변동 '+r.pop_growth_rate+'%로 성장이 정체되어 있습니다.';
  return{popText,compText,costText,accessText,growthText};
}

/* ═══════════════════════════════════════════════════════════════
   CLINIC GENERATION (from analysis.html)
   ═══════════════════════════════════════════════════════════════ */
function generateNearbyClinics(r){
  const h=hashStr(r.dong_code||r.dong),cnt=r.dental_count||8,clinics=[];
  const types=['일반치과','교정치과','소아치과','임플란트치과','심미치과','통합치과'];
  const pfx=['서울','미소','해피','스마일','연세','이든','푸른','맑은','새봄','하나','온','빛','늘','좋은','밝은','참'];
  const dirs=['김','이','박','최','정','강','조','윤','장','임','한','오','서','신','권','황'];
  const specPool=['임플란트','치아교정','심미보철','소아진료','잇몸치료','충치치료','미백','턱관절','사랑니발치','치아성형','투명교정','라미네이트'];
  for(let i=0;i<cnt;i++){const s=h*100+i;
    const chairs=seededRand(s*29,2,8),sz=seededRand(s*41,15,60),ey=2024-seededRand(s*19,1,15);
    const yearsOpen=2024-ey;const yrFactor=Math.min(1.3,1+Math.max(0,yearsOpen-3)*0.02);
    const annRev=Math.round((chairs*7000+sz*120+seededRand(s*43,-3000,8000))*yrFactor);const monthlyRev=Math.round(annRev/12);
    const dailyPat=Math.max(5,Math.round(chairs*seededRand(s*47,3,7)+seededRand(s*51,-3,5)));
    const dentistCnt=Math.max(1,Math.round(chairs/2.5)+seededRand(s*53,-1,1));
    const hygienistCnt=Math.max(1,Math.round(chairs*0.8)+seededRand(s*57,-1,1));
    const totalStaff=dentistCnt+hygienistCnt+Math.max(1,seededRand(s*59,1,Math.round(chairs*0.5)+1));
    const insClaims=Math.round(dailyPat*22*seededRand(s*61,60,85)/100);const nonCovRatio=seededRand(s*63,25,65);
    const naverRating=(seededRand(s*67,30,50)/10).toFixed(1);
    const naverReviewCnt=Math.round(yearsOpen*seededRand(s*69,15,80)+seededRand(s*71,0,100));
    const blogExposure=seededRand(s*73,50,2000);const specCnt=seededRand(s*75,2,5);
    const specs=[];for(let j=0;j<specCnt;j++){const sp=specPool[seededRand(s*77+j*13,0,specPool.length-1)];if(!specs.includes(sp))specs.push(sp)}
    const nightWeekend=seededRand(s*79,0,2);const priceLvl=['저가','중간','고가'][seededRand(s*81,0,2)];
    const threatLvl=chairs>=5&&yearsOpen>=5?'높음':chairs>=3?'보통':'낮음';
    const sameTypeNearby=seededRand(s*83,0,Math.min(4,cnt-1));
    const statusRand=seededRand(s*85,0,20);const status=statusRand>=2?'영업중':statusRand===1?'휴업':'폐업';
    const forSale=status==='폐업'?true:status==='휴업'?seededRand(s*87,0,1)===1:seededRand(s*89,0,8)===0;
    const estAcqPrice=forSale?Math.round(annRev*seededRand(s*91,8,18)/10):null;
    clinics.push({name:pfx[seededRand(s*11,0,pfx.length-1)]+'치과의원',type:types[seededRand(s*13,0,types.length-1)],
      director:dirs[seededRand(s*17,0,dirs.length-1)]+'원장',lat:r.lat+(seededRand(s*3,-70,70))/10000,lng:r.lng+(seededRand(s*7,-70,70))/10000,
      estYear:ey,rating:(seededRand(s*23,32,50)/10).toFixed(1),chairs:chairs,
      hasParking:seededRand(s*31,0,1)===1,floor:seededRand(s*37,1,8)+'층',size:sz+'평',annualRevenue:annRev,
      monthlyRevenue:monthlyRev,dailyPatients:dailyPat,dentistCount:dentistCnt,hygienistCount:hygienistCnt,
      totalStaff:totalStaff,insuranceClaims:insClaims,nonCoverageRatio:nonCovRatio,
      naverRating:naverRating,naverReviewCount:naverReviewCnt,blogExposure:blogExposure,
      specialties:specs,nightWeekend:nightWeekend,priceLevel:priceLvl,yearsOpen:yearsOpen,
      competitionThreat:threatLvl,sameTypeNearby:sameTypeNearby,
      status:status,forSale:forSale,estimatedAcquisitionPrice:estAcqPrice})}
  return clinics;
}
function generateRecommendedSpots(r,clinics){
  const h=hashStr(r.dong+'_rec'),spots=[];
  var active=clinics?clinics.filter(function(c){return c.status==='영업중'}):[];
  if(active.length<2)return spots;
  /* ── Step 1: 클러스터 중심 계산 ── */
  var cLat=0,cLng=0;active.forEach(function(c){cLat+=c.lat;cLng+=c.lng});
  cLat/=active.length;cLng/=active.length;
  /* ── Step 2: 밀집도 × 틈새 점수 계산 ── */
  active.forEach(function(cl){
    var minD=Infinity,cnt300=0;
    active.forEach(function(other){
      if(cl===other)return;
      var d=distM(cl.lat,cl.lng,other.lat,other.lng);
      if(d<minD)minD=d;
      if(d<=300)cnt300++;
    });
    cl._nearDist=minD===Infinity?9999:minD;
    cl._density=cnt300;
    cl._distToCenter=distM(cl.lat,cl.lng,r.lat,r.lng);
    cl._recScore=cl._density*Math.min(cl._nearDist,300);
  });
  var sorted=active.slice().sort(function(a,b){return b._recScore-a._recScore});
  /* ── Step 3: 점수 높은 순 3개 선택 (서로 100m+ 이격) ── */
  var picked=[];
  for(var ci=0;ci<sorted.length&&picked.length<3;ci++){
    var ok=true;
    for(var pi=0;pi<picked.length;pi++){
      if(distM(sorted[ci].lat,sorted[ci].lng,picked[pi].lat,picked[pi].lng)<100){ok=false;break}
    }
    if(ok){picked.push({lat:sorted[ci].lat,lng:sorted[ci].lng,nearDist:sorted[ci]._nearDist,density:sorted[ci]._density,clinicName:sorted[ci].name})}
  }
  /* ── Step 5: 주변 치과 평균으로 사업 지표 기준 산출 ── */
  var avgChairs=0,avgRev=0,avgDaily=0,avgSize=0,acN=active.length||1;
  active.forEach(function(c){avgChairs+=c.chairs;avgRev+=c.annualRevenue;avgDaily+=c.dailyPatients;avgSize+=parseInt(c.size)||30});
  avgChairs=Math.round(avgChairs/acN);avgRev=Math.round(avgRev/acN);avgDaily=Math.round(avgDaily/acN);avgSize=Math.round(avgSize/acN);
  /* ── Step 6: 추천 지점 데이터 + 사업계획 지표 생성 ── */
  var baseReasons=[['유동인구 밀집 구간 (일 '+fmt(Math.round(r.daily_floating*0.4))+'명)','대중교통 도보 5분 이내','20~39세 젊은 인구 밀집'],
    ['신규 아파트 단지 인접 (입주 2년 이내)','소아·교정 수요 높은 지역','임대료 본 지역 대비 15% 저렴'],
    ['주거·상업 복합 지역','직장인 밀집 구역','야간·주말 진료 수요 높음']];
  for(var i=0;i<picked.length;i++){var s=h*50+i,p=picked[i];
    var gapM=Math.round(p.nearDist);
    var rs=['주변 '+p.density+'개 치과 밀집 상권 내 틈새 (가장 가까운 치과 '+gapM+'m)'];
    rs=rs.concat(baseReasons[i]||baseReasons[0]);
    var gapBonus=gapM>200?1.15:gapM>120?1.08:1.0;
    var recChairs=Math.max(3,Math.min(7,avgChairs+seededRand(s*31,-1,1)));
    var recSize=Math.max(20,Math.min(55,Math.round(recChairs*7+seededRand(s*33,-3,5))));
    var rentPy=Math.max(5,r.avg_rent_pyeong+seededRand(s*35,-2,1));
    var monthlyRent=rentPy*recSize;
    var estDailyPat=Math.max(8,Math.round(avgDaily*gapBonus+seededRand(s*37,-3,5)));
    var estAnnRev=Math.round((recChairs*7000+recSize*120+seededRand(s*39,-2000,5000))*gapBonus);
    var estMonthRev=Math.round(estAnnRev/12);
    var recDentist=Math.max(1,Math.round(recChairs/2.5));
    var recHygienist=Math.max(1,Math.round(recChairs*0.8));
    var recStaff=recDentist+recHygienist+Math.max(1,Math.round(recChairs*0.4));
    var initInvest=Math.round(recChairs*4500+recSize*180+seededRand(s*41,2000,8000));
    var monthlyProfit=estMonthRev-monthlyRent-Math.round(recStaff*350+recChairs*120);
    var breakEvenMo=monthlyProfit>0?Math.max(6,Math.min(36,Math.round(initInvest/monthlyProfit))):36;
    spots.push({lat:p.lat,lng:p.lng,
      label:'추천 '+(i+1)+'순위',
      score:Math.min(98,r.scores.total+seededRand(s*7,8,20)-i*4),
      grade:i===0?'S':i===1?'A':'A',reasons:rs,
      nearestClinicM:gapM,surroundingClinics:p.density,
      rent:rentPy,estPop:seededRand(s*11,8000,25000),
      recSize:recSize,recChairs:recChairs,monthlyRent:monthlyRent,
      estDailyPat:estDailyPat,estMonthRev:estMonthRev,estAnnRev:estAnnRev,
      recDentist:recDentist,recHygienist:recHygienist,recStaff:recStaff,
      initInvest:initInvest,monthlyProfit:monthlyProfit,breakEvenMo:breakEvenMo})}
  return spots;
}

/* ═══════════════════════════════════════════════════════════════
   RADAR CHART (SVG)
   ═══════════════════════════════════════════════════════════════ */
function drawRadarChart(scores){
  var sz=220,cx=sz/2,cy=sz/2,rad=80;
  var labels=['인구/수요','경쟁','비용','접근성','성장성'];
  var vals=[scores.population,scores.competition,scores.cost,scores.access,scores.growth];
  var angs=[-90,-18,54,126,198].map(function(a){return a*Math.PI/180});
  var svg='<svg viewBox="0 0 '+sz+' '+sz+'" class="w-full max-w-[240px] mx-auto">';
  [20,40,60,80,100].forEach(function(lv){var rr=rad*lv/100;var pts=angs.map(function(a){return(cx+rr*Math.cos(a))+','+(cy+rr*Math.sin(a))}).join(' ');svg+='<polygon points="'+pts+'" fill="none" stroke="#e5e7eb" stroke-width="0.5"/>';if(lv===60)svg+='<polygon points="'+pts+'" fill="none" stroke="#d1d5db" stroke-width="0.5" stroke-dasharray="3,3"/>'});
  angs.forEach(function(a){svg+='<line x1="'+cx+'" y1="'+cy+'" x2="'+(cx+rad*Math.cos(a))+'" y2="'+(cy+rad*Math.sin(a))+'" stroke="#e5e7eb" stroke-width="0.5"/>'});
  var dataPts=vals.map(function(v,i){var rr=rad*v/100;return(cx+rr*Math.cos(angs[i]))+','+(cy+rr*Math.sin(angs[i]))}).join(' ');
  svg+='<polygon points="'+dataPts+'" fill="rgba(59,130,246,0.12)" stroke="#3b82f6" stroke-width="2"/>';
  vals.forEach(function(v,i){var rr=rad*v/100;svg+='<circle cx="'+(cx+rr*Math.cos(angs[i]))+'" cy="'+(cy+rr*Math.sin(angs[i]))+'" r="4" fill="#3b82f6" stroke="white" stroke-width="1.5"/>'});
  vals.forEach(function(v,i){var lr=rad+28;var lx=cx+lr*Math.cos(angs[i]);var ly=cy+lr*Math.sin(angs[i]);
    svg+='<text x="'+lx+'" y="'+(ly-5)+'" text-anchor="middle" font-size="10" fill="#6b7280" font-weight="600">'+labels[i]+'</text>';
    svg+='<text x="'+lx+'" y="'+(ly+9)+'" text-anchor="middle" font-size="13" fill="'+(v>=80?'#2563eb':v>=60?'#16a34a':v>=40?'#ca8a04':'#dc2626')+'" font-weight="700">'+v+'</text>'});
  svg+='</svg>';return svg;
}

/* ═══════════════════════════════════════════════════════════════
   MAP RENDERING
   ═══════════════════════════════════════════════════════════════ */
var reportMap=null;
function nightWeekendLabel(nw){return nw===2?'야간+주말':nw===1?'주말진료':'평일만'}
function buildClinicPopup(c){
  return '<div style="min-width:240px;max-width:280px;font-family:Pretendard Variable,sans-serif;font-size:12px">'
    +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><b style="font-size:13px;color:#1d4ed8">'+c.name+'</b><span style="background:'+(c.status==='영업중'?'#dcfce7;color:#166534':c.status==='휴업'?'#fef9c3;color:#854d0e':'#fee2e2;color:#991b1b')+';padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600">'+c.status+'</span></div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px"><span style="background:#fee2e2;color:#dc2626;padding:1px 5px;border-radius:3px;font-size:10px">'+c.type+'</span><span style="background:#e0f2fe;color:#0369a1;padding:1px 5px;border-radius:3px;font-size:10px">'+c.priceLevel+'</span></div>'
    +'<div style="color:#4b5563;font-size:11px">'
    +'<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #f3f4f6"><span>원장</span><b>'+c.director+'</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #f3f4f6"><span>개원</span><b>'+c.estYear+'년 ('+c.yearsOpen+'년차)</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #f3f4f6"><span>규모</span><b>체어 '+c.chairs+'대 · '+c.size+'</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #f3f4f6"><span>일환자</span><b>'+c.dailyPatients+'명</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #f3f4f6"><span>평점</span><b style="color:#f59e0b">★ '+c.naverRating+'</b></div>'
    +'</div>'
    +'<div style="margin-top:5px;padding-top:5px;border-top:1px solid #e5e7eb;background:#ecfdf5;margin:5px -8px -8px;padding:6px 8px;border-radius:0 0 4px 4px">'
    +'<div style="display:flex;justify-content:space-between;color:#059669;font-weight:600;font-size:11px"><span>연매출</span><b>약 '+fmtRevKr(c.annualRevenue)+'원</b></div>'
    +(c.forSale?'<div style="display:flex;justify-content:space-between;color:#7c3aed;font-weight:600;font-size:11px;margin-top:2px"><span>인수가</span><b>약 '+fmtRevKr(c.estimatedAcquisitionPrice)+'원</b></div>':'')
    +'</div></div>';
}
function renderReportMap(r,clinics,spots){
  if(reportMap){reportMap.remove();reportMap=null}
  var el=document.getElementById('report-map');if(!el||typeof L==='undefined')return;
  reportMap=L.map('report-map',{scrollWheelZoom:true,zoomControl:true}).setView([r.lat,r.lng],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:18}).addTo(reportMap);
  /* legend — topright, visible by default */
  var legend=L.control({position:'topright'});
  legend.onAdd=function(){var d=L.DomUtil.create('div','map-legend');L.DomEvent.disableClickPropagation(d);L.DomEvent.disableScrollPropagation(d);
    var lh='<h4 onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>범례</span><span class="leg-arrow">▼</span></h4><div class="leg-body">';
    lh+='<div class="leg-section"><div class="leg-title">마커</div>';
    lh+='<div class="leg-row"><div class="leg-dot" style="background:#3b82f6"></div>분석 중심</div>';
    lh+='<div class="leg-row"><div class="leg-dot" style="background:#ef4444"></div>영업중 치과</div>';
    lh+='<div class="leg-row"><div class="leg-dot" style="background:#eab308"></div>휴업 치과</div>';
    lh+='<div class="leg-row"><div class="leg-dot" style="background:#9ca3af"></div>폐업 치과</div>';
    lh+='<div class="leg-row"><div class="leg-dot" style="background:linear-gradient(135deg,#f59e0b,#d97706)"></div>추천 개원 위치</div>';
    lh+='</div></div>';
    d.innerHTML=lh;return d};legend.addTo(reportMap);
  /* center — 드래그 가능 마커 */
  var centerMarker=L.marker([r.lat,r.lng],{draggable:false,icon:L.divIcon({className:'',html:'<div style="background:#3b82f6;color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;border:3px solid white;box-shadow:0 2px 10px rgba(59,130,246,0.5)">📍</div>',iconSize:[40,40],iconAnchor:[20,20]})}).addTo(reportMap)
    .bindPopup('<div style="min-width:160px;font-family:Pretendard Variable,sans-serif"><b style="font-size:15px">'+r.dong+'</b>'+(r.sido?' <span style="color:#9ca3af;font-size:11px">('+r.sido+(r.sigungu&&r.sigungu!==r.dong?' '+r.sigungu:'')+')</span>':'')+'<br><span style="color:#6b7280;font-size:12px">분석 중심 지역</span><br><span style="color:#3b82f6;font-weight:bold;font-size:18px">종합 '+r.scores.total+'점</span> <span style="font-size:12px;color:#6b7280">'+r.grade+'등급</span></div>');
  /* 시작점 이동 버튼 */
  var _moveMode=false;
  var moveWrap=L.DomUtil.create('div','',el);
  moveWrap.style.cssText='position:absolute;left:10px;top:50%;transform:translateY(-50%);z-index:1000;display:flex;flex-direction:column;gap:6px';
  moveWrap.innerHTML='<button id="btn-move-start" style="background:white;border:2px solid #166534;border-radius:10px;padding:8px 20px;font-size:15px;font-weight:700;color:#166534;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.18);display:flex;align-items:center;gap:6px"><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#3b82f6;font-size:13px;border:2px solid white;box-shadow:0 1px 4px rgba(59,130,246,0.4)">📍</span> 시작점 이동</button>'
    +'<button id="btn-reanalyze" style="display:none;background:#166534;border:2px solid #14532d;border-radius:10px;padding:8px 20px;font-size:15px;font-weight:700;color:white;cursor:pointer;box-shadow:0 2px 8px rgba(22,101,52,0.4)">🔄 이 위치에서 재분석</button>';
  L.DomEvent.disableClickPropagation(moveWrap);
  document.getElementById('btn-move-start').addEventListener('click',function(){
    _moveMode=!_moveMode;
    centerMarker.dragging[_moveMode?'enable':'disable']();
    this.style.background=_moveMode?'#fef3c7':'white';
    this.style.borderColor=_moveMode?'#f59e0b':'#166534';
    this.style.color=_moveMode?'#92400e':'#166534';
    this.innerHTML=_moveMode?'📌 마커를 드래그하세요':'<span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#3b82f6;font-size:13px;border:2px solid white;box-shadow:0 1px 4px rgba(59,130,246,0.4)">📍</span> 시작점 이동';
    if(!_moveMode)document.getElementById('btn-reanalyze').style.display='none';
  });
  centerMarker.on('dragend',function(){document.getElementById('btn-reanalyze').style.display='block'});
  document.getElementById('btn-reanalyze').addEventListener('click',async function(){
    var pos=centerMarker.getLatLng();
    this.innerHTML='⏳ 분석 중...';this.disabled=true;
    var newName=r.dong;
    if(typeof kakao!=='undefined'&&kakao.maps){
      try{await new Promise(function(res){kakao.maps.load(function(){
        var gc=new kakao.maps.services.Geocoder();
        gc.coord2RegionCode(pos.lng,pos.lat,function(result,status){
          if(status===kakao.maps.services.Status.OK&&result[0]){newName=result[0].region_3depth_name||result[0].region_2depth_name||newName}
          res();
        });
      })})}catch(e){}
    }
    var nr=Object.assign({},r,{lat:pos.lat,lng:pos.lng,dong:newName+' (이동)',_kakaoGeo:true});
    await renderReport(nr);
  });
  /* clinics */
  clinics.forEach(function(c){L.marker([c.lat,c.lng],{icon:L.divIcon({className:'',html:'<div style="background:'+(c.status==='영업중'?'#ef4444':c.status==='휴업'?'#eab308':'#9ca3af')+';color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer">🦷</div>',iconSize:[30,30],iconAnchor:[15,15]})}).addTo(reportMap).bindPopup(buildClinicPopup(c),{maxWidth:300})});
  /* recommended — 반경 50m 추천 구역 원으로 표시 */
  var spotColors=['#f59e0b','#8b5cf6','#10b981'];
  spots.forEach(function(s,si){
    var clr=spotColors[si]||spotColors[0];
    var rank=si+1;
    L.circle([s.lat,s.lng],{radius:50,color:clr,weight:2.5,opacity:0.85,fillColor:clr,fillOpacity:0.15,dashArray:'6 4'}).addTo(reportMap);
    L.marker([s.lat,s.lng],{icon:L.divIcon({className:'',html:'<div style="background:'+clr+';color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap;border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);text-align:center;line-height:1.3">⭐ '+rank+'순위<br><span style="font-size:9px;opacity:0.9">반경 50m</span></div>',iconSize:[0,0],iconAnchor:[40,15]})}).addTo(reportMap)
    .bindPopup('<div style="min-width:260px;max-width:340px;font-family:Pretendard Variable,sans-serif"><div style="background:#fef3c7;color:#92400e;padding:3px 10px;border-radius:6px;display:inline-block;font-size:11px;font-weight:bold">🏆 덴탈맵 추천</div><div style="font-size:15px;font-weight:bold;margin-top:6px">'+s.label+'</div><div style="display:flex;align-items:baseline;gap:6px;margin:4px 0"><span style="font-size:28px;font-weight:bold;color:#3b82f6">'+s.score+'점</span><span style="font-size:12px;background:#dbeafe;color:#2563eb;padding:1px 6px;border-radius:4px;font-weight:bold">'+s.grade+'등급</span></div>'
    +'<div style="font-size:12px;color:#4b5563;border-top:1px solid #e5e7eb;padding-top:6px;margin-top:2px">'+s.reasons.map(function(x){return'<div style="padding:2px 0">✅ '+x+'</div>'}).join('')+'</div>'
    +'<div style="margin-top:8px;padding:8px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0">'
    +'<div style="font-size:11px;font-weight:700;color:#166534;margin-bottom:4px">추천 개원 규모</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 8px;font-size:11px;color:#374151">'
    +'<span>면적 <b>'+s.recSize+'평</b></span><span>체어 <b>'+s.recChairs+'대</b></span>'
    +'<span>의사 <b>'+s.recDentist+'명</b></span><span>위생사 <b>'+s.recHygienist+'명</b></span>'
    +'<span>직원(총) <b>'+s.recStaff+'명</b></span><span>월임대 <b>'+fmt(s.monthlyRent)+'만</b></span></div></div>'
    +'<div style="margin-top:6px;padding:8px;background:#eff6ff;border-radius:6px;border:1px solid #bfdbfe">'
    +'<div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:4px">예상 수익</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 8px;font-size:11px;color:#374151">'
    +'<span>일환자 <b>'+s.estDailyPat+'명</b></span><span>월매출 <b>'+fmtRevKr(s.estMonthRev)+'</b></span>'
    +'<span>연매출 <b>'+fmtRevKr(s.estAnnRev)+'</b></span><span>월순이익 <b>'+fmtRevKr(s.monthlyProfit)+'</b></span>'
    +'<span>초기투자 <b>약 '+fmtRevKr(s.initInvest)+'</b></span><span>손익분기 <b>약 '+s.breakEvenMo+'개월</b></span></div></div></div>',{maxWidth:360});
  });
  /* fit bounds */
  var pts=[[r.lat,r.lng]].concat(clinics.map(function(c){return[c.lat,c.lng]})).concat(spots.map(function(s){return[s.lat,s.lng]}));
  if(pts.length>1)reportMap.fitBounds(pts,{padding:[40,40]});
}

/* ═══════════════════════════════════════════════════════════════
   RENDER PREMIUM REPORT
   ═══════════════════════════════════════════════════════════════ */
async function renderReport(r){
  var tx=genTexts(r);
  var ts=r.scores.total,sl=ts>=80?'매우 유망':ts>=70?'추천':ts>=60?'조건부 추천':'주의 필요';
  var verdictIcon=ts>=80?'🟢':ts>=70?'🔵':ts>=60?'🟡':'🔴';
  /* 실제 치과 데이터 우선, 실패 시 mock 폴백 */
  var clinics=await fetchRealClinics(r.lat,r.lng,1000);
  if(!clinics)clinics=generateNearbyClinics(r);
  var spots=generateRecommendedSpots(r,clinics);
  var loc=r.sido?r.sido+' '+r.sigungu+' ':'';
  var fullLoc=(function(){var parts=[];if(r.sido)parts.push(r.sido);if(r.sigungu&&r.sigungu!==r.dong)parts.push(r.sigungu);parts.push(r.dong);return parts.join(' ')})();
  var reportId='DM-'+r.dong_code.slice(0,4)+'-'+new Date().getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
  var dateStr=new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});

  /* Investment calc */
  var ti=r.avg_rent_pyeong*r.area_pyeong*10+r.area_pyeong*200+12000+3000;
  var mr=r.avg_rent_pyeong*r.area_pyeong;
  var dp=Math.round(r.population/Math.max(r.dental_count,1)/120),mRev=dp*15*25;
  var mCost=mr+Math.round(r.area_pyeong*5)+800+Math.round(mRev*0.15)+300;
  var mP=mRev-mCost,be=mP>0?Math.ceil(ti/mP):999;

  /* Risk & Opportunity */
  var risks=[],opps=[];
  if(r.scores.competition<60)risks.push({t:'경쟁 과열',d:'반경 500m 내 치과 '+r.dental_count+'개 — 경쟁이 치열한 지역입니다',sev:'high'});
  if(r.scores.cost<60)risks.push({t:'높은 임대료',d:'평당 '+r.avg_rent_pyeong+'만원으로 월 고정비 부담이 큽니다',sev:'high'});
  if(r.pop_growth_rate<1)risks.push({t:'인구 정체',d:'인구 증가율 '+r.pop_growth_rate+'%로 성장이 둔화되고 있습니다',sev:'medium'});
  if(r.age_60_plus_pct>30)risks.push({t:'고령 인구 비중',d:'60세 이상 '+r.age_60_plus_pct+'%로 진료 단가가 낮을 수 있습니다',sev:'low'});
  if(risks.length===0)risks.push({t:'전반적 리스크 낮음',d:'주요 위험 요인이 발견되지 않았습니다',sev:'low'});
  if(r.scores.population>=70)opps.push({t:'풍부한 수요',d:'인구 '+fmt(r.population)+'명으로 안정적 환자 확보 가능'});
  if(r.pop_growth_rate>=3)opps.push({t:'급성장 지역',d:'인구 +'+r.pop_growth_rate+'% 증가로 신규 수요 지속 창출'});
  if(r.age_20_39_pct>=35)opps.push({t:'젊은 인구 밀집',d:'20~39세 '+r.age_20_39_pct+'%로 심미·교정 고단가 진료 수요'});
  if(r.scores.access>=80)opps.push({t:'우수한 접근성',d:r.subway_station+' 도보 '+r.subway_walk_min+'분, 유동인구 '+fmt(r.daily_floating)+'명'});
  if(opps.length===0)opps.push({t:'특별한 기회 요인 없음',d:'차별화 전략이 중요합니다'});

  /* Active clinics for competition section */
  var activeClinics=clinics.filter(function(c){return c.status==='영업중'}).sort(function(a,b){return b.annualRevenue-a.annualRevenue}).slice(0,5);

  var h='<div class="max-w-4xl mx-auto px-6 py-8">';

  /* ── 00 COVER ── */
  h+='<div class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 rounded-3xl p-8 md:p-12 text-white mb-8 fade-in relative overflow-hidden font-bold">';
  h+='<div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>';
  h+='<div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-400/10 rounded-full translate-y-1/2 -translate-x-1/2"></div>';
  h+='<div class="relative">';
  h+='<div class="flex items-center justify-between mb-8"><div class="flex items-center gap-3"><div class="w-9 h-9 bg-blue-500 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-sm">D</span></div><span class="font-bold text-white text-lg">덴탈맵AI <span class="text-base font-semibold text-yellow-300">치과개원 입지분석</span></span></div><div class="text-right"><p class="text-yellow-300 text-xs">'+dateStr+'</p><span class="inline-block mt-1 text-[10px] bg-white/10 text-yellow-200 px-2 py-0.5 rounded-full">CONFIDENTIAL</span></div></div>';
  var regionCtx=r.sido?(r.sigungu&&r.sigungu!==r.dong?' ('+r.sido+' '+r.sigungu+')':' ('+r.sido+')'):'';
  h+='<h1 class="text-3xl md:text-4xl font-bold leading-tight">'+r.dong+'<span class="text-lg font-normal text-white/60">'+regionCtx+'</span><br><span class="text-yellow-300 text-xl md:text-2xl font-medium">치과 개원 AI 입지분석 및 추천 리포트</span></h1>';
  h+='<p class="mt-3 text-yellow-200/80 text-sm">'+fullLoc+' 지역의 인구, 경쟁, 비용, 접근성, 성장성을 종합 분석한 AI 의사결정 보고서</p>';
  /* ── 의뢰자 정보 ── */
  var _cp=new URLSearchParams(window.location.search);
  var cName=_cp.get('cname')||'',cPhone=_cp.get('cphone')||'',cEmail=_cp.get('cemail')||'',cInfo=_cp.get('cinfo')||'';
  h+='<div class="mt-5 bg-white/10 backdrop-blur rounded-xl p-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">';
  h+='<div><p class="text-yellow-300/70 text-[10px] mb-0.5">의뢰자명</p><p class="text-white font-medium min-h-[20px]">'+(cName||'&nbsp;')+'</p></div>';
  h+='<div><p class="text-yellow-300/70 text-[10px] mb-0.5">휴대폰 번호</p><p class="text-white font-medium min-h-[20px]">'+(cPhone||'&nbsp;')+'</p></div>';
  h+='<div><p class="text-yellow-300/70 text-[10px] mb-0.5">이메일 주소</p><p class="text-white font-medium min-h-[20px]">'+(cEmail||'&nbsp;')+'</p></div>';
  h+='<div><p class="text-yellow-300/70 text-[10px] mb-0.5">의뢰자 정보</p><p class="text-white font-medium min-h-[20px]">'+(cInfo||'&nbsp;')+'</p></div>';
  h+='</div>';
  h+='<div class="mt-8 flex flex-wrap items-center gap-4"><div class="bg-white/10 backdrop-blur rounded-2xl px-6 py-4 text-center"><p class="text-4xl font-bold">'+ts+'</p><p class="text-yellow-300 text-xs mt-1">종합 점수</p></div><div class="bg-white/10 backdrop-blur rounded-2xl px-6 py-4 text-center"><p class="text-3xl font-bold '+({A:'text-blue-400',B:'text-green-400',C:'text-yellow-400',D:'text-orange-400'}[r.grade]||'text-red-400')+'">'+r.grade+'</p><p class="text-yellow-300 text-xs mt-1">등급</p></div><div class="bg-white/10 backdrop-blur rounded-2xl px-6 py-4 text-center"><p class="text-lg font-bold">'+verdictIcon+' '+sl+'</p><p class="text-yellow-300 text-xs mt-1">판정</p></div></div>';
  h+='<div class="mt-5 bg-white/5 backdrop-blur rounded-xl p-4 text-[10px] space-y-2.5">';
  h+='<div class="flex flex-wrap items-center gap-3"><span class="text-yellow-300/70 w-16 shrink-0">종합 점수:</span><span class="text-yellow-100">인구/수요(25%) + 경쟁 환경(25%) + 비용 효율(20%) + 접근성(15%) + 성장성(15%)의 가중 평균 (0~100점)</span></div>';
  h+='<div class="flex flex-wrap items-center gap-3"><span class="text-yellow-300/70 w-16 shrink-0">등급:</span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(r.grade==='A'?' ring-1 ring-white/40':'')+'"><span class="text-blue-400 font-bold">A</span> <span class="text-yellow-300/70">80+</span></span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(r.grade==='B'?' ring-1 ring-white/40':'')+'"><span class="text-green-400 font-bold">B</span> <span class="text-yellow-300/70">70-79</span></span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(r.grade==='C'?' ring-1 ring-white/40':'')+'"><span class="text-yellow-400 font-bold">C</span> <span class="text-yellow-300/70">60-69</span></span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(r.grade==='D'?' ring-1 ring-white/40':'')+'"><span class="text-orange-400 font-bold">D</span> <span class="text-yellow-300/70">60 미만</span></span></div>';
  h+='<div class="flex flex-wrap items-center gap-3"><span class="text-yellow-300/70 w-16 shrink-0">판정:</span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(ts>=80?' ring-1 ring-white/40':'')+'">🟢 매우 유망 <span class="text-yellow-300/70">80+</span></span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(ts>=70&&ts<80?' ring-1 ring-white/40':'')+'">🔵 추천 <span class="text-yellow-300/70">70-79</span></span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(ts>=60&&ts<70?' ring-1 ring-white/40':'')+'">🟡 조건부 추천 <span class="text-yellow-300/70">60-69</span></span><span class="inline-flex items-center gap-1 bg-white/10 rounded-full px-2.5 py-1'+(ts<60?' ring-1 ring-white/40':'')+'">🔴 주의 필요 <span class="text-yellow-300/70">60 미만</span></span></div>';
  h+='</div>';
  h+='</div></div>';

  /* ── 01 EXECUTIVE SUMMARY (~300 words) ── */
  var popLabel=r.scores.population>=80?'매우 풍부한':r.scores.population>=60?'양호한':'다소 부족한';
  var compLabel=r.scores.competition>=70?'낮은 경쟁 밀도로 유리한':r.scores.competition>=50?'평균적인 경쟁 수준의':'높은 경쟁 밀도로 치열한';
  var costLabel=r.scores.cost>=70?'합리적인 비용 구조를 갖춘':r.scores.cost>=50?'평균적인 비용 부담의':'높은 고정비가 예상되는';
  var accessLabel=r.scores.access>=80?'매우 우수한':r.scores.access>=60?'양호한':'개선이 필요한';
  var growthLabel=r.pop_growth_rate>=3?'빠르게 성장하는':r.pop_growth_rate>=1?'안정적인 성장세의':'성장이 정체된';

  var execSummary='';
  /* Para 1: 종합 판정 */
  execSummary+='<b class="text-base">종합 판정: '+sl+' ('+ts+'점, '+r.grade+'등급)</b><br><br>';
  execSummary+=fullLoc+' 지역에 대한 치과 개원 입지 적합성을 인구/수요, 경쟁 환경, 비용 효율, 접근성, 성장성의 5개 핵심 축을 기반으로 종합 분석한 결과, ';
  execSummary+=ts>=80?'해당 지역은 <b>치과 개원에 매우 유망한 입지</b>로 평가됩니다. ':'';
  execSummary+=ts>=70&&ts<80?'해당 지역은 <b>개원에 적합한 입지</b>로 평가됩니다. ':'';
  execSummary+=ts>=60&&ts<70?'해당 지역은 <b>조건부로 개원이 가능한 입지</b>로 평가됩니다. ':'';
  execSummary+=ts<60?'해당 지역은 <b>개원에 신중한 접근이 필요한 입지</b>로 평가됩니다. ':'';
  execSummary+='5축 분석 결과, 인구/수요 '+r.scores.population+'점, 경쟁 환경 '+r.scores.competition+'점, 비용 효율 '+r.scores.cost+'점, 접근성 '+r.scores.access+'점, 성장성 '+r.scores.growth+'점으로 산출되었습니다.';

  /* Para 2: 인구·수요·경쟁 */
  execSummary+='<br><br><b>인구 및 경쟁 분석.</b> 반경 1km 내 거주인구 '+fmt(r.population)+'명, 일 유동인구 '+fmt(r.daily_floating)+'명으로 '+popLabel+' 수요 기반을 보유하고 있습니다. ';
  execSummary+='특히 20~39세 핵심 타겟 인구 비중이 '+r.age_20_39_pct+'%로, '+(r.age_20_39_pct>=35?'심미·교정 등 고단가 진료 수요가 높을 것으로 전망됩니다. ':'평균 수준의 심미·교정 수요가 예상됩니다. ');
  execSummary+='반경 500m 내 기존 치과 '+r.dental_count+'개가 운영 중이며, 인구당 치과 비율은 1:'+fmt(r.pop_per_clinic)+'으로 '+compLabel+' 환경입니다. ';
  execSummary+='인구 증가율 '+(r.pop_growth_rate>0?'+':'')+r.pop_growth_rate+'%로 '+growthLabel+' 지역이며, 상권 등급은 '+r.commercial_grade+'등급입니다.';

  /* Para 3: 비용·접근성 */
  execSummary+='<br><br><b>비용 및 접근성.</b> 평당 임대료 '+r.avg_rent_pyeong+'만원('+r.area_pyeong+'평 기준 월 '+fmt(mr)+'만원)으로 '+costLabel+' 지역입니다. ';
  execSummary+='최근접 역 '+r.subway_station+'('+r.subway_line+') 도보 '+r.subway_walk_min+'분, 반경 500m 내 버스정류장 '+r.bus_stops_500m+'개로 '+accessLabel+' 대중교통 접근성을 갖추고 있습니다.';

  /* Para 4: 투자·수익 */
  execSummary+='<br><br><b>투자 및 수익 전망.</b> 보증금, 인테리어, 의료장비, 운영자금을 포함한 초기 투자금은 약 <b>'+(ti/10000).toFixed(1)+'억원</b>으로 추산됩니다. ';
  execSummary+='일 예상 환자 수 '+dp+'명, 객단가 15만원 기준 <b>월 매출 '+fmt(mRev)+'만원</b>, 임대료·인건비·재료비 등 고정비 차감 후 <b>월 순이익 '+(mP>0?'+':'')+fmt(mP)+'만원</b>이 기대됩니다. ';
  execSummary+=mP>0?'기본 시나리오 기준 <b>'+be+'개월 내 손익분기 달성</b>이 전망되며, 보수적 시나리오에서도 약 '+Math.round(be*1.4)+'개월 내 회수가 가능할 것으로 분석됩니다.':'현 조건에서는 손익분기 달성에 상당한 기간이 소요될 수 있으므로, 비용 절감 또는 매출 극대화 전략이 필요합니다.';

  /* Para 5: 결론 */
  execSummary+='<br><br><b>결론.</b> ';
  execSummary+=ts>=80?'종합적으로 '+r.dong+' 지역은 수요, 경쟁, 비용, 접근성, 성장성 등 모든 측면에서 우수한 조건을 갖추고 있어 <b>적극적인 개원을 권장</b>합니다. AI가 추천하는 최적 개원 위치를 중심으로 임대 물건 탐색과 현장 실사를 진행하시기 바랍니다.':'';
  execSummary+=ts>=70&&ts<80?'종합적으로 '+r.dong+' 지역은 양호한 입지 조건을 갖추고 있으며, 경쟁 현황을 고려한 <b>차별화 진료 전략과 함께 개원을 추천</b>합니다. 아래 상세 분석과 추천 위치를 참고하여 의사결정에 활용하시기 바랍니다.':'';
  execSummary+=ts>=60&&ts<70?'종합적으로 '+r.dong+' 지역은 일부 리스크 요인이 존재하나, 적절한 전략 수립 시 수익 창출이 가능합니다. <b>전문가 상담과 현장 실사를 병행</b>하여 최종 결정하시기를 권장합니다.':'';
  execSummary+=ts<60?'종합적으로 '+r.dong+' 지역은 다수의 리스크 요인이 확인되었습니다. <b>개원 전 반드시 전문가 상담과 심층 시장 조사</b>를 실시하고, 대안 입지와의 비교 분석을 통해 최종 결정하시기를 강력히 권장합니다.':'';

  h+='<section class="bg-white rounded-2xl border-2 border-blue-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-1">';
  h+='<div class="flex items-center gap-3 mb-4"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">01</span><h2 class="text-lg font-bold">Executive Summary</h2><span class="text-xs text-gray-400 ml-auto">'+fullLoc+' · '+dateStr+'</span></div>';
  h+='<div class="bg-gradient-to-r '+(ts>=70?'from-blue-50 to-cyan-50 border-blue-200':'from-yellow-50 to-orange-50 border-yellow-200')+' border rounded-xl p-6">';
  h+='<div class="flex items-start gap-4"><span class="text-4xl shrink-0 mt-1">'+verdictIcon+'</span><div class="text-sm leading-[1.8] text-gray-700">'+execSummary+'</div></div></div></section>';

  /* ── 02 RADAR CHART + SCORES ── */
  h+='<section class="bg-white rounded-2xl border-2 border-indigo-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-2">';
  h+='<div class="flex items-center gap-3 mb-6"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">02</span><h2 class="text-lg font-bold">종합 분석 점수</h2></div>';
  h+='<div class="grid md:grid-cols-2 gap-8 items-center"><div class="text-center">'+drawRadarChart(r.scores)+'</div>';
  h+='<div><div class="text-center mb-4"><p class="text-6xl font-bold '+getScoreColor(ts)+'">'+ts+'</p><p class="text-sm text-gray-500 mt-1"><span class="inline-block px-3 py-1 rounded-full text-sm font-bold '+getGradeColor(r.grade)+'">'+r.grade+'등급</span> · '+sl+'</p></div>';
  h+='<div class="space-y-3 mt-6">';
  [{l:'인구/수요',s:r.scores.population,i:'👥'},{l:'경쟁 환경',s:r.scores.competition,i:'🏥'},{l:'비용 효율',s:r.scores.cost,i:'💰'},{l:'접근성',s:r.scores.access,i:'🚇'},{l:'성장성',s:r.scores.growth,i:'📈'}].forEach(function(a){
    h+='<div class="flex items-center gap-3"><span class="text-lg w-6">'+a.i+'</span><span class="text-sm text-gray-600 w-16">'+a.l+'</span><div class="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all '+getScoreBarColor(a.s)+'" style="width:'+a.s+'%"></div></div><span class="text-sm font-bold w-10 text-right '+getScoreColor(a.s)+'">'+a.s+'</span></div>';
  });
  h+='</div></div></div></section>';

  /* ── 03 MAP ── */
  h+='<section class="bg-white rounded-2xl border-2 border-teal-300 shadow-sm mb-6 overflow-hidden fade-in fade-in-3">';
  h+='<div class="p-6 md:p-8 pb-4"><div class="flex items-center gap-3 mb-2"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">03</span><h2 class="text-lg font-bold">입지 분석 지도</h2></div>';
  h+='<p class="text-sm text-gray-500 mb-4">분석 지역 중심 반경 1km 내 치과 '+clinics.length+'개, AI 추천 개원 위치 '+spots.length+'곳</p></div>';
  h+='<div id="report-map" style="height:70vh;z-index:0"></div>';
  h+='<div class="px-6 py-3 text-[11px] text-gray-400 border-t border-gray-100 bg-gray-50">마커를 클릭하면 상세 정보를 확인할 수 있습니다 · 우측 상단 범례 참조 · 추천 위치는 반경 50m 원으로 표시</div></section>';

  /* ── 04 RECOMMENDED SPOTS (3 ranked cards) ── */
  var spotBorders=['border-amber-300','border-violet-300','border-emerald-300'];
  var spotBgs=['from-amber-50 to-orange-50','from-violet-50 to-purple-50','from-emerald-50 to-teal-50'];
  var spotBadgeBg=['bg-amber-200 text-amber-800','bg-violet-200 text-violet-800','bg-emerald-200 text-emerald-800'];
  h+='<section class="mb-6 fade-in fade-in-4"><div class="grid md:grid-cols-3 gap-4">';
  spots.forEach(function(s,si){
    var rank=si+1;
    h+='<div class="bg-gradient-to-br '+spotBgs[si]+' border-2 '+spotBorders[si]+' rounded-2xl p-6">';
    h+='<div class="flex items-center gap-2 mb-3"><span class="text-lg">⭐</span><span class="text-xs font-bold '+spotBadgeBg[si]+' px-2.5 py-0.5 rounded-full">'+rank+'순위 추천</span><span class="text-xs font-bold text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full ml-auto">'+s.grade+'등급</span></div>';
    h+='<h3 class="font-bold text-base">'+s.label+'</h3>';
    h+='<p class="text-3xl font-bold text-blue-600 mt-1">'+s.score+'<span class="text-sm text-gray-400 font-medium">점</span></p>';
    h+='<ul class="mt-3 space-y-1.5">'+s.reasons.map(function(x){return '<li class="text-sm text-gray-700 flex items-start gap-1.5"><span class="text-green-500 mt-0.5 shrink-0">✓</span>'+x+'</li>'}).join('')+'</ul>';
    /* 추천 개원 규모 */
    h+='<div class="mt-3 pt-3 border-t border-amber-200">';
    h+='<p class="text-xs font-bold text-emerald-800 mb-2">추천 개원 규모</p>';
    h+='<div class="grid grid-cols-3 gap-x-3 gap-y-1 text-[11px]">';
    h+='<span class="text-gray-500">면적 <b class="text-gray-700">'+s.recSize+'평</b></span>';
    h+='<span class="text-gray-500">체어 <b class="text-gray-700">'+s.recChairs+'대</b></span>';
    h+='<span class="text-gray-500">월임대 <b class="text-gray-700">'+fmt(s.monthlyRent)+'만</b></span>';
    h+='</div></div>';
    /* 예상 수익 */
    h+='<div class="mt-2.5 pt-2.5 border-t border-amber-200">';
    h+='<p class="text-xs font-bold text-blue-800 mb-2">예상 수익</p>';
    h+='<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px]">';
    h+='<span class="text-gray-500">일환자 <b class="text-emerald-700">'+s.estDailyPat+'명</b></span>';
    h+='<span class="text-gray-500">월매출 <b class="text-emerald-700">'+fmtRevKr(s.estMonthRev)+'</b></span>';
    h+='<span class="text-gray-500">연매출 <b class="text-emerald-700">'+fmtRevKr(s.estAnnRev)+'</b></span>';
    h+='<span class="text-gray-500">월순이익 <b class="text-emerald-700">'+fmtRevKr(s.monthlyProfit)+'</b></span>';
    h+='</div></div>';
    /* 투자·손익분기 */
    h+='<div class="mt-2.5 pt-2.5 border-t border-amber-200 flex items-center justify-between text-[11px]">';
    h+='<span class="text-gray-500">초기투자 <b class="text-violet-700">약 '+fmtRevKr(s.initInvest)+'</b></span>';
    h+='<span class="text-gray-500">손익분기 <b class="text-violet-700">약 '+s.breakEvenMo+'개월</b></span>';
    h+='</div>';
    h+='</div>';
  });
  if(spots.length===0){h+='<div class="col-span-3 text-center text-gray-400 py-8">추천 위치를 계산할 수 없습니다 (주변 치과 데이터 부족)</div>'}
  h+='</div></section>';

  /* ── 05 5-AXIS DETAIL ── */
  h+='<section class="bg-white rounded-2xl border-2 border-violet-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-5">';
  h+='<div class="flex items-center gap-3 mb-6"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">04</span><h2 class="text-lg font-bold">5축 상세 분석</h2></div>';
  h+='<div class="space-y-4">';
  [{i:'👥',l:'인구/수요',s:r.scores.population,t:tx.popText},{i:'🏥',l:'경쟁 환경',s:r.scores.competition,t:tx.compText},{i:'💰',l:'비용 효율',s:r.scores.cost,t:tx.costText},{i:'🚇',l:'접근성',s:r.scores.access,t:tx.accessText},{i:'📈',l:'성장성',s:r.scores.growth,t:tx.growthText}].forEach(function(a){
    h+='<div class="bg-gray-50 rounded-xl p-5"><div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><span class="text-xl">'+a.i+'</span><h3 class="font-bold text-sm">'+a.l+'</h3></div><span class="text-lg font-bold '+getScoreColor(a.s)+'">'+a.s+'점</span></div>';
    h+='<div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-3"><div class="h-full rounded-full '+getScoreBarColor(a.s)+'" style="width:'+a.s+'%"></div></div>';
    h+='<p class="text-sm text-gray-600 leading-relaxed">'+a.t+'</p></div>';
  });
  h+='</div></section>';

  /* ── 06 DEMOGRAPHICS ── */
  h+='<section class="bg-white rounded-2xl border-2 border-cyan-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-6">';
  h+='<div class="flex items-center gap-3 mb-6"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">05</span><h2 class="text-lg font-bold">인구 통계 분석</h2></div>';
  h+='<div class="grid md:grid-cols-2 gap-8"><div>';
  h+='<div class="grid grid-cols-2 gap-4 mb-6">';
  h+='<div class="bg-blue-50 rounded-xl p-4 text-center"><p class="text-3xl font-bold text-blue-600">'+fmt(r.population)+'</p><p class="text-xs text-gray-500 mt-1">거주인구 (명)</p></div>';
  h+='<div class="bg-green-50 rounded-xl p-4 text-center"><p class="text-3xl font-bold text-green-600">'+fmt(r.daily_floating)+'</p><p class="text-xs text-gray-500 mt-1">일 유동인구 (명)</p></div>';
  h+='</div>';
  h+='<div class="space-y-4">';
  [{l:'20~39세 (핵심 타겟)',v:r.age_20_39_pct,c:'bg-blue-500'},{l:'40~59세',v:r.age_40_59_pct,c:'bg-green-500'},{l:'60세 이상',v:r.age_60_plus_pct,c:'bg-gray-400'}].forEach(function(g){
    h+='<div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600">'+g.l+'</span><span class="font-bold">'+g.v+'%</span></div><div class="h-3 bg-gray-100 rounded-full overflow-hidden"><div class="h-full rounded-full '+g.c+'" style="width:'+g.v+'%"></div></div></div>';
  });
  h+='</div></div>';
  h+='<div><h3 class="font-bold text-sm mb-4">주요 지표</h3><div class="space-y-3">';
  [{l:'인구당 치과 비율',v:'1 : '+fmt(r.pop_per_clinic)},{l:'인구 증가율',v:(r.pop_growth_rate>0?'+':'')+r.pop_growth_rate+'%'},{l:'상권 등급',v:r.commercial_grade+'등급'},{l:'최근접 역',v:r.subway_station+' ('+r.subway_line+', '+r.subway_walk_min+'분)'},{l:'버스정류장',v:r.bus_stops_500m+'개 (반경 500m)'},{l:'평당 임대료',v:r.avg_rent_pyeong+'만원'}].forEach(function(item){
    h+='<div class="flex justify-between py-2 border-b border-gray-50 text-sm"><span class="text-gray-500">'+item.l+'</span><span class="font-medium">'+item.v+'</span></div>';
  });
  h+='</div></div></div></section>';

  /* ── 07 COMPETITION LANDSCAPE ── */
  h+='<section class="bg-white rounded-2xl border-2 border-rose-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-7">';
  h+='<div class="flex items-center justify-between mb-2"><div class="flex items-center gap-3"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">06</span><h2 class="text-lg font-bold">경쟁 현황</h2></div><div class="flex items-center gap-2 text-[10px]"><span class="text-gray-400">상태:</span><span class="inline-flex items-center gap-1 bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium">영업중</span><span class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded font-medium">휴업</span><span class="inline-flex items-center gap-1 bg-gray-200 text-gray-500 px-2 py-0.5 rounded font-medium">폐업</span><span class="text-gray-300 mx-1">|</span><span class="text-gray-400">위협도:</span><span class="inline-flex items-center gap-1 bg-red-50 text-red-500 px-2 py-0.5 rounded font-medium" title="체어 5대 이상 & 5년 이상 운영">높음<span class="text-red-400 font-normal">(체어5+·5년+)</span></span><span class="inline-flex items-center gap-1 bg-amber-50 text-amber-500 px-2 py-0.5 rounded font-medium" title="체어 3대 이상">보통<span class="text-amber-400 font-normal">(체어3+)</span></span><span class="inline-flex items-center gap-1 bg-green-50 text-green-500 px-2 py-0.5 rounded font-medium" title="체어 3대 미만 소규모">낮음<span class="text-green-400 font-normal">(소규모)</span></span></div></div>';
  var activeCount=clinics.filter(function(c){return c.status==='영업중'}).length;
  var closedCount=clinics.filter(function(c){return c.status==='폐업'}).length;
  var suspCount=clinics.filter(function(c){return c.status==='휴업'}).length;
  var forSaleCount=clinics.filter(function(c){return c.forSale}).length;
  h+='<p class="text-sm text-gray-500 mb-6">반경 500m 내 치과 '+clinics.length+'개 (영업중 '+activeCount+'개'+(suspCount>0?' · 휴업 '+suspCount+'개':'')+(closedCount>0?' · 폐업 '+closedCount+'개':'')+(forSaleCount>0?' · 인수가능 '+forSaleCount+'개':'')+')</p>';
  h+='<div class="space-y-4">';
  clinics.sort(function(a,b){var o={영업중:0,휴업:1,폐업:2};return(o[a.status]||0)-(o[b.status]||0)||b.annualRevenue-a.annualRevenue});
  clinics.forEach(function(c,i){
    var threatColor=c.competitionThreat==='높음'?'text-red-500 bg-red-50':c.competitionThreat==='보통'?'text-amber-500 bg-amber-50':'text-green-500 bg-green-50';
    var statusColor=c.status==='영업중'?'bg-green-100 text-green-700':c.status==='휴업'?'bg-yellow-100 text-yellow-700':'bg-gray-200 text-gray-500';
    var nightLabel=c.nightWeekend===2?'야간+주말':c.nightWeekend===1?'야간진료':'해당없음';
    var nightColor=c.nightWeekend>=1?'bg-indigo-50 text-indigo-600':'bg-gray-100 text-gray-400';
    var cardBorder=c.status==='영업중'?'border-green-300':c.status==='휴업'?'border-yellow-300':'border-gray-300';
    h+='<div class="bg-gray-50 rounded-xl p-5 border-2 '+cardBorder+'">';
    /* Row 1: Header */
    h+='<div class="flex items-center gap-3 mb-3">';
    h+='<div class="w-10 h-10 '+(c.status==='영업중'?'bg-red-100':'bg-gray-200')+' rounded-full flex items-center justify-center text-lg shrink-0">🦷</div>';
    h+='<div class="flex-1 min-w-0">';
    h+='<div class="flex items-center gap-2 flex-wrap"><p class="font-bold text-sm">'+c.name+'</p><span class="text-[10px] font-medium '+statusColor+' px-1.5 py-0.5 rounded">'+c.status+'</span>';
    h+='<span class="text-[10px] '+threatColor+' px-1.5 py-0.5 rounded font-medium">위협 '+c.competitionThreat+'</span>';
    if(c.forSale)h+='<span class="text-[10px] font-medium bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">인수가능</span>';
    h+='</div>';
    h+='<p class="text-xs text-gray-500 mt-0.5">'+c.type+' · '+c.director+' · '+c.estYear+'년 개업 ('+c.yearsOpen+'년차)</p>';
    h+='</div></div>';
    /* Row 2: Key metrics grid */
    h+='<div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">';
    h+='<div class="bg-white rounded-lg p-2.5 text-center border border-gray-200"><p class="text-[10px] text-gray-400">연매출</p><p class="text-sm font-bold text-emerald-600">'+fmtRevKr(c.annualRevenue)+'</p></div>';
    h+='<div class="bg-white rounded-lg p-2.5 text-center border border-gray-200"><p class="text-[10px] text-gray-400">월매출</p><p class="text-sm font-bold text-emerald-600">'+fmt(c.monthlyRevenue)+'만</p></div>';
    h+='<div class="bg-white rounded-lg p-2.5 text-center border border-gray-200"><p class="text-[10px] text-gray-400">일 환자수</p><p class="text-sm font-bold text-blue-600">'+c.dailyPatients+'명</p></div>';
    h+='<div class="bg-white rounded-lg p-2.5 text-center border border-gray-200"><p class="text-[10px] text-gray-400">비급여 비율</p><p class="text-sm font-bold text-orange-600">'+c.nonCoverageRatio+'%</p></div>';
    h+='</div>';
    /* Row 3: Detail grid */
    h+='<div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-3 text-center">';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">체어</p><p class="text-xs font-semibold">'+c.chairs+'대</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">면적</p><p class="text-xs font-semibold">'+c.size+'</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">층수</p><p class="text-xs font-semibold">'+c.floor+'</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">의사</p><p class="text-xs font-semibold">'+c.dentistCount+'명</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">위생사</p><p class="text-xs font-semibold">'+c.hygienistCount+'명</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">총 직원</p><p class="text-xs font-semibold">'+c.totalStaff+'명</p></div>';
    h+='</div>';
    /* Row 4: Ratings & Online presence */
    h+='<div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-3 text-center">';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">네이버 평점</p><p class="text-xs font-semibold text-yellow-500">★ '+c.naverRating+'</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">리뷰 수</p><p class="text-xs font-semibold">'+fmt(c.naverReviewCount)+'건</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">블로그 노출</p><p class="text-xs font-semibold">'+fmt(c.blogExposure)+'건</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">보험청구</p><p class="text-xs font-semibold">월 '+fmt(c.insuranceClaims)+'건</p></div>';
    h+='<div class="bg-white rounded-lg p-2 border border-gray-200"><p class="text-[10px] text-gray-400">동종 근접</p><p class="text-xs font-semibold">'+c.sameTypeNearby+'개</p></div>';
    h+='</div>';
    /* Row 5: Tags */
    h+='<div class="flex flex-wrap gap-1.5">';
    c.specialties.forEach(function(sp){h+='<span class="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded-full">'+sp+'</span>'});
    h+='<span class="text-[10px] '+nightColor+' px-2 py-0.5 rounded-full">'+nightLabel+'</span>';
    h+='<span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">가격대: '+c.priceLevel+'</span>';
    h+='<span class="text-[10px] '+(c.hasParking?'bg-sky-50 text-sky-600':'bg-gray-100 text-gray-400')+' px-2 py-0.5 rounded-full">'+(c.hasParking?'주차 가능':'주차 불가')+'</span>';
    if(c.forSale&&c.estimatedAcquisitionPrice)h+='<span class="text-[10px] bg-purple-50 text-purple-700 px-2 py-0.5 rounded-full font-medium">인수 예상가 '+fmt(c.estimatedAcquisitionPrice)+'만</span>';
    h+='</div>';
    h+='</div>';
  });
  h+='</div></section>';

  /* ── 08 INVESTMENT SUMMARY ── */
  h+='<section class="bg-white rounded-2xl border-2 border-emerald-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-8">';
  h+='<div class="flex items-center gap-3 mb-6"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">07</span><h2 class="text-lg font-bold">투자 및 수익 분석</h2></div>';
  h+='<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">';
  [{l:'총 투자금',v:(ti/10000).toFixed(1)+'억',c:'text-slate-800',bg:'bg-slate-50'},{l:'예상 월매출',v:fmt(mRev)+'만',c:'text-green-600',bg:'bg-green-50'},{l:'월 순이익',v:(mP>0?'+':'')+fmt(mP)+'만',c:mP>0?'text-blue-600':'text-red-500',bg:mP>0?'bg-blue-50':'bg-red-50'},{l:'손익분기',v:be+'개월',c:'text-purple-600',bg:'bg-purple-50'}].forEach(function(card){
    h+='<div class="'+card.bg+' rounded-xl p-5 text-center"><p class="text-xs text-gray-500 mb-1">'+card.l+'</p><p class="text-2xl font-bold '+card.c+'">'+card.v+'</p></div>';
  });
  h+='</div>';
  /* P&L Breakdown */
  h+='<div class="grid md:grid-cols-2 gap-6">';
  h+='<div class="border-2 border-slate-300 rounded-xl p-5"><h3 class="font-bold text-sm mb-3 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-slate-400"></span>초기 투자금 구성</h3><div class="space-y-2">';
  [{l:'보증금',v:r.avg_rent_pyeong*r.area_pyeong*10,c:'bg-blue-400'},{l:'인테리어',v:r.area_pyeong*200,c:'bg-amber-400'},{l:'의료장비',v:12000,c:'bg-emerald-400'},{l:'운영자금',v:3000,c:'bg-purple-400'}].forEach(function(item){
    var pct=Math.round(item.v/ti*100);
    h+='<div class="flex items-center gap-2"><span class="text-xs text-gray-500 w-16">'+item.l+'</span><div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full '+item.c+' rounded-full" style="width:'+pct+'%"></div></div><span class="text-xs font-medium w-24 text-right">'+fmt(item.v)+'만 <span class="text-gray-400">('+pct+'%)</span></span></div>';
  });
  h+='<div class="pt-3 mt-1 border-t border-slate-200 flex justify-between text-sm font-bold"><span>합계</span><span class="text-slate-700">'+(ti/10000).toFixed(1)+'억원</span></div></div></div>';
  h+='<div class="border-2 border-emerald-300 rounded-xl p-5"><h3 class="font-bold text-sm mb-3 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-400"></span>월간 손익 구조</h3>';
  h+='<div class="bg-green-50 rounded-lg p-3 mb-3"><div class="flex justify-between text-sm text-green-700 font-medium"><span>예상 월매출</span><span class="font-bold">'+fmt(mRev)+'만원</span></div><p class="text-xs text-green-600 mt-1">일 '+dp+'명 × 15만원 × 25일</p></div>';
  h+='<div class="space-y-1.5">';
  [{l:'임대료',v:mr},{l:'관리비',v:Math.round(r.area_pyeong*5)},{l:'인건비',v:800},{l:'재료비(15%)',v:Math.round(mRev*0.15)},{l:'기타',v:300}].forEach(function(item){
    h+='<div class="flex justify-between text-sm"><span class="text-gray-500">(-) '+item.l+'</span><span class="text-red-500">'+fmt(item.v)+'만</span></div>';
  });
  h+='<div class="pt-3 mt-1 border-t border-emerald-200 flex justify-between font-bold text-sm"><span>월 순이익</span><span class="'+(mP>0?'text-blue-600':'text-red-500')+'">'+(mP>0?'+':'')+fmt(mP)+'만원</span></div>';
  h+='</div></div></div></section>';

  /* ── 09 RISK & OPPORTUNITY ── */
  h+='<section class="bg-white rounded-2xl border-2 border-amber-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-9">';
  h+='<div class="flex items-center gap-3 mb-6"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">08</span><h2 class="text-lg font-bold">리스크 & 기회 분석</h2></div>';
  h+='<div class="grid md:grid-cols-2 gap-6">';
  h+='<div><h3 class="font-semibold text-red-600 text-sm mb-3 flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>리스크 요인</h3>';
  h+='<div class="space-y-2">';
  risks.forEach(function(rk){
    var sevColor=rk.sev==='high'?'bg-red-50 border-red-200 text-red-800':rk.sev==='medium'?'bg-yellow-50 border-yellow-200 text-yellow-800':'bg-gray-50 border-gray-200 text-gray-700';
    h+='<div class="'+sevColor+' border rounded-lg p-3"><p class="font-semibold text-sm">'+rk.t+'</p><p class="text-xs mt-0.5 opacity-80">'+rk.d+'</p></div>';
  });
  h+='</div></div>';
  h+='<div><h3 class="font-semibold text-green-600 text-sm mb-3 flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>기회 요인</h3>';
  h+='<div class="space-y-2">';
  opps.forEach(function(op){
    h+='<div class="bg-green-50 border border-green-200 text-green-800 rounded-lg p-3"><p class="font-semibold text-sm">'+op.t+'</p><p class="text-xs mt-0.5 opacity-80">'+op.d+'</p></div>';
  });
  h+='</div></div></div>';
  /* Risk-Opportunity comprehensive advice (~200 words) */
  var highRiskCnt=risks.filter(function(rk){return rk.sev==='high'}).length;
  var riskBalance=highRiskCnt===0?'positive':highRiskCnt>=2?'negative':'neutral';
  var adviceOpen='';
  if(riskBalance==='positive'){
    adviceOpen+='종합적으로 '+r.dong+' 지역은 <b>기회 요인이 리스크 요인을 상회</b>하는 긍정적인 입지입니다. ';
    adviceOpen+='고위험 요인이 발견되지 않았으며, '+opps.length+'개의 기회 요인이 안정적인 개원 환경을 뒷받침합니다. ';
    adviceOpen+='이 지역에서 개원을 고려 중인 원장님께서는 <b>적극적인 개원 추진</b>을 권장드립니다. ';
  }else if(riskBalance==='negative'){
    adviceOpen+='종합적으로 '+r.dong+' 지역은 <b>고위험 요인이 '+highRiskCnt+'건 감지</b>되어 신중한 접근이 필요한 입지입니다. ';
    adviceOpen+='리스크 요인이 기회 요인보다 무게감이 크므로, 개원 전 반드시 해당 리스크에 대한 구체적인 대응 전략 수립이 선행되어야 합니다. ';
    adviceOpen+='이 지역에서 개원을 고려 중인 원장님께서는 <b>충분한 사전 검증</b> 후 의사결정하시기를 권장합니다. ';
  }else{
    adviceOpen+='종합적으로 '+r.dong+' 지역은 <b>기회와 리스크가 혼재</b>하는 입지입니다. ';
    adviceOpen+='일부 주의가 필요한 요인이 존재하나, 적절한 전략 수립을 통해 충분히 극복 가능한 수준입니다. ';
    adviceOpen+='이 지역에서 개원을 고려 중인 원장님께서는 <b>리스크 요인에 대한 구체적 대응 방안을 마련한 후 개원을 추진</b>하시길 권장합니다. ';
  }
  adviceOpen+='특히 반경 500m 내 '+r.dental_count+'개 치과가 운영 중인 경쟁 환경에서 차별화 전략은 필수적입니다. ';
  adviceOpen+=r.age_20_39_pct>=35?'20~39세 인구 비율이 '+r.age_20_39_pct+'%로 높아 심미·교정 등 고단가 비급여 진료에 특화하면 경쟁 우위를 확보할 수 있습니다. ':'임플란트·보철 중심의 진료 포트폴리오를 구축하여 지역 내 중장년층 수요를 선점하는 전략이 유효합니다. ';
  adviceOpen+='월 예상 순이익 '+(mP>0?'+':'')+fmt(mP)+'만원, 손익분기 약 '+be+'개월 기준으로 ';
  adviceOpen+=mP>0&&be<=24?'<b>재무적 타당성은 양호</b>합니다. ':mP>0?'재무적으로 안정화까지 다소 시간이 소요될 수 있어 <b>충분한 운영자금 확보</b>가 중요합니다. ':'<b>수익 구조 개선 방안을 반드시 사전에 수립</b>해야 합니다. ';
  adviceOpen+='개원 후 초기 6개월은 환자 확보를 위한 마케팅 투자가 집중적으로 필요하며, 네이버 플레이스 최적화·블로그 콘텐츠·지역 커뮤니티 활동을 병행하시기 바랍니다. ';
  adviceOpen+='최종 의사결정 전 반드시 <b>현장 답사, 부동산 전문가 상담, 세무·법률 자문</b>을 거쳐 본 리포트의 분석 결과를 교차 검증하시길 강력히 권고드립니다.';
  h+='<div class="mt-6 bg-slate-50 border border-slate-200 rounded-xl p-5"><div class="flex items-center gap-2 mb-3"><span class="text-base">💡</span><h3 class="font-bold text-sm text-slate-800">종합 평가 및 개원 조언</h3></div><p class="text-sm text-slate-700 leading-relaxed">'+adviceOpen+'</p></div>';
  h+='</section>';

  /* ── 10 RECOMMENDATIONS ── */
  h+='<section class="bg-white rounded-2xl border-2 border-sky-300 p-6 md:p-8 shadow-sm mb-6 fade-in fade-in-10">';
  h+='<div class="flex items-center gap-3 mb-6"><span class="text-xs font-bold text-white bg-blue-600 w-7 h-7 rounded-lg flex items-center justify-center">09</span><h2 class="text-lg font-bold">권장 사항 및 다음 단계</h2></div>';
  h+='<div class="grid md:grid-cols-3 gap-4">';
  var recs=[];
  if(ts>=70){
    var rec1d='본 AI 분석 결과 '+r.dong+' 지역은 종합 '+ts+'점으로 <b>'+sl+'</b> 판정을 받았습니다. ';
    rec1d+='인구 '+fmt(r.population)+'명, 유동인구 일 '+fmt(r.daily_floating)+'명의 수요 기반과 ';
    rec1d+=r.scores.competition>=60?'상대적으로 양호한 경쟁 환경':'다소 치열하지만 차별화 가능한 경쟁 환경';
    rec1d+='을 고려할 때, AI가 추천하는 1·2·3순위 위치를 중심으로 구체적인 임대 물건 탐색에 착수하시길 권장합니다. ';
    rec1d+='개원 시기는 임대 계약부터 인테리어 완공까지 통상 3~4개월이 소요되므로, 목표 개원일 기준 최소 6개월 전부터 준비를 시작하는 것이 바람직합니다.';
    recs.push({n:'1',t:'개원 추진',d:rec1d,c:'bg-blue-50 border-blue-200'});
  }else{
    var rec1d='본 AI 분석 결과 '+r.dong+' 지역은 종합 '+ts+'점으로 <b>'+sl+'</b> 판정을 받았습니다. ';
    rec1d+=highRiskCnt>0?'고위험 요인 '+highRiskCnt+'건이 감지되었으므로, ':'일부 리스크 요인이 확인되었으므로, ';
    rec1d+='즉각적인 개원보다는 추가적인 현장 조사와 시장 분석이 선행되어야 합니다. ';
    rec1d+='특히 반경 500m 내 치과 '+r.dental_count+'개의 경쟁 구도와 평당 '+r.avg_rent_pyeong+'만원의 임대료 수준을 면밀히 재검토하시기 바랍니다. ';
    rec1d+='인근 유사 상권의 비교 분석을 통해 보다 유리한 대안 입지를 함께 탐색하시는 것을 권장드립니다.';
    recs.push({n:'1',t:'추가 조사',d:rec1d,c:'bg-yellow-50 border-yellow-200'});
  }
  var rec2d='추천 1·2·3순위 위치를 반드시 직접 방문하여 현장 여건을 확인하세요. ';
  rec2d+='주요 확인 사항으로는 ① 건물 상태 및 층수별 임대 조건 비교, ② '+r.subway_station+' 방면 도보 접근성과 대중교통 편의성, ③ 주차장 확보 가능 여부와 인근 유료 주차장 현황, ④ 주변 약국·병원 등 의료 클러스터 형성 여부입니다. ';
  rec2d+='방문 시 평일 오전·오후, 주말 등 시간대별 유동인구 변화를 직접 관찰하고, 인근 치과에 환자로서 방문하여 서비스 수준과 가격대를 파악하면 경쟁 전략 수립에 큰 도움이 됩니다.';
  recs.push({n:'2',t:'현장 실사',d:rec2d,c:'bg-green-50 border-green-200'});
  var rec3d='본 리포트의 투자 시뮬레이션 결과(총 투자금 '+(ti/10000).toFixed(1)+'억, 월 순이익 '+(mP>0?'+':'')+fmt(mP)+'만원, 손익분기 '+be+'개월)를 세무사·회계사와 공유하여 자금 조달 계획을 구체화하세요. ';
  rec3d+='치과경영 컨설턴트를 통해 진료 포트폴리오 구성, 인력 채용 계획, 장비 선정을 병행하시기 바랍니다. ';
  rec3d+='또한 개원 전 법률 자문을 통해 임대차 계약 조건, 의료법 관련 인허가 절차, 광고 규제 등을 사전에 검토하여 개원 후 발생할 수 있는 법적 리스크를 최소화하시길 권고드립니다.';
  recs.push({n:'3',t:'전문가 상담',d:rec3d,c:'bg-purple-50 border-purple-200'});
  recs.forEach(function(rc){
    h+='<div class="'+rc.c+' border rounded-xl p-5"><div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold text-white bg-gray-800 w-6 h-6 rounded-full flex items-center justify-center">'+rc.n+'</span><h3 class="font-bold text-sm">'+rc.t+'</h3></div><p class="text-sm text-gray-600">'+rc.d+'</p></div>';
  });
  h+='</div></section>';

  /* ── CONTACT ── */
  h+='<div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6 text-center">';
  h+='<p class="text-sm font-bold text-blue-900 mb-2">덴탈맵AI 치과개원 입지분석 리포트 문의 및 요청은 아래 연락처로 알려주세요</p>';
  h+='<div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-3">';
  h+='<div class="flex items-center gap-2 text-sm text-blue-800"><svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span class="font-semibold">심재우 대표</span></div>';
  h+='<div class="flex items-center gap-2 text-sm text-blue-800"><svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><a href="mailto:jaiwshim@gmail.com" class="hover:underline">jaiwshim@gmail.com</a></div>';
  h+='<div class="flex items-center gap-2 text-sm text-blue-800"><svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg><a href="tel:010-2397-5734" class="hover:underline">010-2397-5734</a></div>';
  h+='</div></div>';

  /* ── DISCLAIMER ── */
  h+='<div class="bg-gray-100 rounded-xl p-4 text-xs text-gray-600 mb-6">본 AI 입지분석 리포트는 공공 데이터 기반의 참고 자료이며, 법적 효력이 없습니다.<br>투자 결정 시 반드시 전문가와 상담하시기 바랍니다. | &copy; '+new Date().getFullYear()+' DentalMap AI · Report ID: '+reportId+'</div>';

  /* ── ACTION BUTTONS ── */
  h+='<div class="flex flex-wrap gap-3 justify-center py-6 no-print">';
  h+='<button onclick="window.print()" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-xl hover:bg-blue-700 transition flex items-center gap-2 shadow-lg shadow-blue-600/20"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>PDF / 인쇄</button>';
  h+='<a href="analysis.html?q='+encodeURIComponent(r.dong)+'" class="border border-gray-300 text-gray-700 font-semibold px-6 py-3 rounded-xl hover:bg-gray-50 transition flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/></svg>상세 분석으로 돌아가기</a>';
  h+='<a href="analysis.html" class="border border-gray-300 text-gray-700 font-semibold px-6 py-3 rounded-xl hover:bg-gray-50 transition">다른 지역 분석</a>';
  h+='</div>';

  h+='</div>';

  document.getElementById('report-root').innerHTML=h;

  /* Render map after DOM update */
  setTimeout(function(){renderReportMap(r,clinics,spots)},300);
}

/* ═══════════════════════════════════════════════════════════════
   LOADING SCREEN (3 phases)
   ═══════════════════════════════════════════════════════════════ */
function showLoading(name){
  var phases=['데이터 수집 중...','AI 분석 진행 중...','리포트 생성 중...'];
  var h='<div class="min-h-[80vh] flex items-center justify-center"><div class="text-center max-w-sm mx-auto">';
  h+='<div class="relative w-24 h-24 mx-auto mb-8"><svg class="animate-spin w-24 h-24 text-blue-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg><div class="absolute inset-0 flex items-center justify-center"><span class="text-2xl">📋</span></div></div>';
  h+='<h2 class="text-xl font-bold text-gray-800">AI 입지분석 리포트 생성</h2>';
  h+='<p class="mt-2 text-gray-500"><span class="text-blue-600 font-semibold">'+name+'</span></p>';
  h+='<div class="mt-8 space-y-3" id="loading-phases">';
  phases.forEach(function(p,i){
    h+='<div class="flex items-center gap-3 text-sm text-gray-400" id="phase-'+i+'"><div class="w-5 h-5 rounded-full border-2 border-gray-200 flex items-center justify-center shrink-0" id="phase-icon-'+i+'"></div><span>'+p+'</span></div>';
  });
  h+='</div>';
  h+='<div class="mt-6 w-full h-1.5 bg-gray-100 rounded-full overflow-hidden"><div id="load-bar" class="h-full bg-blue-600 rounded-full transition-all duration-500" style="width:0%"></div></div>';
  h+='</div></div>';
  document.getElementById('report-root').innerHTML=h;

  /* Animate phases */
  var bar=document.getElementById('load-bar');
  setTimeout(function(){
    document.getElementById('phase-0').classList.replace('text-gray-400','text-blue-600');
    document.getElementById('phase-icon-0').innerHTML='<svg class="animate-spin w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>';
    bar.style.width='20%';
  },100);
  setTimeout(function(){
    document.getElementById('phase-icon-0').innerHTML='<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
    document.getElementById('phase-0').classList.replace('text-blue-600','text-green-600');
    document.getElementById('phase-1').classList.replace('text-gray-400','text-blue-600');
    document.getElementById('phase-icon-1').innerHTML='<svg class="animate-spin w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>';
    bar.style.width='50%';
  },1000);
  setTimeout(function(){
    document.getElementById('phase-icon-1').innerHTML='<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
    document.getElementById('phase-1').classList.replace('text-blue-600','text-green-600');
    document.getElementById('phase-2').classList.replace('text-gray-400','text-blue-600');
    document.getElementById('phase-icon-2').innerHTML='<svg class="animate-spin w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>';
    bar.style.width='80%';
  },2000);
}

function showNoRegion(){
  document.getElementById('report-root').innerHTML='<div class="min-h-[80vh] flex items-center justify-center"><div class="max-w-md mx-auto text-center px-6"><div class="text-6xl mb-6">📋</div><h1 class="text-2xl font-bold">AI 입지분석 리포트</h1><p class="mt-3 text-gray-500">리포트를 생성할 지역을 선택해주세요.</p><a href="analysis.html" class="mt-6 inline-block bg-blue-600 text-white font-semibold px-8 py-3 rounded-xl hover:bg-blue-700 transition">입지분석 페이지에서 지역 선택</a></div></div>';
}

/* ═══════════════════════════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded',function(){
  var params=new URLSearchParams(window.location.search);
  var q=params.get('q');
  if(!q||!q.trim()){showNoRegion();return}
  var name=q.trim();
  var direct=params.get('direct');

  async function loadReport(){
    var r=REGIONS.find(function(x){return x.dong===name||x.dong.includes(name)});
    if(!r)r=REGIONS.find(function(x){return x.sigungu.includes(name)||x.sido.includes(name)});
    if(!r)r=await addGeneratedRegion(name);
    var regionCtx=r.sido?(r.sigungu&&r.sigungu!==r.dong?' ('+r.sido+' '+r.sigungu+')':' ('+r.sido+')'):'';
    document.title=r.dong+regionCtx+' AI 입지분석 리포트 — 덴탈맵';
    await renderReport(r);
  }

  if(direct==='1'){
    loadReport();
  } else {
    showLoading(name);
    setTimeout(loadReport,3000);
  }
});
</script>
</body>
</html>
