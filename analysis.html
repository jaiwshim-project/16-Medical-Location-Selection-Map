<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë´íƒˆë§µ ì…ì§€ ë¶„ì„ â€” ì¹˜ê³¼ê°œì› ì…ì§€ë¶„ì„</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=31e72c61dc30008b32241bb45325abfa&libraries=services&autoload=false"></script>
<script>tailwind.config={theme:{extend:{fontFamily:{sans:['Pretendard Variable','Pretendard','system-ui','sans-serif']}}}}</script>
<style>
html{scroll-behavior:smooth}
body{font-family:'Pretendard Variable','Pretendard',system-ui,sans-serif}
details summary::-webkit-details-marker{display:none}
details summary{list-style:none}
input[type=range]{cursor:pointer}
@keyframes marker-pulse{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.5)}70%{box-shadow:0 0 0 12px rgba(245,158,11,0)}}
.leaflet-container{font-family:'Pretendard Variable',sans-serif;z-index:0}
.clinic-list-scroll{max-height:320px;overflow-y:auto}
.clinic-list-scroll::-webkit-scrollbar{width:4px}.clinic-list-scroll::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}
.clinic-tooltip{background:white;border:1px solid #e5e7eb;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:600;color:#1f2937;box-shadow:0 1px 4px rgba(0,0,0,0.12);white-space:nowrap}
.clinic-tooltip::before{border-right-color:#e5e7eb!important}
.rec-tooltip{background:#fffbeb;border:1px solid #fbbf24;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:700;color:#92400e;box-shadow:0 1px 4px rgba(0,0,0,0.12)}
.rec-tooltip::before{border-right-color:#fbbf24!important}
.map-legend{background:white;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.15);padding:0;font-size:12px;line-height:1.6;max-width:180px;color:#374151;overflow:hidden}
#analysis-map .leaflet-top.leaflet-right .map-legend{margin-top:10px}
.leaflet-control-attribution{font-size:9px!important;opacity:0.7}
.map-legend h4{font-size:12px;font-weight:700;margin:0;color:#111827;padding:8px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none}
.map-legend h4 .leg-arrow{transition:transform 0.2s;font-size:10px}
.map-legend.collapsed h4 .leg-arrow{transform:rotate(-90deg)}
.map-legend .leg-body{max-height:none;overflow-y:visible;padding:8px 12px 10px}
.map-legend .leg-body::-webkit-scrollbar{width:4px}
.map-legend .leg-body::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}
.map-legend .leg-section{margin-top:6px;padding-top:5px;border-top:1px solid #f3f4f6}
.map-legend .leg-section:first-of-type{margin-top:0;padding-top:0;border-top:none}
.map-legend .leg-title{font-size:10px;font-weight:700;color:#6b7280;letter-spacing:0.5px;margin-bottom:3px}
.map-legend .leg-row{display:flex;align-items:center;gap:5px;margin:1px 0;font-size:11px}
.map-legend .leg-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid white;box-shadow:0 1px 2px rgba(0,0,0,0.2);flex-shrink:0}
.map-legend .leg-badge{padding:0px 5px;border-radius:3px;font-size:9px;font-weight:600;flex-shrink:0}
.map-legend.collapsed .leg-body{display:none}
</style>
</head>
<body class="antialiased bg-white text-gray-900">

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-sky-100/90 backdrop-blur border-b border-sky-200">
<div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
<a href="index.html" class="flex items-center gap-2"><div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-sm">D</span></div><span class="font-bold text-lg text-blue-900">ë´íƒˆë§µAI <span class="text-base font-semibold text-blue-600">ì¹˜ê³¼ê°œì› ì…ì§€ë¶„ì„</span></span></a>
<nav class="hidden md:flex items-center gap-8">
<span class="text-sm text-blue-600 font-semibold border-b-2 border-blue-600 pb-0.5">ì…ì§€ë¶„ì„</span>
<a href="map.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">ì§€ë„ íƒìƒ‰</a>
<a href="pricing.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">ìš”ê¸ˆì œ</a>
<a href="reports.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">ë¦¬í¬íŠ¸</a>
<a href="promo.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">í™ë³´</a>
<a href="faq.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">FAQ</a>
<a href="manual.html" class="text-sm font-medium text-blue-800 hover:text-blue-950 transition">ì‚¬ìš©ì ë§¤ë‰´ì–¼</a>
</nav>
<div class="hidden md:flex items-center gap-3"><a href="map.html" class="bg-blue-600 text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition">ë°”ë¡œ ì²´í—˜í•˜ê¸°</a></div>
<button class="md:hidden p-2 text-blue-800" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
</div>
<div id="mobile-menu" class="hidden md:hidden border-t border-sky-200 bg-sky-50 px-6 py-4 space-y-3">
<span class="block text-blue-600 font-semibold py-2">ì…ì§€ë¶„ì„</span>
<a href="map.html" class="block text-blue-800 font-medium py-2">ì§€ë„ íƒìƒ‰</a>
<a href="pricing.html" class="block text-blue-800 font-medium py-2">ìš”ê¸ˆì œ</a>
<a href="reports.html" class="block text-blue-800 font-medium py-2">ë¦¬í¬íŠ¸</a>
<a href="promo.html" class="block text-blue-800 font-medium py-2">í™ë³´</a>
<a href="faq.html" class="block text-blue-800 font-medium py-2">FAQ</a>
<a href="manual.html" class="block text-blue-800 font-medium py-2">ì‚¬ìš©ì ë§¤ë‰´ì–¼</a>
<hr class="border-gray-100">
<a href="map.html" class="block bg-blue-600 text-white text-center py-2.5 rounded-lg font-semibold">ë°”ë¡œ ì²´í—˜í•˜ê¸°</a>
</div>
</header>

<main>
<div id="analysis-root"></div>
</main>

<!-- FOOTER -->
<footer class="bg-gray-900 text-gray-400 py-12"><div class="max-w-7xl mx-auto px-6">
<div class="grid md:grid-cols-4 gap-8">
<div><div class="flex items-center gap-2 mb-3"><div class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-xs">D</span></div><span class="font-bold text-white">ë´íƒˆë§µAI <span class="text-sm font-medium text-gray-300">ì¹˜ê³¼ê°œì› ì…ì§€ë¶„ì„</span></span></div><p class="text-sm">ë°ì´í„°ë¡œ ì°¾ëŠ” ìµœì ì˜ ì¹˜ê³¼ ê°œì› ì…ì§€</p></div>
<div><h3 class="text-white font-semibold mb-3 text-sm">ì„œë¹„ìŠ¤</h3><div class="space-y-2 text-sm"><a href="map.html" class="block hover:text-white transition">ì§€ë„ íƒìƒ‰</a><a href="pricing.html" class="block hover:text-white transition">ìš”ê¸ˆì œ</a></div></div>
<div><h3 class="text-white font-semibold mb-3 text-sm">ì§€ì›</h3><div class="space-y-2 text-sm"><a href="faq.html" class="block hover:text-white transition">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</a><a href="manual.html" class="block hover:text-white transition">ì‚¬ìš©ì ë§¤ë‰´ì–¼</a><a href="index.html" class="block hover:text-white transition">í™ˆìœ¼ë¡œ</a></div></div>
<div><h3 class="text-white font-semibold mb-3 text-sm">ì—°ë½ì²˜</h3><div class="space-y-2 text-sm"><p>ì‹¬ì¬ìš° ëŒ€í‘œ</p><p><a href="mailto:jaiwshim@gmail.com" class="hover:text-white">jaiwshim@gmail.com</a></p><p><a href="tel:010-2397-5734" class="hover:text-white">010-2397-5734</a></p></div></div>
</div>
<div class="border-t border-gray-800 mt-8 pt-8 text-xs"><p>ë´íƒˆë§µAI ì¹˜ê³¼ê°œì› ì…ì§€ë¶„ì„ | ì‹¬ì¬ìš° ëŒ€í‘œ</p><p class="mt-1">ë¬¸ì˜: <a href="mailto:jaiwshim@gmail.com" class="text-gray-400 hover:text-white">jaiwshim@gmail.com</a> Â· <a href="tel:010-2397-5734" class="text-gray-400 hover:text-white">010-2397-5734</a></p><p class="mt-2">&copy; 2025 DentalMap. All rights reserved.</p><p class="mt-2 text-gray-600">ë³¸ ì„œë¹„ìŠ¤ì˜ ë¶„ì„ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, íˆ¬ì ê²°ì •ì— ëŒ€í•œ ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p></div>
</div></footer>

<script>
/* â”€â”€ Mock Data â”€â”€ */
const REGIONS=[
{dong_code:"1168010100",sido:"ì„œìš¸",sigungu:"ê°•ë‚¨êµ¬",dong:"ì—­ì‚¼ë™",population:32450,age_20_39_pct:35,age_40_59_pct:28,age_60_plus_pct:19,dental_count:12,pop_per_clinic:2704,avg_rent_pyeong:18,area_pyeong:40,subway_station:"ì—­ì‚¼ì—­",subway_line:"2í˜¸ì„ ",subway_walk_min:3,bus_stops_500m:8,daily_floating:85000,pop_growth_rate:1.2,commercial_grade:"A",scores:{population:82,competition:55,cost:48,access:91,growth:68,total:72},grade:"B",lat:37.5007,lng:127.0365},
{dong_code:"1165010700",sido:"ì„œìš¸",sigungu:"ì„œì´ˆêµ¬",dong:"ì„œì´ˆë™",population:28300,age_20_39_pct:32,age_40_59_pct:30,age_60_plus_pct:20,dental_count:15,pop_per_clinic:1887,avg_rent_pyeong:20,area_pyeong:40,subway_station:"ì„œì´ˆì—­",subway_line:"2í˜¸ì„ ",subway_walk_min:5,bus_stops_500m:6,daily_floating:72000,pop_growth_rate:0.8,commercial_grade:"A",scores:{population:75,competition:42,cost:40,access:85,growth:60,total:63},grade:"C",lat:37.4837,lng:127.0073},
{dong_code:"4146310100",sido:"ê²½ê¸°",sigungu:"ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬",dong:"íŒêµë™",population:41200,age_20_39_pct:40,age_40_59_pct:32,age_60_plus_pct:10,dental_count:8,pop_per_clinic:5150,avg_rent_pyeong:12,area_pyeong:40,subway_station:"íŒêµì—­",subway_line:"ì‹ ë¶„ë‹¹ì„ ",subway_walk_min:7,bus_stops_500m:5,daily_floating:95000,pop_growth_rate:5.8,commercial_grade:"A",scores:{population:90,competition:82,cost:72,access:75,growth:95,total:85},grade:"A",lat:37.3948,lng:127.1112},
{dong_code:"1120010300",sido:"ì„œìš¸",sigungu:"ì„±ë™êµ¬",dong:"ì„±ìˆ˜ë™",population:25600,age_20_39_pct:42,age_40_59_pct:25,age_60_plus_pct:15,dental_count:6,pop_per_clinic:4267,avg_rent_pyeong:14,area_pyeong:35,subway_station:"ì„±ìˆ˜ì—­",subway_line:"2í˜¸ì„ ",subway_walk_min:4,bus_stops_500m:7,daily_floating:68000,pop_growth_rate:4.2,commercial_grade:"B",scores:{population:78,competition:78,cost:65,access:88,growth:88,total:79},grade:"B",lat:37.5445,lng:127.0564},
{dong_code:"1174010100",sido:"ì„œìš¸",sigungu:"ë§ˆí¬êµ¬",dong:"í•©ì •ë™",population:19800,age_20_39_pct:45,age_40_59_pct:22,age_60_plus_pct:14,dental_count:7,pop_per_clinic:2829,avg_rent_pyeong:13,area_pyeong:30,subway_station:"í•©ì •ì—­",subway_line:"2Â·6í˜¸ì„ ",subway_walk_min:2,bus_stops_500m:9,daily_floating:62000,pop_growth_rate:3.1,commercial_grade:"B",scores:{population:68,competition:65,cost:68,access:95,growth:82,total:74},grade:"B",lat:37.5496,lng:126.9139},
{dong_code:"4111710100",sido:"ê²½ê¸°",sigungu:"ìˆ˜ì›ì‹œ ì˜í†µêµ¬",dong:"ê´‘êµë™",population:52000,age_20_39_pct:38,age_40_59_pct:35,age_60_plus_pct:8,dental_count:10,pop_per_clinic:5200,avg_rent_pyeong:10,area_pyeong:45,subway_station:"ê´‘êµì—­",subway_line:"ì‹ ë¶„ë‹¹ì„ ",subway_walk_min:8,bus_stops_500m:4,daily_floating:45000,pop_growth_rate:7.2,commercial_grade:"B",scores:{population:92,competition:85,cost:80,access:68,growth:98,total:87},grade:"A",lat:37.2935,lng:127.0454},
{dong_code:"3020011200",sido:"ëŒ€ì „",sigungu:"ìœ ì„±êµ¬",dong:"ë´‰ëª…ë™",population:35800,age_20_39_pct:36,age_40_59_pct:28,age_60_plus_pct:16,dental_count:9,pop_per_clinic:3978,avg_rent_pyeong:8,area_pyeong:40,subway_station:"ì‹œì²­ì—­",subway_line:"1í˜¸ì„ ",subway_walk_min:10,bus_stops_500m:6,daily_floating:38000,pop_growth_rate:2.5,commercial_grade:"B",scores:{population:80,competition:72,cost:88,access:62,growth:75,total:77},grade:"B",lat:36.3623,lng:127.3561},
{dong_code:"2644010100",sido:"ë¶€ì‚°",sigungu:"í•´ìš´ëŒ€êµ¬",dong:"ìš°ë™",population:48500,age_20_39_pct:30,age_40_59_pct:32,age_60_plus_pct:18,dental_count:14,pop_per_clinic:3464,avg_rent_pyeong:11,area_pyeong:40,subway_station:"í•´ìš´ëŒ€ì—­",subway_line:"2í˜¸ì„ ",subway_walk_min:6,bus_stops_500m:7,daily_floating:55000,pop_growth_rate:1.5,commercial_grade:"A",scores:{population:85,competition:60,cost:75,access:78,growth:65,total:74},grade:"B",lat:35.1631,lng:129.1636}
];

/* â”€â”€ Utility â”€â”€ */
function fmt(n){return new Intl.NumberFormat('ko-KR').format(n)}
function getGradeColor(g){return{S:'text-purple-600 bg-purple-50',A:'text-blue-600 bg-blue-50',B:'text-green-600 bg-green-50',C:'text-yellow-600 bg-yellow-50',D:'text-orange-600 bg-orange-50'}[g]||'text-red-600 bg-red-50'}
function getScoreColor(s){return s>=80?'text-blue-600':s>=60?'text-green-600':s>=40?'text-yellow-600':'text-red-500'}
function getScoreBarColor(s){return s>=80?'bg-blue-500':s>=60?'bg-green-500':s>=40?'bg-yellow-500':'bg-red-500'}
function formatPrice(p){return p===0?'0':fmt(p)}

/* â”€â”€ HIRA ì •ì  ë°ì´í„° ë¡œë“œ (data/clinics.json) â”€â”€ */
let _clinicsCache=null;

async function loadClinicData(){
  if(_clinicsCache)return _clinicsCache;
  try{
    var resp=await fetch('data/clinics.json',{signal:AbortSignal.timeout(8000)});
    if(!resp.ok)return null;
    var data=await resp.json();
    if(!data.clinics||data.clinics.length===0)return null;
    _clinicsCache=data;
    console.log('[DentalMap] HIRA ì •ì  ë°ì´í„° ë¡œë“œ ì™„ë£Œ:',data.clinics.length,'ê°œ ì¹˜ê³¼,',data.meta?.fetched||'ë‚ ì§œë¯¸ìƒ');
    return data;
  }catch(e){console.warn('[DentalMap] clinics.json ë¡œë“œ ì‹¤íŒ¨:',e.message);return null}
}

/* ê²½ëŸ‰ clinic â†’ ìƒì„¸ clinic ê°ì²´ ë³€í™˜ */
function expandClinic(it,idx){
  var h=hashStr(it.n+idx),s=h*100+idx;
  var drCnt=Math.max(1,it.d||1);
  var chairs=Math.max(2,Math.round(drCnt*2.5));
  var estbDd=it.e;
  var estYear=typeof estbDd==='number'&&estbDd>19500000?Math.floor(estbDd/10000):typeof estbDd==='string'&&estbDd.length>=4?parseInt(estbDd.substring(0,4)):2015;
  if(estYear<1950||estYear>2026)estYear=2015;
  var yearsOpen=Math.max(1,2025-estYear);
  var yrFactor=Math.min(1.3,1+Math.max(0,yearsOpen-3)*0.02);
  var sz=Math.max(15,Math.round(chairs*7+seededRand(s*41,-3,5)));
  var annRev=Math.round((chairs*7000+sz*120+seededRand(s*43,-3000,8000))*yrFactor);
  var monthlyRev=Math.round(annRev/12);
  var dailyPat=Math.max(5,Math.round(chairs*seededRand(s*47,3,7)+seededRand(s*51,-3,5)));
  var hygienistCnt=Math.max(1,Math.round(chairs*0.8)+seededRand(s*57,-1,1));
  var totalStaff=drCnt+hygienistCnt+Math.max(1,seededRand(s*59,1,Math.round(chairs*0.5)+1));
  var insClaims=Math.round(dailyPat*22*seededRand(s*61,60,85)/100);
  var nonCovRatio=seededRand(s*63,25,65);
  var naverRating=(seededRand(s*67,30,50)/10).toFixed(1);
  var naverReviewCnt=Math.round(yearsOpen*seededRand(s*69,15,80)+seededRand(s*71,0,100));
  var blogExposure=seededRand(s*73,50,2000);
  var specPool=['ì„í”Œë€íŠ¸','ì¹˜ì•„êµì •','ì‹¬ë¯¸ë³´ì² ','ì†Œì•„ì§„ë£Œ','ì‡ëª¸ì¹˜ë£Œ','ì¶©ì¹˜ì¹˜ë£Œ','ë¯¸ë°±','í„±ê´€ì ˆ','ì‚¬ë‘ë‹ˆë°œì¹˜','íˆ¬ëª…êµì •','ë¼ë¯¸ë„¤ì´íŠ¸'];
  var specCnt=seededRand(s*75,2,5),specs=[];
  for(var j=0;j<specCnt;j++){var sp=specPool[seededRand(s*77+j*13,0,specPool.length-1)];if(specs.indexOf(sp)<0)specs.push(sp)}
  var nightWeekend=seededRand(s*79,0,2);
  var priceLvl=['ì €ê°€','ì¤‘ê°„','ê³ ê°€'][seededRand(s*81,0,2)];
  var threatLvl=chairs>=5&&yearsOpen>=5?'ë†’ìŒ':chairs>=3?'ë³´í†µ':'ë‚®ìŒ';
  var sameTypeNearby=seededRand(s*83,0,4);
  var forSale=seededRand(s*89,0,12)===0;
  var estAcqPrice=forSale?Math.round(annRev*seededRand(s*91,8,18)/10):null;
  return{name:it.n,type:it.c===41?'ì¹˜ê³¼ë³‘ì›':'ì¹˜ê³¼ì˜ì›',
    director:'',lat:it.y,lng:it.x,
    address:it.a||'',phone:it.t||'',hospUrl:'',
    estYear:estYear,rating:naverRating,chairs:chairs,
    hasParking:seededRand(s*31,0,1)===1,floor:'',size:sz+'í‰',annualRevenue:annRev,
    monthlyRevenue:monthlyRev,dailyPatients:dailyPat,dentistCount:drCnt,hygienistCount:hygienistCnt,
    totalStaff:totalStaff,insuranceClaims:insClaims,nonCoverageRatio:nonCovRatio,
    naverRating:naverRating,naverReviewCount:naverReviewCnt,blogExposure:blogExposure,
    specialties:specs,nightWeekend:nightWeekend,priceLevel:priceLvl,yearsOpen:yearsOpen,
    competitionThreat:threatLvl,sameTypeNearby:sameTypeNearby,
    status:'ì˜ì—…ì¤‘',forSale:forSale,estimatedAcquisitionPrice:estAcqPrice,
    _real:true};
}

/* ì‹¤ì œ ì¹˜ê³¼ ë°ì´í„° fetch â€” ì •ì  JSONì—ì„œ ë°˜ê²½ ë‚´ ì¹˜ê³¼ í•„í„°ë§ */
async function fetchRealClinics(lat,lng,radius){
  var data=await loadClinicData();
  if(!data)return null;
  var r=radius||1000;
  var nearby=[];
  for(var i=0;i<data.clinics.length;i++){
    var c=data.clinics[i];
    var d=distM(lat,lng,c.y,c.x);
    if(d<=r){c._dist=d;nearby.push(c)}
  }
  if(nearby.length===0)return null;
  nearby.sort(function(a,b){return a._dist-b._dist});
  /* ìµœëŒ€ 50ê°œ ë°˜í™˜ */
  if(nearby.length>50)nearby=nearby.slice(0,50);
  console.log('[DentalMap] ë°˜ê²½',r+'m ë‚´ ì‹¤ì œ ì¹˜ê³¼:',nearby.length,'ê°œ');
  return nearby.map(function(it,idx){return expandClinic(it,idx)});
}

/* â”€â”€ Region Generation â”€â”€ */
function hashStr(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return Math.abs(h)}
function seededRand(seed,min,max){seed=(seed*9301+49297)%233280;return min+Math.floor((seed/233280)*(max-min+1))}
function distM(lat1,lng1,lat2,lng2){const dLat=(lat2-lat1)*111320;const dLng=(lng2-lng1)*111320*Math.cos((lat1+lat2)/2*Math.PI/180);return Math.sqrt(dLat*dLat+dLng*dLng)}

/* â”€â”€ Commercial Zone Anchors â”€â”€ */
const CZ={
// ì„œìš¸ 25êµ¬
'ê°•ë‚¨êµ¬':[37.4979,127.0276,37.5009,127.0396,37.5140,127.0590,37.5172,127.0391],
'ì„œì´ˆêµ¬':[37.4837,127.0073,37.4920,127.0104,37.5023,127.0252],
'ì†¡íŒŒêµ¬':[37.5048,127.1119,37.5133,127.1001,37.5145,127.0850],
'ê°•ë™êµ¬':[37.5301,127.1238,37.5352,127.1320,37.5260,127.1270],
'ë§ˆí¬êµ¬':[37.5563,126.9237,37.5534,126.9098,37.5664,126.9018],
'ìš©ì‚°êµ¬':[37.5326,126.9906,37.5298,126.9648,37.5340,126.9720],
'ì¢…ë¡œêµ¬':[37.5700,126.9830,37.5735,126.9790,37.5720,126.9920],
'ì˜ë“±í¬êµ¬':[37.5264,126.8963,37.5175,126.9069,37.5228,126.9144],
'ê°•ì„œêµ¬':[37.5510,126.8495,37.5592,126.8370,37.5470,126.8560],
'êµ¬ë¡œêµ¬':[37.5033,126.8828,37.4954,126.8874,37.5081,126.8890],
'ê´€ì•…êµ¬':[37.4784,126.9516,37.4815,126.9527,37.4840,126.9483],
'ë™ì‘êµ¬':[37.5083,126.9389,37.5124,126.9393,37.5048,126.9420],
'ì„±ë™êµ¬':[37.5445,127.0564,37.5634,127.0369,37.5475,127.0430],
'ê´‘ì§„êµ¬':[37.5385,127.0823,37.5348,127.0746,37.5420,127.0810],
'ë™ëŒ€ë¬¸êµ¬':[37.5744,127.0396,37.5712,127.0470,37.5690,127.0380],
'ì¤‘ë‘êµ¬':[37.6063,127.0926,37.5987,127.0793,37.6020,127.0880],
'ì„±ë¶êµ¬':[37.5894,127.0164,37.5929,127.0196,37.5860,127.0230],
'ê°•ë¶êµ¬':[37.6397,127.0253,37.6340,127.0270,37.6365,127.0230],
'ë„ë´‰êµ¬':[37.6688,127.0471,37.6530,127.0432,37.6580,127.0475],
'ë…¸ì›êµ¬':[37.6542,127.0568,37.6559,127.0625,37.6490,127.0540],
'ì€í‰êµ¬':[37.6027,126.9291,37.6165,126.9224,37.6095,126.9315],
'ì„œëŒ€ë¬¸êµ¬':[37.5791,126.9368,37.5598,126.9430,37.5720,126.9460],
'ì–‘ì²œêµ¬':[37.5170,126.8664,37.5166,126.8568,37.5208,126.8690],
'ê¸ˆì²œêµ¬':[37.4569,126.8955,37.4530,126.9020,37.4600,126.8930],
// ë¶€ì‚° 13êµ¬
'í•´ìš´ëŒ€êµ¬':[35.1631,129.1636,35.1594,129.1600,35.1715,129.1746],
'ë¶€ì‚°ì§„êµ¬':[35.1631,129.0533,35.1572,129.0588,35.1608,129.0621],
'ë™ë˜êµ¬':[35.2050,129.0858,35.1985,129.0805,35.2020,129.0920],
'ì‚¬ìƒêµ¬':[35.1526,128.9912,35.1510,128.9830,35.1570,128.9950],
'ì—°ì œêµ¬':[35.1762,129.0801,35.1800,129.0770,35.1730,129.0830],
'ìˆ˜ì˜êµ¬':[35.1458,129.1133,35.1420,129.1100,35.1490,129.1180],
'ê¸ˆì •êµ¬':[35.2432,129.0913,35.2430,129.0850,35.2380,129.0920],
'ì‚¬í•˜êµ¬':[35.1046,128.9747,35.1080,128.9710,35.1015,128.9780],
// ëŒ€ì „ 5êµ¬
'ëŒ€ì „_ì¤‘êµ¬':[36.3275,127.4268,36.3310,127.4285,36.3240,127.4200,36.3285,127.4230],
'ëŒ€ì „_ì„œêµ¬':[36.3515,127.3785,36.3490,127.3860,36.3605,127.3710,36.3548,127.3820],
'ëŒ€ì „_ë™êµ¬':[36.3326,127.4450,36.3290,127.4380,36.3350,127.4500],
'ìœ ì„±êµ¬':[36.3540,127.3388,36.3622,127.3505,36.3575,127.3460],
'ëŒ€ë•êµ¬':[36.3535,127.4258,36.3480,127.4200,36.3510,127.4310],
// ì¸ì²œ 7êµ¬
'ì¸ì²œ_ì¤‘êµ¬':[37.4738,126.6217,37.4760,126.6260,37.4710,126.6190],
'ë‚¨ë™êµ¬':[37.4488,126.7369,37.4460,126.7310,37.4520,126.7420],
'ë¶€í‰êµ¬':[37.5076,126.7219,37.5049,126.7250,37.5100,126.7180],
'ì—°ìˆ˜êµ¬':[37.4101,126.6783,37.4065,126.6810,37.4130,126.6750],
'ì¸ì²œ_ì„œêµ¬':[37.5451,126.6760,37.5410,126.6710,37.5480,126.6800],
'ë¯¸ì¶”í™€êµ¬':[37.4421,126.6993,37.4390,126.7020,37.4450,126.6960],
'ê³„ì–‘êµ¬':[37.5372,126.7376,37.5340,126.7350,37.5400,126.7410],
// ëŒ€êµ¬ 7êµ¬
'ëŒ€êµ¬_ì¤‘êµ¬':[35.8694,128.6064,35.8670,128.6100,35.8720,128.6030],
'ìˆ˜ì„±êµ¬':[35.8583,128.6315,35.8560,128.6350,35.8610,128.6280],
'ë‹¬ì„œêµ¬':[35.8299,128.5327,35.8260,128.5370,35.8340,128.5290],
'ëŒ€êµ¬_ë¶êµ¬':[35.8858,128.5828,35.8820,128.5860,35.8890,128.5800],
'ëŒ€êµ¬_ë™êµ¬':[35.8864,128.6355,35.8830,128.6390,35.8900,128.6320],
'ëŒ€êµ¬_ì„œêµ¬':[35.8718,128.5592,35.8690,128.5620,35.8750,128.5560],
'ëŒ€êµ¬_ë‚¨êµ¬':[35.8460,128.5975,35.8430,128.6010,35.8490,128.5940],
// ê´‘ì£¼ 5êµ¬
'ê´‘ì£¼_ì„œêµ¬':[35.1522,126.8895,35.1490,126.8850,35.1550,126.8920],
'ê´‘ì£¼_ë¶êµ¬':[35.1744,126.9120,35.1710,126.9080,35.1770,126.9160],
'ê´‘ì£¼_ë‚¨êµ¬':[35.1326,126.9024,35.1300,126.9060,35.1360,126.8990],
'ê´‘ì£¼_ë™êµ¬':[35.1461,126.9231,35.1430,126.9200,35.1490,126.9260],
'ê´‘ì‚°êµ¬':[35.1395,126.7938,35.1360,126.7900,35.1430,126.7970],
// ìš¸ì‚° 5êµ¬
'ìš¸ì‚°_ë‚¨êµ¬':[35.5444,129.3303,35.5420,129.3260,35.5470,129.3340],
'ìš¸ì‚°_ì¤‘êµ¬':[35.5694,129.3327,35.5670,129.3370,35.5720,129.3290],
'ìš¸ì‚°_ë™êµ¬':[35.5050,129.4166,35.5020,129.4130,35.5080,129.4200],
'ìš¸ì‚°_ë¶êµ¬':[35.5826,129.3610,35.5800,129.3580,35.5850,129.3640],
'ìš¸ì£¼êµ°':[35.5224,129.2441,35.5200,129.2480,35.5250,129.2400],
// ìˆ˜ì› 4êµ¬
'ì˜í†µêµ¬':[37.2596,127.0462,37.2554,127.0520,37.2640,127.0430],
'íŒ”ë‹¬êµ¬':[37.2829,127.0204,37.2790,127.0250,37.2860,127.0170],
'ì¥ì•ˆêµ¬':[37.3038,127.0101,37.3000,127.0140,37.3070,127.0060],
'ê¶Œì„ êµ¬':[37.2572,126.9719,37.2540,126.9760,37.2600,126.9680],
// ì„±ë‚¨ 3êµ¬
'ë¶„ë‹¹êµ¬':[37.3825,127.1188,37.3780,127.1230,37.3870,127.1150],
'ìˆ˜ì •êµ¬':[37.4504,127.1457,37.4470,127.1490,37.4540,127.1420],
'ì¤‘ì›êµ¬':[37.4317,127.1372,37.4280,127.1410,37.4350,127.1340],
// ê³ ì–‘ 3êµ¬
'ì¼ì‚°ë™êµ¬':[37.6586,126.7742,37.6550,126.7780,37.6620,126.7700],
'ì¼ì‚°ì„œêµ¬':[37.6756,126.7513,37.6720,126.7550,37.6790,126.7480],
'ë•ì–‘êµ¬':[37.6376,126.8320,37.6340,126.8360,37.6410,126.8280],
// ìš©ì¸ 3êµ¬
'ìˆ˜ì§€êµ¬':[37.3219,127.0981,37.3250,127.0940,37.3190,127.1020],
'ê¸°í¥êµ¬':[37.2802,127.1151,37.2770,127.1190,37.2840,127.1110],
'ì²˜ì¸êµ¬':[37.2342,127.2019,37.2310,127.2060,37.2370,127.1980],
// ì°½ì› 5êµ¬
'ì„±ì‚°êµ¬':[35.1989,128.7119,35.1960,128.7090,35.2020,128.7150],
'ì˜ì°½êµ¬':[35.2538,128.6389,35.2500,128.6420,35.2570,128.6350],
'ë§ˆì‚°í•©í¬êµ¬':[35.1855,128.5683,35.1830,128.5720,35.1880,128.5650],
'ë§ˆì‚°íšŒì›êµ¬':[35.2215,128.5813,35.2180,128.5850,35.2250,128.5780],
'ì§„í•´êµ¬':[35.1336,128.7107,35.1310,128.7070,35.1360,128.7140],
// ì²­ì£¼ 4êµ¬
'í¥ë•êµ¬':[36.6373,127.4329,36.6340,127.4370,36.6400,127.4290],
'ì„œì›êµ¬':[36.6093,127.4712,36.6060,127.4750,36.6120,127.4680],
'ìƒë‹¹êµ¬':[36.6539,127.4901,36.6500,127.4940,36.6570,127.4860],
'ì²­ì›êµ¬':[36.6952,127.4879,36.6920,127.4920,36.6980,127.4840],
// ì „ì£¼ 2êµ¬
'ì™„ì‚°êµ¬':[35.8123,127.1365,35.8090,127.1400,35.8150,127.1330],
'ë•ì§„êµ¬':[35.8423,127.1344,35.8390,127.1380,35.8450,127.1310],
// ì²œì•ˆ 2êµ¬
'ì„œë¶êµ¬':[36.8502,127.1435,36.8470,127.1470,36.8530,127.1400],
'ë™ë‚¨êµ¬':[36.7889,127.1652,36.7860,127.1690,36.7920,127.1620],
// ì•ˆì‚° 2êµ¬
'ìƒë¡êµ¬':[37.3004,126.8461,37.2970,126.8500,37.3040,126.8420],
'ë‹¨ì›êµ¬':[37.3184,126.7962,37.3150,126.8000,37.3220,126.7930],
// ì•ˆì–‘ 2êµ¬
'ë§Œì•ˆêµ¬':[37.3866,126.9327,37.3830,126.9360,37.3900,126.9300],
'ë™ì•ˆêµ¬':[37.3929,126.9517,37.3900,126.9550,37.3960,126.9480],
// ì œì£¼
'ì œì£¼ì‹œ':[33.5100,126.5219,33.5120,126.5170,33.5070,126.5260],
'ì„œê·€í¬ì‹œ':[33.2532,126.5597,33.2510,126.5630,33.2560,126.5560],
// í¬í•­ 2êµ¬
'í¬í•­_ë‚¨êµ¬':[35.9987,129.3652,35.9960,129.3690,36.0010,129.3620],
'í¬í•­_ë¶êµ¬':[36.0441,129.3719,36.0410,129.3750,36.0470,129.3690],
// ë¶€ì‚° ì¶”ê°€ (ì¤‘êµ¬,ì„œêµ¬,ë¶êµ¬,ë‚¨êµ¬,ê°•ì„œêµ¬)
'ë¶€ì‚°_ì¤‘êµ¬':[35.1060,129.0325,35.1030,129.0360,35.1090,129.0290],
'ë¶€ì‚°_ì„œêµ¬':[35.0982,129.0244,35.0950,129.0280,35.1010,129.0210],
'ë¶€ì‚°_ë¶êµ¬':[35.1974,129.0312,35.1940,129.0350,35.2000,129.0280],
'ë¶€ì‚°_ë‚¨êµ¬':[35.1368,129.0845,35.1340,129.0880,35.1400,129.0810],
'ë¶€ì‚°_ê°•ì„œêµ¬':[35.2121,128.9809,35.2090,128.9840,35.2150,128.9770],
// ì„œìš¸ ì¤‘êµ¬
'ì„œìš¸_ì¤‘êµ¬':[37.5641,126.9979,37.5590,126.9860,37.5612,127.0030],
// ì£¼ìš” ë„ì‹œ (êµ¬ ì—†ìŒ)
'ê¹€í•´':[35.2341,128.8812,35.2285,128.8894,35.2310,128.8850],
'í‰íƒ':[36.9921,127.0866,36.9890,127.0900,36.9950,127.0830],
'íŒŒì£¼':[37.7599,126.7801,37.7570,126.7830,37.7630,126.7770],
'ì‹œí¥':[37.3800,126.8028,37.3770,126.8060,37.3830,126.8000],
'í™”ì„±':[37.1994,126.8313,37.1960,126.8350,37.2020,126.8280],
'ê¹€í¬':[37.6152,126.7156,37.6120,126.7190,37.6180,126.7120],
'ê´‘ëª…':[37.4786,126.8645,37.4760,126.8680,37.4810,126.8610],
'êµ°í¬':[37.3614,126.9352,37.3580,126.9390,37.3650,126.9320],
'í•˜ë‚¨':[37.5393,127.2147,37.5360,127.2180,37.5420,127.2110],
'ì–‘ì‚°':[35.3350,129.0372,35.3320,129.0400,35.3380,129.0340],
'êµ¬ë¯¸':[36.1197,128.3440,36.1170,128.3480,36.1230,128.3400],
'ì¶˜ì²œ':[37.8813,127.7300,37.8780,127.7340,37.8840,127.7260],
'ì›ì£¼':[37.3423,127.9202,37.3390,127.9240,37.3450,127.9170],
'ê°•ë¦‰':[37.7519,128.8761,37.7490,128.8800,37.7550,128.8720],
'ì—¬ìˆ˜':[34.7604,127.6622,34.7580,127.6660,34.7630,127.6590],
'ìˆœì²œ':[34.9506,127.4872,34.9480,127.4910,34.9530,127.4840],
'ëª©í¬':[34.8118,126.3922,34.8090,126.3960,34.8150,126.3890],
'ìµì‚°':[35.9483,126.9577,35.9450,126.9610,35.9510,126.9540],
'êµ°ì‚°':[35.9674,126.7369,35.9650,126.7400,35.9700,126.7340],
'ê²½ì£¼':[35.8562,129.2247,35.8530,129.2280,35.8590,129.2210],
'ê±°ì œ':[34.8806,128.6213,34.8780,128.6250,34.8830,128.6180],
'ì–‘ì£¼':[37.7854,127.0456,37.7820,127.0490,37.7880,127.0420],
'ì˜ì •ë¶€':[37.7381,127.0337,37.7350,127.0370,37.7410,127.0300],
'ë‚¨ì–‘ì£¼':[37.6360,127.2163,37.6330,127.2200,37.6390,127.2130],
'ì´ì²œ':[37.2720,127.4348,37.2690,127.4380,37.2750,127.4310],
'ì˜¤ì‚°':[37.1498,127.0697,37.1470,127.0730,37.1530,127.0660],
'ì¶©ì£¼':[36.9910,127.9259,36.9880,127.9290,36.9940,127.9220],
'ì•„ì‚°':[36.7899,127.0018,36.7870,127.0050,36.7930,126.9990],
'ì„œì‚°':[36.7845,126.4503,36.7820,126.4540,36.7870,126.4470],
'ì„¸ì¢…':[36.4801,126.9270,36.4770,126.9310,36.4830,126.9230],
'í™ëŒ€':[37.5563,126.9237,37.5540,126.9260,37.5580,126.9210],
'ì ì‹¤':[37.5133,127.1001,37.5110,127.1030,37.5160,127.0970],
'ê°•ë‚¨':[37.4979,127.0276,37.5009,127.0396,37.5140,127.0590],
'íŒêµ':[37.3947,127.1112,37.3920,127.1140,37.3970,127.1080],
'ê´‘ì£¼ì‹œ':[37.4095,127.2551,37.4070,127.2580,37.4120,127.2520]
};
function getCommercialAnchors(r){
  const gu=r.sigungu||'';
  const sc=(r.sido||'').replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„|ë„$/g,'');
  const amb=['ì¤‘êµ¬','ì„œêµ¬','ë™êµ¬','ë‚¨êµ¬','ë¶êµ¬'];
  let key=gu;
  if(amb.includes(gu)) key=sc+'_'+gu;
  let arr=CZ[key];
  if(!arr){const g2=gu.replace(/^.+ì‹œ\s*/,'');arr=CZ[g2]||CZ[gu]||CZ[sc]}
  if(!arr||arr.length<2)return null;
  const anchors=[];for(let i=0;i<arr.length;i+=2)anchors.push({lat:arr[i],lng:arr[i+1]});
  return anchors;
}

/* â”€â”€ ì¹´ì¹´ì˜¤ ì—­ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ê³µì› ê°ì§€ â†’ ìƒì—…ê±´ë¬¼ ìŠ¤ëƒ… â”€â”€ */
async function ensureCommercialLocation(lat,lng){
  if(typeof kakao==='undefined'||!kakao.maps)return{lat:lat,lng:lng,snapped:false};
  return new Promise(function(resolve){
    try{
      kakao.maps.load(function(){
        try{
          var geocoder=new kakao.maps.services.Geocoder();
          /* 1ë‹¨ê³„: ì—­ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ë„ë¡œëª…ì£¼ì†Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ */
          geocoder.coord2Address(lng,lat,function(result,status){
            console.log('[DentalMap] ì—­ì§€ì˜¤ì½”ë”©:',status,result&&result[0]?JSON.stringify({road:result[0].road_address?result[0].road_address.address_name:'ì—†ìŒ',jibun:result[0].address?result[0].address.address_name:'ì—†ìŒ'}):'ê²°ê³¼ì—†ìŒ');
            var hasRoad=status===kakao.maps.services.Status.OK&&result&&result[0]&&result[0].road_address;
            if(hasRoad){
              console.log('[DentalMap] ë„ë¡œëª…ì£¼ì†Œ ìˆìŒ â†’ ìƒì—…ì§€ í™•ì¸');
              resolve({lat:lat,lng:lng,snapped:false});return}
            /* 2ë‹¨ê³„: ë„ë¡œëª…ì£¼ì†Œ ì—†ìŒ â†’ ê³µì›/ë…¹ì§€ ê°€ëŠ¥ì„± â†’ ê°€ì¥ ê°€ê¹Œìš´ ìŒì‹ì ìœ¼ë¡œ ìŠ¤ëƒ… */
            console.log('[DentalMap] ë„ë¡œëª…ì£¼ì†Œ ì—†ìŒ â†’ ìƒì—…ê±´ë¬¼ ìŠ¤ëƒ… ì‹œë„');
            var ps=new kakao.maps.services.Places();
            ps.categorySearch('FD6',function(data,st2){
              if(st2===kakao.maps.services.Status.OK&&data.length){
                console.log('[DentalMap] ìŠ¤ëƒ…: '+data[0].place_name+' ('+data[0].y+','+data[0].x+')');
                resolve({lat:parseFloat(data[0].y),lng:parseFloat(data[0].x),snapped:true,name:data[0].place_name});return}
              /* ìŒì‹ì  ì—†ìœ¼ë©´ í¸ì˜ì  */
              ps.categorySearch('CS2',function(data2,st3){
                if(st3===kakao.maps.services.Status.OK&&data2.length){
                  console.log('[DentalMap] ìŠ¤ëƒ…(í¸ì˜ì ): '+data2[0].place_name);
                  resolve({lat:parseFloat(data2[0].y),lng:parseFloat(data2[0].x),snapped:true,name:data2[0].place_name});return}
                console.log('[DentalMap] ìŠ¤ëƒ… ì‹¤íŒ¨ â€” ì›ë³¸ ì¢Œí‘œ ìœ ì§€');
                resolve({lat:lat,lng:lng,snapped:false});
              },{location:new kakao.maps.LatLng(lat,lng),radius:500,sort:kakao.maps.services.SortBy.DISTANCE});
            },{location:new kakao.maps.LatLng(lat,lng),radius:500,sort:kakao.maps.services.SortBy.DISTANCE});
          });
        }catch(e){console.error('[DentalMap] ensureCommercial ì˜¤ë¥˜:',e);resolve({lat:lat,lng:lng,snapped:false})}
      });
    }catch(e){resolve({lat:lat,lng:lng,snapped:false})}
  });
}
/* â”€â”€ ì¹´ì¹´ì˜¤ ì§€ì˜¤ì½”ë”© (í‚¤ì›Œë“œ ê²€ìƒ‰) â”€â”€ */
async function kakaoGeocode(query){
  if(typeof kakao==='undefined'){console.warn('[DentalMap] kakao SDK ë¯¸ë¡œë“œ');return null}
  if(!kakao.maps){console.warn('[DentalMap] kakao.maps ì—†ìŒ');return null}
  return new Promise(function(resolve){
    try{
      kakao.maps.load(function(){
        try{
          var ps=new kakao.maps.services.Places();
          ps.keywordSearch(query,function(data,status){
            console.log('[DentalMap] ì¹´ì¹´ì˜¤ ê²€ìƒ‰ ìƒíƒœ:',status,'ê²°ê³¼:',data?data.length:0);
            if(status!==kakao.maps.services.Status.OK||!data.length){resolve(null);return}
            var place=data[0];
            var addr=place.address_name||'';
            var parts=addr.split(' ');
            resolve({lat:parseFloat(place.y),lng:parseFloat(place.x),sido:parts[0]||'',sigungu:parts[1]||'',placeName:place.place_name,address:addr});
          });
        }catch(e){console.error('[DentalMap] ì¹´ì¹´ì˜¤ ê²€ìƒ‰ ì˜¤ë¥˜:',e);resolve(null)}
      });
    }catch(e){console.error('[DentalMap] kakao.maps.load ì˜¤ë¥˜:',e);resolve(null)}
  });
}

function resolveGeoFromName(name){
  const areas=[
    {kw:['ëŒ€ì „'],lat:36.3504,lng:127.3845,sido:'ëŒ€ì „ê´‘ì—­ì‹œ',
      gu:[{kw:'ì¤‘êµ¬',lat:36.3254,lng:127.4214},{kw:'ì„œêµ¬',lat:36.3555,lng:127.3835},{kw:'ë™êµ¬',lat:36.3121,lng:127.4549},{kw:'ìœ ì„±êµ¬',lat:36.3622,lng:127.3561},{kw:'ëŒ€ë•êµ¬',lat:36.3467,lng:127.4153}]},
    {kw:['ì„œìš¸'],lat:37.5665,lng:126.978,sido:'ì„œìš¸íŠ¹ë³„ì‹œ',
      gu:[{kw:'ê°•ë‚¨êµ¬',lat:37.5172,lng:127.0473},{kw:'ì„œì´ˆêµ¬',lat:37.4837,lng:127.0324},{kw:'ì†¡íŒŒêµ¬',lat:37.5145,lng:127.1050},{kw:'ê°•ë™êµ¬',lat:37.5301,lng:127.1238},{kw:'ë§ˆí¬êµ¬',lat:37.5664,lng:126.9018},{kw:'ìš©ì‚°êµ¬',lat:37.5326,lng:126.9906},{kw:'ì¢…ë¡œêµ¬',lat:37.5735,lng:126.9790},{kw:'ì¤‘êµ¬',lat:37.5641,lng:126.9979},{kw:'ì˜ë“±í¬êµ¬',lat:37.5264,lng:126.8963},{kw:'ê°•ì„œêµ¬',lat:37.5510,lng:126.8495},{kw:'êµ¬ë¡œêµ¬',lat:37.4954,lng:126.8874},{kw:'ê´€ì•…êµ¬',lat:37.4784,lng:126.9516},{kw:'ë™ì‘êµ¬',lat:37.5124,lng:126.9393},{kw:'ì„±ë™êµ¬',lat:37.5634,lng:127.0369},{kw:'ê´‘ì§„êµ¬',lat:37.5385,lng:127.0823},{kw:'ë™ëŒ€ë¬¸êµ¬',lat:37.5744,lng:127.0396},{kw:'ì¤‘ë‘êµ¬',lat:37.6063,lng:127.0926},{kw:'ì„±ë¶êµ¬',lat:37.5894,lng:127.0164},{kw:'ê°•ë¶êµ¬',lat:37.6397,lng:127.0253},{kw:'ë„ë´‰êµ¬',lat:37.6688,lng:127.0471},{kw:'ë…¸ì›êµ¬',lat:37.6542,lng:127.0568},{kw:'ì€í‰êµ¬',lat:37.6027,lng:126.9291},{kw:'ì„œëŒ€ë¬¸êµ¬',lat:37.5791,lng:126.9368},{kw:'ì–‘ì²œêµ¬',lat:37.5170,lng:126.8664},{kw:'ê¸ˆì²œêµ¬',lat:37.4569,lng:126.8955}]},
    {kw:['ë¶€ì‚°'],lat:35.1796,lng:129.0756,sido:'ë¶€ì‚°ê´‘ì—­ì‹œ',
      gu:[{kw:'í•´ìš´ëŒ€êµ¬',lat:35.1631,lng:129.1636},{kw:'ë¶€ì‚°ì§„êµ¬',lat:35.1631,lng:129.0533},{kw:'ë™ë˜êµ¬',lat:35.2050,lng:129.0858},{kw:'ë‚¨êµ¬',lat:35.1368,lng:129.0845},{kw:'ì¤‘êµ¬',lat:35.1060,lng:129.0325},{kw:'ì„œêµ¬',lat:35.0982,lng:129.0244},{kw:'ë¶êµ¬',lat:35.1974,lng:129.0312},{kw:'ì‚¬ìƒêµ¬',lat:35.1526,lng:128.9912},{kw:'ì—°ì œêµ¬',lat:35.1762,lng:129.0801},{kw:'ìˆ˜ì˜êµ¬',lat:35.1458,lng:129.1133},{kw:'ê¸ˆì •êµ¬',lat:35.2432,lng:129.0913},{kw:'ì‚¬í•˜êµ¬',lat:35.1046,lng:128.9747},{kw:'ê°•ì„œêµ¬',lat:35.2121,lng:128.9809}]},
    {kw:['ì¸ì²œ'],lat:37.4563,lng:126.7052,sido:'ì¸ì²œê´‘ì—­ì‹œ',
      gu:[{kw:'ë‚¨ë™êµ¬',lat:37.4488,lng:126.7369},{kw:'ë¶€í‰êµ¬',lat:37.5076,lng:126.7219},{kw:'ì—°ìˆ˜êµ¬',lat:37.4101,lng:126.6783},{kw:'ì„œêµ¬',lat:37.5451,lng:126.6760},{kw:'ì¤‘êµ¬',lat:37.4738,lng:126.6217},{kw:'ë¯¸ì¶”í™€êµ¬',lat:37.4421,lng:126.6993},{kw:'ê³„ì–‘êµ¬',lat:37.5372,lng:126.7376}]},
    {kw:['ëŒ€êµ¬'],lat:35.8714,lng:128.6014,sido:'ëŒ€êµ¬ê´‘ì—­ì‹œ',
      gu:[{kw:'ì¤‘êµ¬',lat:35.8694,lng:128.6064},{kw:'ìˆ˜ì„±êµ¬',lat:35.8583,lng:128.6315},{kw:'ë‹¬ì„œêµ¬',lat:35.8299,lng:128.5327},{kw:'ë¶êµ¬',lat:35.8858,lng:128.5828},{kw:'ë™êµ¬',lat:35.8864,lng:128.6355},{kw:'ì„œêµ¬',lat:35.8718,lng:128.5592},{kw:'ë‚¨êµ¬',lat:35.8460,lng:128.5975}]},
    {kw:['ê´‘ì£¼'],lat:35.1595,lng:126.8526,sido:'ê´‘ì£¼ê´‘ì—­ì‹œ',
      gu:[{kw:'ì„œêµ¬',lat:35.1522,lng:126.8895},{kw:'ë¶êµ¬',lat:35.1744,lng:126.9120},{kw:'ë‚¨êµ¬',lat:35.1326,lng:126.9024},{kw:'ë™êµ¬',lat:35.1461,lng:126.9231},{kw:'ê´‘ì‚°êµ¬',lat:35.1395,lng:126.7938}]},
    {kw:['ìš¸ì‚°'],lat:35.5384,lng:129.3114,sido:'ìš¸ì‚°ê´‘ì—­ì‹œ',
      gu:[{kw:'ë‚¨êµ¬',lat:35.5444,lng:129.3303},{kw:'ì¤‘êµ¬',lat:35.5694,lng:129.3327},{kw:'ë™êµ¬',lat:35.5050,lng:129.4166},{kw:'ë¶êµ¬',lat:35.5826,lng:129.3610},{kw:'ìš¸ì£¼êµ°',lat:35.5224,lng:129.2441}]},
    {kw:['ì„¸ì¢…'],lat:36.4801,lng:126.9270,sido:'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',gu:[]},
    {kw:['ìˆ˜ì›'],lat:37.2636,lng:127.0286,sido:'ê²½ê¸°ë„',gu:[{kw:'ì˜í†µêµ¬',lat:37.2596,lng:127.0462},{kw:'íŒ”ë‹¬êµ¬',lat:37.2829,lng:127.0204},{kw:'ì¥ì•ˆêµ¬',lat:37.3038,lng:127.0101},{kw:'ê¶Œì„ êµ¬',lat:37.2572,lng:126.9719}]},
    {kw:['ì„±ë‚¨'],lat:37.4200,lng:127.1267,sido:'ê²½ê¸°ë„',gu:[{kw:'ë¶„ë‹¹êµ¬',lat:37.3825,lng:127.1188},{kw:'ìˆ˜ì •êµ¬',lat:37.4504,lng:127.1457},{kw:'ì¤‘ì›êµ¬',lat:37.4317,lng:127.1372}]},
    {kw:['ê³ ì–‘'],lat:37.6584,lng:126.8320,sido:'ê²½ê¸°ë„',gu:[{kw:'ì¼ì‚°ë™êµ¬',lat:37.6586,lng:126.7742},{kw:'ì¼ì‚°ì„œêµ¬',lat:37.6756,lng:126.7513},{kw:'ë•ì–‘êµ¬',lat:37.6376,lng:126.8320}]},
    {kw:['ìš©ì¸'],lat:37.2411,lng:127.1775,sido:'ê²½ê¸°ë„',gu:[{kw:'ìˆ˜ì§€êµ¬',lat:37.3219,lng:127.0981},{kw:'ê¸°í¥êµ¬',lat:37.2802,lng:127.1151},{kw:'ì²˜ì¸êµ¬',lat:37.2342,lng:127.2019}]},
    {kw:['ì°½ì›'],lat:35.2280,lng:128.6811,sido:'ê²½ìƒë‚¨ë„',gu:[{kw:'ì„±ì‚°êµ¬',lat:35.1989,lng:128.7119},{kw:'ì˜ì°½êµ¬',lat:35.2538,lng:128.6389},{kw:'ë§ˆì‚°í•©í¬êµ¬',lat:35.1855,lng:128.5683},{kw:'ë§ˆì‚°íšŒì›êµ¬',lat:35.2215,lng:128.5813},{kw:'ì§„í•´êµ¬',lat:35.1336,lng:128.7107}]},
    {kw:['ì²­ì£¼'],lat:36.6424,lng:127.4890,sido:'ì¶©ì²­ë¶ë„',gu:[{kw:'í¥ë•êµ¬',lat:36.6373,lng:127.4329},{kw:'ì„œì›êµ¬',lat:36.6093,lng:127.4712},{kw:'ìƒë‹¹êµ¬',lat:36.6539,lng:127.4901},{kw:'ì²­ì›êµ¬',lat:36.6952,lng:127.4879}]},
    {kw:['ì „ì£¼'],lat:35.8242,lng:127.1480,sido:'ì „ë¼ë¶ë„',gu:[{kw:'ì™„ì‚°êµ¬',lat:35.8123,lng:127.1365},{kw:'ë•ì§„êµ¬',lat:35.8423,lng:127.1344}]},
    {kw:['ì²œì•ˆ'],lat:36.8151,lng:127.1139,sido:'ì¶©ì²­ë‚¨ë„',gu:[{kw:'ì„œë¶êµ¬',lat:36.8502,lng:127.1435},{kw:'ë™ë‚¨êµ¬',lat:36.7889,lng:127.1652}]},
    {kw:['ì•ˆì‚°'],lat:37.3219,lng:126.8309,sido:'ê²½ê¸°ë„',gu:[{kw:'ìƒë¡êµ¬',lat:37.3004,lng:126.8461},{kw:'ë‹¨ì›êµ¬',lat:37.3184,lng:126.7962}]},
    {kw:['ì•ˆì–‘'],lat:37.3943,lng:126.9568,sido:'ê²½ê¸°ë„',gu:[{kw:'ë§Œì•ˆêµ¬',lat:37.3866,lng:126.9327},{kw:'ë™ì•ˆêµ¬',lat:37.3929,lng:126.9517}]},
    {kw:['ì œì£¼'],lat:33.4996,lng:126.5312,sido:'ì œì£¼íŠ¹ë³„ìì¹˜ë„',gu:[{kw:'ì œì£¼ì‹œ',lat:33.5100,lng:126.5219},{kw:'ì„œê·€í¬ì‹œ',lat:33.2532,lng:126.5597}]},
    {kw:['í¬í•­'],lat:36.0190,lng:129.3435,sido:'ê²½ìƒë¶ë„',gu:[{kw:'ë‚¨êµ¬',lat:35.9987,lng:129.3652},{kw:'ë¶êµ¬',lat:36.0441,lng:129.3719}]},
    {kw:['ê¹€í•´'],lat:35.2285,lng:128.8894,sido:'ê²½ìƒë‚¨ë„',gu:[]},
    {kw:['í‰íƒ'],lat:36.9921,lng:127.0866,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['íŒŒì£¼'],lat:37.7599,lng:126.7801,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ì‹œí¥'],lat:37.3800,lng:126.8028,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['í™”ì„±'],lat:37.1994,lng:126.8313,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ê¹€í¬'],lat:37.6152,lng:126.7156,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ê´‘ëª…'],lat:37.4786,lng:126.8645,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['êµ°í¬'],lat:37.3614,lng:126.9352,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['í•˜ë‚¨'],lat:37.5393,lng:127.2147,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ì–‘ì‚°'],lat:35.3350,lng:129.0372,sido:'ê²½ìƒë‚¨ë„',gu:[]},
    {kw:['êµ¬ë¯¸'],lat:36.1197,lng:128.3440,sido:'ê²½ìƒë¶ë„',gu:[]},
    {kw:['ì¶˜ì²œ'],lat:37.8813,lng:127.7300,sido:'ê°•ì›íŠ¹ë³„ìì¹˜ë„',gu:[]},
    {kw:['ì›ì£¼'],lat:37.3423,lng:127.9202,sido:'ê°•ì›íŠ¹ë³„ìì¹˜ë„',gu:[]},
    {kw:['ê°•ë¦‰'],lat:37.7519,lng:128.8761,sido:'ê°•ì›íŠ¹ë³„ìì¹˜ë„',gu:[]},
    {kw:['ì—¬ìˆ˜'],lat:34.7604,lng:127.6622,sido:'ì „ë¼ë‚¨ë„',gu:[]},
    {kw:['ìˆœì²œ'],lat:34.9506,lng:127.4872,sido:'ì „ë¼ë‚¨ë„',gu:[]},
    {kw:['ëª©í¬'],lat:34.8118,lng:126.3922,sido:'ì „ë¼ë‚¨ë„',gu:[]},
    {kw:['ìµì‚°'],lat:35.9483,lng:126.9577,sido:'ì „ë¼ë¶ë„',gu:[]},
    {kw:['êµ°ì‚°'],lat:35.9674,lng:126.7369,sido:'ì „ë¼ë¶ë„',gu:[]},
    {kw:['ê²½ì£¼'],lat:35.8562,lng:129.2247,sido:'ê²½ìƒë¶ë„',gu:[]},
    {kw:['ê±°ì œ'],lat:34.8806,lng:128.6213,sido:'ê²½ìƒë‚¨ë„',gu:[]},
    {kw:['ì–‘ì£¼'],lat:37.7854,lng:127.0456,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ì˜ì •ë¶€'],lat:37.7381,lng:127.0337,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ë‚¨ì–‘ì£¼'],lat:37.6360,lng:127.2163,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ì´ì²œ'],lat:37.2720,lng:127.4348,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ì˜¤ì‚°'],lat:37.1498,lng:127.0697,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ê´‘ì£¼ì‹œ','ê²½ê¸° ê´‘ì£¼'],lat:37.4095,lng:127.2551,sido:'ê²½ê¸°ë„',gu:[]},
    {kw:['ì¶©ì£¼'],lat:36.9910,lng:127.9259,sido:'ì¶©ì²­ë¶ë„',gu:[]},
    {kw:['ì•„ì‚°'],lat:36.7899,lng:127.0018,sido:'ì¶©ì²­ë‚¨ë„',gu:[]},
    {kw:['ì„œì‚°'],lat:36.7845,lng:126.4503,sido:'ì¶©ì²­ë‚¨ë„',gu:[]},
    {kw:['í™ëŒ€','í™ëŒ€ì…êµ¬'],lat:37.5563,lng:126.9237,sido:'ì„œìš¸íŠ¹ë³„ì‹œ',gu:[]},
    {kw:['ì ì‹¤'],lat:37.5133,lng:127.1001,sido:'ì„œìš¸íŠ¹ë³„ì‹œ',gu:[]},
    {kw:['ê°•ë‚¨'],lat:37.4979,lng:127.0276,sido:'ì„œìš¸íŠ¹ë³„ì‹œ',gu:[]},
    {kw:['íŒêµ'],lat:37.3947,lng:127.1112,sido:'ê²½ê¸°ë„',gu:[]}
  ];
  let baseLat=37.5665,baseLng=126.978,sido='',sigungu='';
  for(const a of areas){
    const cityMatch=a.kw.some(k=>name.includes(k));
    if(cityMatch){
      baseLat=a.lat;baseLng=a.lng;sido=a.sido;
      for(const g of a.gu){
        if(name.includes(g.kw)){baseLat=g.lat;baseLng=g.lng;sigungu=g.kw;break}
      }
      if(!sigungu&&a.kw[0])sigungu=a.kw[0];
      break;
    }
  }
  return{lat:baseLat,lng:baseLng,sido:sido,sigungu:sigungu};
}
async function generateRegion(name){
  const h=hashStr(name),r=n=>(a,b)=>seededRand(h*n+n,a,b);
  /* 1ì°¨: ì¹´ì¹´ì˜¤ ì§€ì˜¤ì½”ë”©, 2ì°¨: í‚¤ì›Œë“œ ë§¤ì¹­ í´ë°± */
  const kakaoResult=await kakaoGeocode(name).catch(function(){return null});
  const fallback=resolveGeoFromName(name);
  const geo=kakaoResult||fallback;
  /* sido/sigunguê°€ ë¹„ì–´ìˆìœ¼ë©´ fallbackì—ì„œ ë³´ì¶© */
  if(!geo.sido&&fallback.sido)geo.sido=fallback.sido;
  if(!geo.sigungu&&fallback.sigungu)geo.sigungu=fallback.sigungu;
  if(kakaoResult)console.log('[DentalMap] ì¹´ì¹´ì˜¤ ì§€ì˜¤ì½”ë”©:',kakaoResult.placeName,'â†’',kakaoResult.lat,kakaoResult.lng);
  const pop=r(1)(15000,60000),dental=r(2)(3,18),rent=r(3)(6,22),area=r(4)(25,50),wk=r(5)(2,15),bus=r(6)(2,10),fl=r(7)(20000,100000);
  const gr=parseFloat(((r(8)(0,80)-20)/10).toFixed(1)),a20=r(9)(25,48),a40=r(10)(20,35),a60=Math.max(0,100-a20-a40);
  const ps=Math.min(100,Math.max(30,Math.round(pop/600)+r(11)(-5,5))),cs=Math.min(100,Math.max(20,100-dental*5+r(12)(-5,10)));
  const co=Math.min(100,Math.max(20,100-rent*3+r(13)(-5,5))),ac=Math.min(100,Math.max(30,100-wk*4+bus*3+r(14)(-5,5)));
  const gs=Math.min(100,Math.max(20,50+Math.round(gr*8)+r(15)(-5,5)));
  const tot=Math.round(ps*0.25+cs*0.25+co*0.2+ac*0.15+gs*0.15);
  const gd=tot>=80?'A':tot>=70?'B':tot>=60?'C':'D';
  const localStations=geo.sido.includes('ëŒ€ì „')?['ëŒ€ì „ì—­','ìœ ì„±ì˜¨ì²œì—­','íƒ„ë°©ì—­','ì‹œì²­ì—­','ì¤‘ì•™ë¡œì—­','ëŒ€ë™ì—­','ì •ë¶€ì²­ì‚¬ì—­','ê°ˆë§ˆì—­','ì›”í‰ì—­','ìš©ë¬¸ì—­']:
    geo.sido.includes('ë¶€ì‚°')?['ì„œë©´ì—­','í•´ìš´ëŒ€ì—­','ë¶€ì‚°ì—­','ë‚¨í¬ë™ì—­','ì„¼í…€ì‹œí‹°ì—­','ë™ë˜ì—­','ë•ì²œì—­','ì‚¬ìƒì—­','ì—°ì‚°ì—­','ìˆ˜ì˜ì—­']:
    geo.sido.includes('ëŒ€êµ¬')?['ë°˜ì›”ë‹¹ì—­','ë™ëŒ€êµ¬ì—­','ì¤‘ì•™ë¡œì—­','ìˆ˜ì„±êµ¬ì²­ì—­','ë²”ì–´ì—­','ë‹¬ì„œêµ¬ì²­ì—­','ì„±ë‹¹ëª»ì—­','ë‘ë¥˜ì—­','ì¹ ì„±ì‹œì¥ì—­','ë§Œí‰ì—­']:
    geo.sido.includes('ì¸ì²œ')?['ë¶€í‰ì—­','ì¸ì²œì—­','êµ¬ì›”ì—­','ê°„ì„ì—­','ì¸ì²œì‹œì²­ì—­','ì£¼ì•ˆì—­','ì†¡ë„ì—­','ì²­ë¼ì—­','ì‘ì „ì—­','ë¶€ê°œì—­']:
    geo.sido.includes('ê´‘ì£¼')?['ìƒë¬´ì—­','ê¸ˆë‚¨ë¡œì—­','ì–‘ë™ì‹œì¥ì—­','ìš´ì²œì—­','ì†¡ì •ì—­','ì²¨ë‹¨ì—­','í‰ë™ì—­','ë…¹ë™ì—­','í•™ë™ì—­','ë‚¨ê´‘ì£¼ì—­']:
    geo.sido.includes('ìš¸ì‚°')?['ìš¸ì‚°ì—­','íƒœí™”ê°•ì—­','ì‹ ë³µì—­','ë•í•˜ì—­','ë‚¨ì°½ì—­','ìš¸ì‚°KTXì—­','íš¨ë¬¸ì—­','ì•¼ìŒì—­','ì„ ì•”ì—­','ì¥ìƒí¬ì—­']:
    ['ì—­ì‚¼ì—­','ê°•ë‚¨ì—­','í™ëŒ€ì…êµ¬ì—­','ì‹ ì´Œì—­','ì ì‹¤ì—­','ê±´ëŒ€ì…êµ¬ì—­','ì‚¬ë‹¹ì—­','ì™•ì‹­ë¦¬ì—­','ì„ì§€ë¡œì—­','ì¢…ê°ì—­','ì‹ ë¦¼ì—­','íŒêµì—­','ìˆ˜ì›ì—­','ì¸ì²œì—­'];
  const lns=geo.sido.includes('ëŒ€ì „')?['1í˜¸ì„ ','ëŒ€ì „1í˜¸ì„ ']:geo.sido.includes('ë¶€ì‚°')?['1í˜¸ì„ ','2í˜¸ì„ ','3í˜¸ì„ ','4í˜¸ì„ ','ë™í•´ì„ ']:geo.sido.includes('ëŒ€êµ¬')?['1í˜¸ì„ ','2í˜¸ì„ ','3í˜¸ì„ ']:geo.sido.includes('ê´‘ì£¼')?['1í˜¸ì„ ']:['2í˜¸ì„ ','3í˜¸ì„ ','4í˜¸ì„ ','7í˜¸ì„ ','9í˜¸ì„ ','ì‹ ë¶„ë‹¹ì„ ','ê²½ì˜ì¤‘ì•™ì„ ','1í˜¸ì„ ','5í˜¸ì„ ','6í˜¸ì„ '];
  const cg=['A','B','C'];
  /* ì¹´ì¹´ì˜¤ ê²°ê³¼ì¼ ë•Œ jitter ì—†ìŒ (ì •í™•í•œ ì¢Œí‘œ ìœ ì§€) */
  const jitter=kakaoResult?0:0.002;
  return{dong_code:'GEN'+h.toString().slice(0,7).padStart(7,'0'),sido:geo.sido,sigungu:geo.sigungu,dong:name,population:pop,age_20_39_pct:a20,age_40_59_pct:a40,age_60_plus_pct:a60,dental_count:dental,pop_per_clinic:Math.round(pop/dental),avg_rent_pyeong:rent,area_pyeong:area,subway_station:localStations[h%localStations.length],subway_line:lns[h%lns.length],subway_walk_min:wk,bus_stops_500m:bus,daily_floating:fl,pop_growth_rate:gr,commercial_grade:cg[h%cg.length],scores:{population:ps,competition:cs,cost:co,access:ac,growth:gs,total:tot},grade:gd,lat:geo.lat+((h%100)-50)*jitter/50,lng:geo.lng+((h%100)-50)*jitter/50,_generated:true,_kakaoGeo:!!kakaoResult};
}
async function addGeneratedRegion(name){
  const ex=REGIONS.find(r=>r.dong===name&&r._generated);if(ex)return ex;
  const r=await generateRegion(name);REGIONS.push(r);return r;
}

/* â”€â”€ Leaflet Map â”€â”€ */
let analysisMap=null;
function addMapLegend(map,type){
  const legend=L.control({position:'topright'});
  legend.onAdd=function(){
    const div=L.DomUtil.create('div','map-legend');
    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);
    let h='<h4 onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ë²”ë¡€</span><span class="leg-arrow">â–¼</span></h4><div class="leg-body">';
    h+='<div class="leg-section"><div class="leg-title">ë§ˆì»¤</div>';
    if(type==='explore'){
      h+='<div class="leg-row"><div class="leg-dot" style="background:#3b82f6"></div>ì ìˆ˜ 80+ (ë†’ìŒ)</div>';
      h+='<div class="leg-row"><div class="leg-dot" style="background:#22c55e"></div>ì ìˆ˜ 70+ (ì–‘í˜¸)</div>';
      h+='<div class="leg-row"><div class="leg-dot" style="background:#eab308"></div>ì ìˆ˜ 60+ (ë³´í†µ)</div>';
      h+='<div class="leg-row"><div class="leg-dot" style="background:#ef4444"></div>ì ìˆ˜ 60- (ë‚®ìŒ)</div>';
    } else {
      h+='<div class="leg-row"><div class="leg-dot" style="background:#3b82f6"></div>ë¶„ì„ ì¤‘ì‹¬</div>';
    }
    h+='<div class="leg-row"><div class="leg-dot" style="background:#ef4444"></div>ì˜ì—…ì¤‘ ì¹˜ê³¼</div>';
    h+='<div class="leg-row"><div class="leg-dot" style="background:#eab308"></div>íœ´ì—… ì¹˜ê³¼</div>';
    h+='<div class="leg-row"><div class="leg-dot" style="background:#9ca3af"></div>íì—… ì¹˜ê³¼</div>';
    h+='<div class="leg-row"><div class="leg-dot" style="background:linear-gradient(135deg,#f59e0b,#d97706)"></div>ì¶”ì²œ ê°œì› ìœ„ì¹˜</div>';
    h+='</div>';
    h+='<div class="leg-section"><div class="leg-title">ìƒíƒœ ë°°ì§€</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:3px">';
    h+='<span class="leg-badge" style="background:#dcfce7;color:#166534">ì˜ì—…ì¤‘</span>';
    h+='<span class="leg-badge" style="background:#fef9c3;color:#854d0e">íœ´ì—…</span>';
    h+='<span class="leg-badge" style="background:#fee2e2;color:#991b1b">íì—…</span>';
    h+='<span class="leg-badge" style="background:#ede9fe;color:#6d28d9">ì¸ìˆ˜ê°€ëŠ¥</span>';
    h+='</div></div>';
    h+='<div class="leg-section"><div class="leg-title">ê²½ìŸ ìœ„í˜‘ë„</div>';
    h+='<div class="leg-row"><span style="color:#dc2626;font-weight:700;font-size:10px">â—</span> ë†’ìŒ</div>';
    h+='<div class="leg-row"><span style="color:#d97706;font-weight:700;font-size:10px">â—</span> ë³´í†µ</div>';
    h+='<div class="leg-row"><span style="color:#16a34a;font-weight:700;font-size:10px">â—</span> ë‚®ìŒ</div>';
    h+='</div>';
    h+='<div class="leg-section"><div class="leg-title">êµ¬ë¶„ ë°°ì§€</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:3px">';
    h+='<span class="leg-badge" style="background:#e0f2fe;color:#0369a1">ì§„ë£Œë¹„</span>';
    h+='<span class="leg-badge" style="background:#f3e8ff;color:#7c3aed">ì§„ë£Œì‹œê°„</span>';
    h+='<span class="leg-badge" style="background:#f0fdf4;color:#15803d">ì „ë¬¸ë¶„ì•¼</span>';
    h+='</div></div>';
    h+='<div class="leg-section"><div class="leg-title">ë§¤ì¶œÂ·ì¸ìˆ˜</div>';
    h+='<div class="leg-row"><span class="leg-badge" style="background:#ecfdf5;color:#059669">ì—°/ì›”ë§¤ì¶œ</span> ì¶”ì • ë§¤ì¶œ</div>';
    h+='<div class="leg-row"><span class="leg-badge" style="background:#f5f3ff;color:#7c3aed">ì¸ìˆ˜ê°€</span> ì˜ˆìƒ ì¸ìˆ˜ê°€</div>';
    h+='</div>';
    h+='</div>';
    div.innerHTML=h;
    return div;
  };
  legend.addTo(map);
  return legend;
}
function fmtRevKr(v){return v>=10000?((v/10000).toFixed(1)+'ì–µ'):(fmt(v)+'ë§Œ')}
function clinicStatusBadge(c){
  const sc=c.status==='ì˜ì—…ì¤‘'?'background:#dcfce7;color:#166534':c.status==='íœ´ì—…'?'background:#fef9c3;color:#854d0e':'background:#fee2e2;color:#991b1b';
  return '<span style="'+sc+';padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600">'+c.status+'</span>';
}
function clinicForSaleBadge(c){
  return c.forSale?'<span style="background:#ede9fe;color:#6d28d9;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-left:3px">ì¸ìˆ˜ê°€ëŠ¥</span>':'';
}
function nightWeekendLabel(nw){return nw===2?'ì•¼ê°„+ì£¼ë§':nw===1?'ì£¼ë§ì§„ë£Œ':'í‰ì¼ë§Œ'}
function buildClinicPopup(c){
  const r='<div style="min-width:260px;max-width:300px;font-family:Pretendard Variable,sans-serif;font-size:12px">'
    +(c._real?'<div style="background:#ecfdf5;color:#065f46;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;display:inline-block;margin-bottom:4px">ì‹¤ì œ ë°ì´í„°</div>':'')
    +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><b style="font-size:14px;color:#1d4ed8">'+c.name+'</b><div>'+clinicStatusBadge(c)+clinicForSaleBadge(c)+'</div></div>'
    +(c.address?'<div style="font-size:11px;color:#6b7280;margin-bottom:4px">'+c.address+'</div>':'')
    +(c.phone?'<div style="font-size:11px;color:#6b7280;margin-bottom:4px"><a href="tel:'+c.phone+'" style="color:#2563eb;text-decoration:none">'+c.phone+'</a></div>':'')
    +'<div style="margin-bottom:6px;display:flex;flex-wrap:wrap;gap:3px"><span style="background:#fee2e2;color:#dc2626;padding:1px 6px;border-radius:4px;font-size:11px">'+c.type+'</span>'
    +'<span style="background:#e0f2fe;color:#0369a1;padding:1px 6px;border-radius:4px;font-size:11px">'+c.priceLevel+'</span>'
    +'<span style="background:#f3e8ff;color:#7c3aed;padding:1px 6px;border-radius:4px;font-size:11px">'+nightWeekendLabel(c.nightWeekend)+'</span></div>'
    +'<div style="color:#4b5563">'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ì›ì¥</span><b>'+c.director+'</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ê°œì›</span><b>'+c.estYear+'ë…„ ('+c.yearsOpen+'ë…„ì°¨)</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ê·œëª¨</span><b>ì²´ì–´ '+c.chairs+'ëŒ€ Â· '+c.size+'</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ìœ„ì¹˜</span><b>'+c.floor+(c.hasParking?' Â· ğŸ…¿ï¸':'')+'</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ì¸ë ¥</span><b>ì˜ì‚¬ '+c.dentistCount+'ëª… Â· ìœ„ìƒì‚¬ '+c.hygienistCount+'ëª… Â· ì´ '+c.totalStaff+'ëª…</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ì¼í‰ê·  í™˜ì</span><b>'+c.dailyPatients+'ëª…</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ë³´í—˜ì²­êµ¬</span><b>ì›” '+fmt(c.insuranceClaims)+'ê±´ (ë¹„ê¸‰ì—¬ '+c.nonCoverageRatio+'%)</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ë„¤ì´ë²„</span><b style="color:#f59e0b">â˜… '+c.naverRating+' <span style="color:#9ca3af;font-weight:400">('+fmt(c.naverReviewCount)+'ê±´)</span></b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ë¸”ë¡œê·¸ ë…¸ì¶œ</span><b>'+fmt(c.blogExposure)+'ê±´</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ê²½ìŸ ìœ„í˜‘ë„</span><b style="color:'+(c.competitionThreat==='ë†’ìŒ'?'#dc2626':c.competitionThreat==='ë³´í†µ'?'#d97706':'#16a34a')+'">'+c.competitionThreat+'</b></div>'
    +'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6"><span>ë™ì¢… ê²½ìŸ</span><b>ë°˜ê²½ ë‚´ '+c.sameTypeNearby+'ê°œ</b></div>'
    +'</div>'
    +'<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:3px">'+c.specialties.map(function(sp){return '<span style="background:#f0fdf4;color:#15803d;padding:1px 5px;border-radius:3px;font-size:10px">'+sp+'</span>'}).join('')+'</div>'
    +'<div style="margin-top:6px;padding-top:6px;border-top:1px solid #e5e7eb;background:#ecfdf5;margin:6px -8px -8px;padding:8px;border-radius:0 0 4px 4px">'
    +'<div style="display:flex;justify-content:space-between;color:#059669;font-weight:600"><span>ì—°ë§¤ì¶œ</span><b>ì•½ '+fmtRevKr(c.annualRevenue)+'ì›</b></div>'
    +'<div style="display:flex;justify-content:space-between;color:#059669;font-size:11px;margin-top:2px"><span>ì›”ë§¤ì¶œ</span><b>ì•½ '+fmtRevKr(c.monthlyRevenue)+'ì›</b></div>'
    +(c.forSale&&c.estimatedAcquisitionPrice?'<div style="display:flex;justify-content:space-between;color:#7c3aed;font-weight:600;margin-top:4px;padding-top:4px;border-top:1px dashed #c4b5fd"><span>ì˜ˆìƒ ì¸ìˆ˜ê°€</span><b>ì•½ '+fmtRevKr(c.estimatedAcquisitionPrice)+'ì›</b></div>':'')
    +'</div></div>';
  return r;
}
function generateNearbyClinics(r){
  const h=hashStr(r.dong_code||r.dong),cnt=r.dental_count||8,clinics=[];
  const anchors=getCommercialAnchors(r);
  const types=['ì¼ë°˜ì¹˜ê³¼','êµì •ì¹˜ê³¼','ì†Œì•„ì¹˜ê³¼','ì„í”Œë€íŠ¸ì¹˜ê³¼','ì‹¬ë¯¸ì¹˜ê³¼','í†µí•©ì¹˜ê³¼'];
  const pfx=['ì„œìš¸','ë¯¸ì†Œ','í•´í”¼','ìŠ¤ë§ˆì¼','ì—°ì„¸','ì´ë“ ','í‘¸ë¥¸','ë§‘ì€','ìƒˆë´„','í•˜ë‚˜','ì˜¨','ë¹›','ëŠ˜','ì¢‹ì€','ë°ì€','ì°¸'];
  const dirs=['ê¹€','ì´','ë°•','ìµœ','ì •','ê°•','ì¡°','ìœ¤','ì¥','ì„','í•œ','ì˜¤','ì„œ','ì‹ ','ê¶Œ','í™©'];
  const specPool=['ì„í”Œë€íŠ¸','ì¹˜ì•„êµì •','ì‹¬ë¯¸ë³´ì² ','ì†Œì•„ì§„ë£Œ','ì‡ëª¸ì¹˜ë£Œ','ì¶©ì¹˜ì¹˜ë£Œ','ë¯¸ë°±','í„±ê´€ì ˆ','ì‚¬ë‘ë‹ˆë°œì¹˜','ì¹˜ì•„ì„±í˜•','íˆ¬ëª…êµì •','ë¼ë¯¸ë„¤ì´íŠ¸'];
  for(let i=0;i<cnt;i++){const s=h*100+i;
    const chairs=seededRand(s*29,2,8),sz=seededRand(s*41,15,60),ey=2024-seededRand(s*19,1,15);
    const yearsOpen=2024-ey;
    const yrFactor=Math.min(1.3,1+Math.max(0,yearsOpen-3)*0.02);
    const annRev=Math.round((chairs*7000+sz*120+seededRand(s*43,-3000,8000))*yrFactor);
    const monthlyRev=Math.round(annRev/12);
    const dailyPat=Math.max(5,Math.round(chairs*seededRand(s*47,3,7)+seededRand(s*51,-3,5)));
    const dentistCnt=Math.max(1,Math.round(chairs/2.5)+seededRand(s*53,-1,1));
    const hygienistCnt=Math.max(1,Math.round(chairs*0.8)+seededRand(s*57,-1,1));
    const totalStaff=dentistCnt+hygienistCnt+Math.max(1,seededRand(s*59,1,Math.round(chairs*0.5)+1));
    const insClaims=Math.round(dailyPat*22*seededRand(s*61,60,85)/100);
    const nonCovRatio=seededRand(s*63,25,65);
    const naverRating=(seededRand(s*67,30,50)/10).toFixed(1);
    const naverReviewCnt=Math.round(yearsOpen*seededRand(s*69,15,80)+seededRand(s*71,0,100));
    const blogExposure=seededRand(s*73,50,2000);
    const specCnt=seededRand(s*75,2,5);
    const specs=[];for(let j=0;j<specCnt;j++){const sp=specPool[seededRand(s*77+j*13,0,specPool.length-1)];if(!specs.includes(sp))specs.push(sp)}
    const nightWeekend=seededRand(s*79,0,2);
    const priceLvl=['ì €ê°€','ì¤‘ê°„','ê³ ê°€'][seededRand(s*81,0,2)];
    const threatLvl=chairs>=5&&yearsOpen>=5?'ë†’ìŒ':chairs>=3?'ë³´í†µ':'ë‚®ìŒ';
    const sameTypeNearby=seededRand(s*83,0,Math.min(4,cnt-1));
    const statusRand=seededRand(s*85,0,20);
    const status=statusRand>=2?'ì˜ì—…ì¤‘':statusRand===1?'íœ´ì—…':'íì—…';
    const forSale=status==='íì—…'?true:status==='íœ´ì—…'?seededRand(s*87,0,1)===1:seededRand(s*89,0,8)===0;
    const estAcqPrice=forSale?Math.round(annRev*seededRand(s*91,8,18)/10):null;
    let cLat,cLng;
    if(anchors){const anc=anchors[seededRand(s*2,0,anchors.length-1)];cLat=anc.lat+seededRand(s*3,-15,15)/10000;cLng=anc.lng+seededRand(s*7,-18,18)/10000}
    else{cLat=r.lat+seededRand(s*3,-20,20)/10000;cLng=r.lng+seededRand(s*7,-25,25)/10000}
    clinics.push({name:pfx[seededRand(s*11,0,pfx.length-1)]+'ì¹˜ê³¼ì˜ì›',type:types[seededRand(s*13,0,types.length-1)],
      director:dirs[seededRand(s*17,0,dirs.length-1)]+'ì›ì¥',lat:cLat,lng:cLng,
      estYear:ey,rating:(seededRand(s*23,32,50)/10).toFixed(1),chairs:chairs,
      hasParking:seededRand(s*31,0,1)===1,floor:seededRand(s*37,1,8)+'ì¸µ',size:sz+'í‰',annualRevenue:annRev,
      monthlyRevenue:monthlyRev,dailyPatients:dailyPat,dentistCount:dentistCnt,hygienistCount:hygienistCnt,
      totalStaff:totalStaff,insuranceClaims:insClaims,nonCoverageRatio:nonCovRatio,
      naverRating:naverRating,naverReviewCount:naverReviewCnt,blogExposure:blogExposure,
      specialties:specs,nightWeekend:nightWeekend,priceLevel:priceLvl,yearsOpen:yearsOpen,
      competitionThreat:threatLvl,sameTypeNearby:sameTypeNearby,
      status:status,forSale:forSale,estimatedAcquisitionPrice:estAcqPrice})}
  return clinics;
}
function generateRecommendedSpots(r,clinics){
  const h=hashStr(r.dong+'_rec'),spots=[];
  var active=clinics?clinics.filter(function(c){return c.status==='ì˜ì—…ì¤‘'}):[];
  /* â”€â”€ Step 1: í´ëŸ¬ìŠ¤í„° ì¤‘ì‹¬ ê³„ì‚° â”€â”€ */
  var cLat=0,cLng=0;active.forEach(function(c){cLat+=c.lat;cLng+=c.lng});
  cLat/=active.length;cLng/=active.length;
  /* â”€â”€ Step 2: ë°€ì§‘ë„ Ã— í‹ˆìƒˆ ì ìˆ˜ ê³„ì‚° â”€â”€ */
  /* í•µì‹¬: ì¹˜ê³¼ê°€ ë§ì´ ëª°ë ¤ìˆëŠ” ê³³(ë°€ì§‘) ì¤‘ì—ì„œ ê°€ì¥ í° í‹ˆìƒˆë¥¼ ì°¾ìŒ */
  active.forEach(function(cl){
    var minD=Infinity,cnt300=0;
    active.forEach(function(other){
      if(cl===other)return;
      var d=distM(cl.lat,cl.lng,other.lat,other.lng);
      if(d<minD)minD=d;
      if(d<=300)cnt300++;
    });
    cl._nearDist=minD===Infinity?9999:minD;
    cl._density=cnt300;/* 300m ë‚´ ì¹˜ê³¼ ìˆ˜ = ë°€ì§‘ë„ */
    cl._distToCenter=distM(cl.lat,cl.lng,r.lat,r.lng);
    /* ì¢…í•© ì ìˆ˜ = ë°€ì§‘ë„ Ã— í‹ˆìƒˆ(ìµœê·¼ì ‘ ê±°ë¦¬) */
    /* ë°€ì§‘ ì§€ì—­(ì¹˜ê³¼ å¤š)ì—ì„œ í‹ˆìƒˆ(ì´ì›ƒ ì¹˜ê³¼ì™€ ê±°ë¦¬ í° ê³³)ê°€ ìµœì  */
    cl._recScore=cl._density*Math.min(cl._nearDist,300);
  });
  var sorted=active.slice().sort(function(a,b){return b._recScore-a._recScore});
  /* â”€â”€ Step 3: ì ìˆ˜ ë†’ì€ ìˆœ 3ê°œ ì„ íƒ (ì„œë¡œ 100m+ ì´ê²©) â”€â”€ */
  var picked=[];
  for(var ci=0;ci<sorted.length&&picked.length<3;ci++){
    var ok=true;
    for(var pi=0;pi<picked.length;pi++){
      if(distM(sorted[ci].lat,sorted[ci].lng,picked[pi].lat,picked[pi].lng)<100){ok=false;break}
    }
    if(ok){
      console.log('[DentalMap] ì¶”ì²œ'+picked.length+': '+sorted[ci].name+' ('+sorted[ci].lat+','+sorted[ci].lng+') ì¤‘ì‹¬ê±°ë¦¬='+Math.round(sorted[ci]._distToCenter)+'m');
      picked.push({lat:sorted[ci].lat,lng:sorted[ci].lng,
        nearDist:sorted[ci]._nearDist,density:sorted[ci]._density,
        clinicName:sorted[ci].name});
    }
  }
  /* â”€â”€ Step 5: ì£¼ë³€ ì¹˜ê³¼ í‰ê· ìœ¼ë¡œ ì‚¬ì—… ì§€í‘œ ê¸°ì¤€ ì‚°ì¶œ â”€â”€ */
  var avgChairs=0,avgRev=0,avgDaily=0,avgSize=0,acN=active.length||1;
  active.forEach(function(c){avgChairs+=c.chairs;avgRev+=c.annualRevenue;avgDaily+=c.dailyPatients;avgSize+=parseInt(c.size)||30});
  avgChairs=Math.round(avgChairs/acN);avgRev=Math.round(avgRev/acN);avgDaily=Math.round(avgDaily/acN);avgSize=Math.round(avgSize/acN);
  /* â”€â”€ Step 6: ì¶”ì²œ ì§€ì  ë°ì´í„° + ì‚¬ì—…ê³„íš ì§€í‘œ ìƒì„± â”€â”€ */
  var baseReasons=[['ìœ ë™ì¸êµ¬ ë°€ì§‘ êµ¬ê°„ (ì¼ '+fmt(Math.round(r.daily_floating*0.4))+'ëª…)','ëŒ€ì¤‘êµí†µ ë„ë³´ 5ë¶„ ì´ë‚´','20~39ì„¸ ì Šì€ ì¸êµ¬ ë°€ì§‘'],
    ['ì‹ ê·œ ì•„íŒŒíŠ¸ ë‹¨ì§€ ì¸ì ‘ (ì…ì£¼ 2ë…„ ì´ë‚´)','ì†Œì•„Â·êµì • ìˆ˜ìš” ë†’ì€ ì§€ì—­','ì„ëŒ€ë£Œ ë³¸ ì§€ì—­ ëŒ€ë¹„ 15% ì €ë ´'],
    ['ì£¼ê±°Â·ìƒì—… ë³µí•© ì§€ì—­','ì§ì¥ì¸ ë°€ì§‘ êµ¬ì—­','ì•¼ê°„Â·ì£¼ë§ ì§„ë£Œ ìˆ˜ìš” ë†’ìŒ']];
  for(var i=0;i<picked.length;i++){var s=h*50+i,p=picked[i];
    var gapM=Math.round(p.nearDist);
    var rs=['ì£¼ë³€ '+p.density+'ê°œ ì¹˜ê³¼ ë°€ì§‘ ìƒê¶Œ ë‚´ í‹ˆìƒˆ (ê°€ì¥ ê°€ê¹Œìš´ ì¹˜ê³¼ '+gapM+'m)'];
    rs=rs.concat(baseReasons[i]||baseReasons[0]);
    /* ì‚¬ì—… ì§€í‘œ ì‚°ì¶œ â€” ì£¼ë³€ ì¹˜ê³¼ í‰ê·  + í‹ˆìƒˆ ë³´ì • */
    var gapBonus=gapM>200?1.15:gapM>120?1.08:1.0;/* í‹ˆìƒˆ í´ìˆ˜ë¡ í™˜ì ìœ ì… ë³´ë„ˆìŠ¤ */
    var recChairs=Math.max(3,Math.min(7,avgChairs+seededRand(s*31,-1,1)));
    var recSize=Math.max(20,Math.min(55,Math.round(recChairs*7+seededRand(s*33,-3,5))));
    var rentPy=Math.max(5,r.avg_rent_pyeong+seededRand(s*35,-2,1));
    var monthlyRent=rentPy*recSize;
    var estDailyPat=Math.max(8,Math.round(avgDaily*gapBonus+seededRand(s*37,-3,5)));
    var estAnnRev=Math.round((recChairs*7000+recSize*120+seededRand(s*39,-2000,5000))*gapBonus);
    var estMonthRev=Math.round(estAnnRev/12);
    var recDentist=Math.max(1,Math.round(recChairs/2.5));
    var recHygienist=Math.max(1,Math.round(recChairs*0.8));
    var recStaff=recDentist+recHygienist+Math.max(1,Math.round(recChairs*0.4));
    var initInvest=Math.round(recChairs*4500+recSize*180+seededRand(s*41,2000,8000));/* ì²´ì–´ë‹¹ 4500ë§Œ+ì¸í…Œë¦¬ì–´+ì¥ë¹„ */
    var monthlyProfit=estMonthRev-monthlyRent-Math.round(recStaff*350+recChairs*120);
    var breakEvenMo=monthlyProfit>0?Math.max(6,Math.min(36,Math.round(initInvest/monthlyProfit))):36;
    spots.push({lat:p.lat,lng:p.lng,
      label:'ì¶”ì²œ '+(i+1)+'ìˆœìœ„',
      score:Math.min(98,r.scores.total+seededRand(s*7,8,20)-i*4),
      grade:i===0?'S':i===1?'A':'A',reasons:rs,
      nearestClinicM:gapM,surroundingClinics:p.density,
      rent:rentPy,estPop:seededRand(s*11,8000,25000),
      /* ì‚¬ì—…ê³„íš ì§€í‘œ */
      recSize:recSize,recChairs:recChairs,monthlyRent:monthlyRent,
      estDailyPat:estDailyPat,estMonthRev:estMonthRev,estAnnRev:estAnnRev,
      recDentist:recDentist,recHygienist:recHygienist,recStaff:recStaff,
      initInvest:initInvest,monthlyProfit:monthlyProfit,breakEvenMo:breakEvenMo})}
  return spots;
}
async function renderAnalysisMap(r){
  if(analysisMap){analysisMap.remove();analysisMap=null}
  const el=document.getElementById('analysis-map');if(!el||typeof L==='undefined')return;
  analysisMap=L.map('analysis-map',{scrollWheelZoom:true,zoomControl:true}).setView([r.lat,r.lng],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:18}).addTo(analysisMap);
  addMapLegend(analysisMap,'analysis');
  /* ì§€ì˜¤ì½”ë”© ì†ŒìŠ¤ í‘œì‹œ */
  var geoSrc=L.control({position:'topleft'});geoSrc.onAdd=function(){var d=L.DomUtil.create('div','');d.innerHTML='<div style="background:'+(r._kakaoGeo?'#ecfdf5;border:1px solid #6ee7b7;color:#065f46':'#fef9c3;border:1px solid #fde68a;color:#92400e')+';border-radius:8px;padding:4px 10px;font-size:11px;font-weight:600;box-shadow:0 1px 4px rgba(0,0,0,0.1)">'+(r._kakaoGeo?'ì¹´ì¹´ì˜¤ ì§€ì˜¤ì½”ë”©':'í‚¤ì›Œë“œ ë§¤ì¹­ (í´ë°±)')+'</div>';return d};geoSrc.addTo(analysisMap);
  /* center â€” ë“œë˜ê·¸ ê°€ëŠ¥ ë§ˆì»¤ */
  var centerMarker=L.marker([r.lat,r.lng],{draggable:false,icon:L.divIcon({className:'',html:'<div style="background:#3b82f6;color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;border:3px solid white;box-shadow:0 2px 10px rgba(59,130,246,0.5)">ğŸ“</div>',iconSize:[40,40],iconAnchor:[20,20]})}).addTo(analysisMap)
    .bindPopup('<div style="min-width:160px;font-family:Pretendard Variable,sans-serif"><b style="font-size:15px">'+r.dong+'</b><br><span style="color:#6b7280;font-size:12px">ë¶„ì„ ì¤‘ì‹¬ ì§€ì—­</span><br><span style="color:#3b82f6;font-weight:bold;font-size:18px">ì¢…í•© '+r.scores.total+'ì </span> <span style="font-size:12px;color:#6b7280">'+r.grade+'ë“±ê¸‰</span></div>');
  /* ì‹œì‘ì  ì´ë™ ë²„íŠ¼ â€” ì§€ë„ ì™¼ìª½ ì„¸ë¡œ ì¤‘ì•™ */
  var _moveMode=false;
  var moveWrap=L.DomUtil.create('div','',el);
  moveWrap.style.cssText='position:absolute;left:10px;top:50%;transform:translateY(-50%);z-index:1000;display:flex;flex-direction:column;gap:6px';
  moveWrap.innerHTML='<button id="btn-move-start" style="background:white;border:2px solid #166534;border-radius:10px;padding:8px 20px;font-size:15px;font-weight:700;color:#166534;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.18);display:flex;align-items:center;gap:6px">âœ‹ ì‹œì‘ì  ì´ë™</button>'
    +'<button id="btn-reanalyze" style="display:none;background:#166534;border:2px solid #14532d;border-radius:10px;padding:8px 20px;font-size:15px;font-weight:700;color:white;cursor:pointer;box-shadow:0 2px 8px rgba(22,101,52,0.4)">ğŸ”„ ì´ ìœ„ì¹˜ì—ì„œ ì¬ë¶„ì„</button>';
  L.DomEvent.disableClickPropagation(moveWrap);
  /* ì´ë™ ëª¨ë“œ í† ê¸€ */
  document.getElementById('btn-move-start').addEventListener('click',function(){
    _moveMode=!_moveMode;
    centerMarker.dragging[_moveMode?'enable':'disable']();
    this.style.background=_moveMode?'#fef3c7':'white';
    this.style.borderColor=_moveMode?'#f59e0b':'#166534';
    this.style.color=_moveMode?'#92400e':'#166534';
    this.innerHTML=_moveMode?'ğŸ“Œ ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”':'âœ‹ ì‹œì‘ì  ì´ë™';
    if(!_moveMode)document.getElementById('btn-reanalyze').style.display='none';
  });
  /* ë“œë˜ê·¸ ë â†’ ì¬ë¶„ì„ ë²„íŠ¼ í‘œì‹œ */
  centerMarker.on('dragend',function(){
    document.getElementById('btn-reanalyze').style.display='block';
  });
  /* ì¬ë¶„ì„ í´ë¦­ â†’ ìƒˆ ì¢Œí‘œë¡œ ì „ì²´ ì¬ë¶„ì„ */
  var _currentRegion=r;
  document.getElementById('btn-reanalyze').addEventListener('click',async function(){
    var pos=centerMarker.getLatLng();
    this.innerHTML='â³ ë¶„ì„ ì¤‘...';this.disabled=true;
    /* ì¹´ì¹´ì˜¤ ì—­ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ìƒˆ ì£¼ì†Œ ì–»ê¸° */
    var newName=r.dong;
    if(typeof kakao!=='undefined'&&kakao.maps){
      try{await new Promise(function(res){kakao.maps.load(function(){
        var gc=new kakao.maps.services.Geocoder();
        gc.coord2RegionCode(pos.lng,pos.lat,function(result,status){
          if(status===kakao.maps.services.Status.OK&&result[0]){newName=result[0].region_3depth_name||result[0].region_2depth_name||newName}
          res();
        });
      })})}catch(e){}
    }
    /* ìƒˆ ì¢Œí‘œë¡œ ë¦¬ì „ ì¬ìƒì„± */
    var nr=Object.assign({},_currentRegion,{lat:pos.lat,lng:pos.lng,dong:newName+' (ì´ë™)',_kakaoGeo:true});
    analysisState={tab:'overview',generating:false,generated:false};
    renderAnalysisContent(nr);
  });
  /* clinics â€” ì‹¤ì œ API ìš°ì„ , ì‹¤íŒ¨ ì‹œ mock í´ë°± */
  var clinics=await fetchRealClinics(r.lat,r.lng,1000);
  var isRealData=!!clinics;
  if(!clinics)clinics=generateNearbyClinics(r);
  /* ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ */
  if(isRealData){var srcDiv=L.control({position:'topright'});srcDiv.onAdd=function(){var d=L.DomUtil.create('div','');d.innerHTML='<div style="background:#ecfdf5;border:1px solid #6ee7b7;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:600;color:#065f46;box-shadow:0 1px 4px rgba(0,0,0,0.1)">ì‹¤ì œ ì¹˜ê³¼ ë°ì´í„° (HIRA)</div>';return d};srcDiv.addTo(analysisMap)}
  clinics.forEach(c=>{L.marker([c.lat,c.lng],{icon:L.divIcon({className:'',html:'<div style="background:'+(c.status==='ì˜ì—…ì¤‘'?'#ef4444':c.status==='íœ´ì—…'?'#eab308':'#9ca3af')+';color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.25);cursor:pointer">ğŸ¦·</div>',iconSize:[30,30],iconAnchor:[15,15]})}).addTo(analysisMap)
    .bindPopup(buildClinicPopup(c),{maxWidth:320})});
  /* recommended â€” ë°˜ê²½ 50m ì¶”ì²œ êµ¬ì—­ ì›ìœ¼ë¡œ í‘œì‹œ */
  const spots=generateRecommendedSpots(r,clinics);
  var spotColors=['#f59e0b','#8b5cf6','#10b981'];/* 1ìˆœìœ„=ì£¼í™©, 2ìˆœìœ„=ë³´ë¼, 3ìˆœìœ„=ì´ˆë¡ */
  spots.forEach(function(s,si){
    var clr=spotColors[si]||spotColors[0];
    var rank=si+1;
    /* ë°˜ê²½ 50m ì› */
    L.circle([s.lat,s.lng],{radius:50,color:clr,weight:2.5,opacity:0.85,fillColor:clr,fillOpacity:0.15,dashArray:'6 4'}).addTo(analysisMap);
    /* ì› ì¤‘ì‹¬ ë¼ë²¨ */
    L.marker([s.lat,s.lng],{icon:L.divIcon({className:'',html:'<div style="background:'+clr+';color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap;border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);text-align:center;line-height:1.3">â­ '+rank+'ìˆœìœ„<br><span style="font-size:9px;opacity:0.9">ë°˜ê²½ 50m</span></div>',iconSize:[0,0],iconAnchor:[40,15]})}).addTo(analysisMap)
    .bindPopup('<div style="min-width:260px;max-width:340px;font-family:Pretendard Variable,sans-serif"><div style="background:#fef3c7;color:#92400e;padding:3px 10px;border-radius:6px;display:inline-block;font-size:11px;font-weight:bold">ğŸ† ë´íƒˆë§µ ì¶”ì²œ</div><div style="font-size:15px;font-weight:bold;margin-top:6px">'+s.label+'</div><div style="display:flex;align-items:baseline;gap:6px;margin:4px 0"><span style="font-size:28px;font-weight:bold;color:#3b82f6">'+s.score+'ì </span><span style="font-size:12px;background:#dbeafe;color:#2563eb;padding:1px 6px;border-radius:4px;font-weight:bold">'+s.grade+'ë“±ê¸‰</span></div>'
    +'<div style="font-size:12px;color:#4b5563;border-top:1px solid #e5e7eb;padding-top:6px;margin-top:2px">'+s.reasons.map(function(x){return'<div style="padding:2px 0">âœ… '+x+'</div>'}).join('')+'</div>'
    +'<div style="margin-top:8px;padding:8px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0">'
    +'<div style="font-size:11px;font-weight:700;color:#166534;margin-bottom:4px">ì¶”ì²œ ê°œì› ê·œëª¨</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 8px;font-size:11px;color:#374151">'
    +'<span>ë©´ì  <b>'+s.recSize+'í‰</b></span><span>ì²´ì–´ <b>'+s.recChairs+'ëŒ€</b></span>'
    +'<span>ì˜ì‚¬ <b>'+s.recDentist+'ëª…</b></span><span>ìœ„ìƒì‚¬ <b>'+s.recHygienist+'ëª…</b></span>'
    +'<span>ì§ì›(ì´) <b>'+s.recStaff+'ëª…</b></span><span>ì›”ì„ëŒ€ <b>'+fmt(s.monthlyRent)+'ë§Œ</b></span></div></div>'
    +'<div style="margin-top:6px;padding:8px;background:#eff6ff;border-radius:6px;border:1px solid #bfdbfe">'
    +'<div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:4px">ì˜ˆìƒ ìˆ˜ìµ</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 8px;font-size:11px;color:#374151">'
    +'<span>ì¼í™˜ì <b>'+s.estDailyPat+'ëª…</b></span><span>ì›”ë§¤ì¶œ <b>'+fmtRevKr(s.estMonthRev)+'</b></span>'
    +'<span>ì—°ë§¤ì¶œ <b>'+fmtRevKr(s.estAnnRev)+'</b></span><span>ì›”ìˆœì´ìµ <b>'+fmtRevKr(s.monthlyProfit)+'</b></span>'
    +'<span>ì´ˆê¸°íˆ¬ì <b>ì•½ '+fmtRevKr(s.initInvest)+'</b></span><span>ì†ìµë¶„ê¸° <b>ì•½ '+s.breakEvenMo+'ê°œì›”</b></span></div></div></div>',{maxWidth:360});
  });
  /* fit bounds */
  const pts=[[r.lat,r.lng],...clinics.map(c=>[c.lat,c.lng]),...spots.map(s=>[s.lat,s.lng])];
  if(pts.length>1)analysisMap.fitBounds(pts,{padding:[40,40]});
  renderClinicList(r,clinics,spots);
}
function renderClinicList(r,clinics,spots){
  const el=document.getElementById('clinic-list-container');if(!el)return;
  let h='<div class="grid md:grid-cols-2 gap-4 mt-4">';
  spots.forEach(s=>{h+='<div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl p-5">'
    +'<div class="flex items-center gap-2 mb-3"><span class="text-lg">â­</span><span class="text-xs font-bold text-amber-800 bg-amber-200 px-2.5 py-0.5 rounded-full">ë´íƒˆë§µ ì¶”ì²œ</span><span class="text-xs font-bold text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full ml-auto">'+s.grade+'ë“±ê¸‰</span></div>'
    +'<h3 class="font-bold text-base">'+s.label+'</h3>'
    +'<p class="text-3xl font-bold text-blue-600 mt-1">'+s.score+'<span class="text-base text-gray-400 font-medium">ì </span></p>'
    +'<ul class="mt-3 space-y-1.5">'+s.reasons.map(x=>'<li class="text-sm text-gray-700 flex items-start gap-1.5"><span class="text-green-500 mt-0.5 shrink-0">âœ“</span>'+x+'</li>').join('')+'</ul>'
    /* ì¶”ì²œ ê°œì› ê·œëª¨ */
    +'<div class="mt-3 pt-3 border-t border-amber-200">'
    +'<p class="text-xs font-bold text-emerald-800 mb-2">ì¶”ì²œ ê°œì› ê·œëª¨</p>'
    +'<div class="grid grid-cols-3 gap-x-3 gap-y-1 text-[11px]">'
    +'<span class="text-gray-500">ë©´ì  <b class="text-gray-700">'+s.recSize+'í‰</b></span>'
    +'<span class="text-gray-500">ì²´ì–´ <b class="text-gray-700">'+s.recChairs+'ëŒ€</b></span>'
    +'<span class="text-gray-500">ì›”ì„ëŒ€ <b class="text-gray-700">'+fmt(s.monthlyRent)+'ë§Œ</b></span>'
    +'<span class="text-gray-500">ì˜ì‚¬ <b class="text-gray-700">'+s.recDentist+'ëª…</b></span>'
    +'<span class="text-gray-500">ìœ„ìƒì‚¬ <b class="text-gray-700">'+s.recHygienist+'ëª…</b></span>'
    +'<span class="text-gray-500">ì§ì›(ì´) <b class="text-gray-700">'+s.recStaff+'ëª…</b></span>'
    +'</div></div>'
    /* ì˜ˆìƒ ìˆ˜ìµ */
    +'<div class="mt-2.5 pt-2.5 border-t border-amber-200">'
    +'<p class="text-xs font-bold text-blue-800 mb-2">ì˜ˆìƒ ìˆ˜ìµ</p>'
    +'<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px]">'
    +'<span class="text-gray-500">ì¼í‰ê·  í™˜ì <b class="text-emerald-700">'+s.estDailyPat+'ëª…</b></span>'
    +'<span class="text-gray-500">ì›”ë§¤ì¶œ <b class="text-emerald-700">'+fmtRevKr(s.estMonthRev)+'</b></span>'
    +'<span class="text-gray-500">ì—°ë§¤ì¶œ <b class="text-emerald-700">'+fmtRevKr(s.estAnnRev)+'</b></span>'
    +'<span class="text-gray-500">ì›”ìˆœì´ìµ <b class="text-emerald-700">'+fmtRevKr(s.monthlyProfit)+'</b></span>'
    +'</div></div>'
    /* íˆ¬ìÂ·ì†ìµë¶„ê¸° */
    +'<div class="mt-2.5 pt-2.5 border-t border-amber-200 flex items-center justify-between text-[11px]">'
    +'<span class="text-gray-500">ì´ˆê¸°íˆ¬ì <b class="text-violet-700">ì•½ '+fmtRevKr(s.initInvest)+'</b></span>'
    +'<span class="text-gray-500">ì†ìµë¶„ê¸° <b class="text-violet-700">ì•½ '+s.breakEvenMo+'ê°œì›”</b></span>'
    +'</div>'
    +'</div>'});
  h+='</div>';
  const activeCount=clinics.filter(c=>c.status==='ì˜ì—…ì¤‘').length;
  const forSaleCount=clinics.filter(c=>c.forSale).length;
  var realCount=clinics.filter(function(c){return c._real}).length;
  h+='<div class="mt-6"><div class="flex items-center justify-between mb-3"><h3 class="font-bold text-sm text-gray-700">ì£¼ë³€ ê¸°ì¡´ ì¹˜ê³¼ í˜„í™© ('+clinics.length+'ê°œ'+(forSaleCount>0?' Â· <span class="text-purple-600">ì¸ìˆ˜ê°€ëŠ¥ '+forSaleCount+'</span>':'')+')</h3><span class="text-xs text-gray-400">'+(realCount>0?'<span class="text-emerald-600 font-semibold">HIRA ì‹¤ì œ ë°ì´í„°</span> Â· ':'')+'ì˜ì—…ì¤‘ '+activeCount+'ê°œ Â· ë°˜ê²½ ì•½ '+(realCount>0?'1km':'500m')+'</span></div>';
  h+='<div class="clinic-list-scroll space-y-2">';
  clinics.forEach((c,i)=>{
    const stBadge=c.status==='ì˜ì—…ì¤‘'?'<span class="text-[10px] font-medium bg-green-100 text-green-700 px-1 py-0.5 rounded">ì˜ì—…ì¤‘</span>':c.status==='íœ´ì—…'?'<span class="text-[10px] font-medium bg-yellow-100 text-yellow-700 px-1 py-0.5 rounded">íœ´ì—…</span>':'<span class="text-[10px] font-medium bg-red-100 text-red-700 px-1 py-0.5 rounded">íì—…</span>';
    const saleBadge=c.forSale?'<span class="text-[10px] font-medium bg-purple-100 text-purple-700 px-1 py-0.5 rounded ml-0.5">ì¸ìˆ˜ê°€ëŠ¥</span>':'';
    const threatDot=c.competitionThreat==='ë†’ìŒ'?'text-red-500':c.competitionThreat==='ë³´í†µ'?'text-amber-500':'text-green-500';
    h+='<div class="bg-gray-50 hover:bg-gray-100 transition rounded-xl px-4 py-3 cursor-pointer" onclick="if(analysisMap){analysisMap.setView(['+c.lat+','+c.lng+'],17)}">'
    +'<div class="flex items-center gap-3">'
    +'<div class="w-10 h-10 '+(c.status==='ì˜ì—…ì¤‘'?'bg-red-100':'bg-gray-200')+' rounded-full flex items-center justify-center text-lg shrink-0">ğŸ¦·</div>'
    +'<div class="flex-1 min-w-0">'
    +'<div class="flex items-center gap-1"><p class="font-semibold text-sm truncate">'+c.name+'</p>'+stBadge+saleBadge+(c._real?'<span class="text-[10px] font-medium bg-emerald-100 text-emerald-700 px-1 py-0.5 rounded ml-0.5">ì‹¤ì œ</span>':'')+'</div>'
    +'<p class="text-xs text-gray-500 mt-0.5">'+(c._real&&c.address?c.address:c.type+' Â· '+c.director+' Â· '+c.estYear+'ë…„ ('+c.yearsOpen+'ë…„ì°¨)')+'</p>'
    +'</div>'
    +'<div class="text-right shrink-0"><p class="text-sm font-bold text-emerald-600">'+fmtRevKr(c.annualRevenue)+'ì›/ë…„</p><p class="text-[10px] text-gray-400">ì›” '+fmtRevKr(c.monthlyRevenue)+'ì›</p></div></div>'
    +'<div class="mt-2 ml-[52px] grid grid-cols-3 gap-x-3 gap-y-0.5 text-[11px]">'
    +'<span class="text-gray-500">ì²´ì–´ <b class="text-gray-700">'+c.chairs+'</b>ëŒ€</span>'
    +'<span class="text-gray-500">ì˜ì‚¬ <b class="text-gray-700">'+c.dentistCount+'</b>ëª…</span>'
    +'<span class="text-gray-500">ìœ„ìƒì‚¬ <b class="text-gray-700">'+c.hygienistCount+'</b>ëª…</span>'
    +'<span class="text-gray-500">ì¼í™˜ì <b class="text-gray-700">'+c.dailyPatients+'</b>ëª…</span>'
    +'<span class="text-gray-500">ë¹„ê¸‰ì—¬ <b class="text-gray-700">'+c.nonCoverageRatio+'</b>%</span>'
    +'<span class="text-gray-500">ì§ì› <b class="text-gray-700">'+c.totalStaff+'</b>ëª…</span>'
    +'<span class="text-gray-500">â˜… <b class="text-yellow-600">'+c.naverRating+'</b> ('+fmt(c.naverReviewCount)+')</span>'
    +'<span class="text-gray-500">ë¸”ë¡œê·¸ <b class="text-gray-700">'+fmt(c.blogExposure)+'</b>ê±´</span>'
    +'<span class="'+threatDot+' font-medium">ìœ„í˜‘ '+c.competitionThreat+'</span>'
    +'</div>'
    +'<div class="mt-1.5 ml-[52px] flex flex-wrap gap-1">'+c.specialties.map(function(sp){return '<span class="text-[10px] bg-emerald-50 text-emerald-700 px-1 py-0.5 rounded">'+sp+'</span>'}).join('')
    +'<span class="text-[10px] bg-violet-50 text-violet-700 px-1 py-0.5 rounded">'+nightWeekendLabel(c.nightWeekend)+'</span>'
    +'<span class="text-[10px] bg-sky-50 text-sky-700 px-1 py-0.5 rounded">'+c.priceLevel+'</span>'
    +'<span class="text-[10px] bg-gray-100 text-gray-600 px-1 py-0.5 rounded">ë™ì¢… '+c.sameTypeNearby+'ê°œ</span></div>'
    +(c.forSale&&c.estimatedAcquisitionPrice?'<div class="mt-1.5 ml-[52px]"><span class="text-[11px] font-bold text-purple-700 bg-purple-50 px-1.5 py-0.5 rounded">ì˜ˆìƒ ì¸ìˆ˜ê°€ ì•½ '+fmtRevKr(c.estimatedAcquisitionPrice)+'ì›</span></div>':'')
    +'</div>'});
  h+='</div></div>';
  el.innerHTML=h;
}

/* â”€â”€ Analysis Text Generator â”€â”€ */
function genTexts(r){
  const popText=r.scores.population>=80?`ë°˜ê²½ 1km ë‚´ ê±°ì£¼ì¸êµ¬ ${fmt(r.population)}ëª…ìœ¼ë¡œ ì¹˜ê³¼ ìˆ˜ìš”ê°€ ì¶©ë¶„í•©ë‹ˆë‹¤. íŠ¹íˆ 20~39ì„¸ ì¸êµ¬ê°€ ${r.age_20_39_pct}%ë¡œ ì‹¬ë¯¸Â·êµì • ì§„ë£Œ ìˆ˜ìš”ê°€ ë†’ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.`:r.scores.population>=50?`ê±°ì£¼ì¸êµ¬ ${fmt(r.population)}ëª…ì€ í‰ê·  ìˆ˜ì¤€ì…ë‹ˆë‹¤. 20~39ì„¸ ë¹„ì¤‘ì´ ${r.age_20_39_pct}%ì´ë©°, ì£¼ê°„ ìœ ë™ì¸êµ¬ ${fmt(r.daily_floating)}ëª…ì„ í•¨ê»˜ ê³ ë ¤í•˜ë©´ ì‹¤ì§ˆ ìˆ˜ìš”ëŠ” ì–‘í˜¸í•©ë‹ˆë‹¤.`:`ë°˜ê²½ 1km ê±°ì£¼ì¸êµ¬ ${fmt(r.population)}ëª…ìœ¼ë¡œ ìˆ˜ìš” ê¸°ë°˜ì´ ë‹¤ì†Œ ì·¨ì•½í•©ë‹ˆë‹¤.`;
  const compText=r.scores.competition>=70?`ë°˜ê²½ 500m ë‚´ ì¹˜ê³¼ ${r.dental_count}ê°œë¡œ ê²½ìŸì´ ì ìŠµë‹ˆë‹¤.`:r.scores.competition>=50?`ë°˜ê²½ 500m ë‚´ ì¹˜ê³¼ ${r.dental_count}ê°œëŠ” í‰ê·  ìˆ˜ì¤€ì…ë‹ˆë‹¤.`:`ë°˜ê²½ 500m ë‚´ ì¹˜ê³¼ ${r.dental_count}ê°œë¡œ ê²½ìŸì´ ì¹˜ì—´í•©ë‹ˆë‹¤. ì¸êµ¬ë‹¹ ì¹˜ê³¼ 1:${fmt(r.pop_per_clinic)}.`;
  const costText=r.scores.cost>=70?`í‰ë‹¹ ì„ëŒ€ë£Œ ${r.avg_rent_pyeong}ë§Œì›ì€ í•©ë¦¬ì ì…ë‹ˆë‹¤.`:r.scores.cost>=50?`í‰ë‹¹ ì„ëŒ€ë£Œ ${r.avg_rent_pyeong}ë§Œì›ì€ ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì›” ${fmt(r.avg_rent_pyeong*r.area_pyeong)}ë§Œì› ì˜ˆìƒ.`:`í‰ë‹¹ ì„ëŒ€ë£Œ ${r.avg_rent_pyeong}ë§Œì›ì€ ë†’ì€ í¸ì…ë‹ˆë‹¤.`;
  const accessText=`ê°€ì¥ ê°€ê¹Œìš´ ì—­ ${r.subway_station}(${r.subway_line}, ë„ë³´ ${r.subway_walk_min}ë¶„), ë²„ìŠ¤ì •ë¥˜ì¥ ${r.bus_stops_500m}ê°œ. ìœ ë™ì¸êµ¬ ${fmt(r.daily_floating)}ëª….`;
  const growthText=r.pop_growth_rate>3?`ì¸êµ¬ ì¦ê°€ìœ¨ +${r.pop_growth_rate}%ë¡œ ì„±ì¥ ì ì¬ë ¥ì´ ë†’ìŠµë‹ˆë‹¤.`:r.pop_growth_rate>0?`ì¸êµ¬ ì¦ê°€ìœ¨ +${r.pop_growth_rate}%ë¡œ ì™„ë§Œí•œ ì„±ì¥ì„¸ì…ë‹ˆë‹¤.`:`ì¸êµ¬ ë³€ë™ ${r.pop_growth_rate}%.`;
  return{popText,compText,costText,accessText,growthText};
}

/* â”€â”€ Analysis State â”€â”€ */
let analysisState={tab:'overview',generating:false,generated:false};

/* â”€â”€ Navigate to another region (stays on analysis.html) â”€â”€ */
function analyzeFromInput(){
  const v=(document.getElementById('analysis-quick-input').value||'').trim();if(!v)return;
  var url='analysis0.html?q='+encodeURIComponent(v);
  var pp=new URLSearchParams(window.location.search);
  if(pp.get('cname'))url+='&cname='+encodeURIComponent(pp.get('cname'));
  if(pp.get('cphone'))url+='&cphone='+encodeURIComponent(pp.get('cphone'));
  if(pp.get('cemail'))url+='&cemail='+encodeURIComponent(pp.get('cemail'));
  if(pp.get('cinfo'))url+='&cinfo='+encodeURIComponent(pp.get('cinfo'));
  window.location.href=url;
}
function analyzeFromHero(){
  const v=(document.getElementById('hero-search-input').value||'').trim();if(!v)return;
  var url='analysis0.html?q='+encodeURIComponent(v);
  var cn=(document.getElementById('client-name')||{}).value||'';
  var cp=(document.getElementById('client-phone')||{}).value||'';
  var ce=(document.getElementById('client-email')||{}).value||'';
  var ci=(document.getElementById('client-info')||{}).value||'';
  if(cn)url+='&cname='+encodeURIComponent(cn);
  if(cp)url+='&cphone='+encodeURIComponent(cp);
  if(ce)url+='&cemail='+encodeURIComponent(ce);
  if(ci)url+='&cinfo='+encodeURIComponent(ci);
  window.location.href=url;
}

/* â”€â”€ Tab Switch â”€â”€ */
function switchTab(tab,code){
  analysisState.tab=tab;
  const r=REGIONS.find(x=>x.dong_code===code);
  if(r)renderAnalysisContent(r);
}

/* â”€â”€ Generate Report (from hero button) â”€â”€ */
function generateReportFromHero(code){
  analysisState.tab='report';
  analysisState.generating=false;
  analysisState.generated=true;
  const r=REGIONS.find(x=>x.dong_code===code);
  if(r)renderAnalysisContent(r);
}

/* â”€â”€ Render Full Analysis Content â”€â”€ */
function renderAnalysisContent(r){
  if(analysisMap){analysisMap.remove();analysisMap=null}
  const tx=genTexts(r),tab=analysisState.tab;
  let tc='';if(tab==='overview')tc=buildOverviewTab(r,tx);else if(tab==='investment')tc=buildInvestmentTab(r);else tc=buildReportTab(r,tx);
  const loc=r.sido?r.sido+' '+r.sigungu+' ':'';
  const fullLoc=(function(){var parts=[];if(r.sido)parts.push(r.sido);if(r.sigungu&&r.sigungu!==r.dong)parts.push(r.sigungu);parts.push(r.dong);return parts.join(' ')})();
  /* Hero section */
  let hero='<div class="bg-gradient-to-br from-blue-50 via-white to-blue-50 border-b border-gray-100">';
  hero+='<div class="max-w-6xl mx-auto px-6 py-10">';
  hero+='<div class="flex items-center gap-2 text-sm text-gray-400 mb-4"><a href="index.html" class="hover:text-blue-600">í™ˆ</a><span>/</span><a href="map.html" class="hover:text-blue-600">ì§€ë„ íƒìƒ‰</a><span>/</span><span class="text-gray-700">'+fullLoc+'</span></div>';
  hero+='<div class="flex flex-col md:flex-row md:items-center justify-between gap-6">';
  hero+='<div>';
  hero+='<p class="text-sm text-gray-400">'+(r.sido&&r.sigungu&&r.sigungu!==r.dong?r.sido+' '+r.sigungu:r.sido||'')+'</p>';
  hero+='<h1 class="text-3xl md:text-4xl font-bold mt-1">'+r.dong+' ì…ì§€ ë¶„ì„</h1>';
  hero+='<div class="flex items-center gap-3 mt-3">';
  hero+='<div class="px-4 py-2 rounded-xl text-lg font-bold '+getGradeColor(r.grade)+'">ì¢…í•© '+r.scores.total+'ì  &middot; '+r.grade+'ë“±ê¸‰</div>';
  var rptUrl="report0.html?q="+encodeURIComponent(r.dong);
  var pp=new URLSearchParams(window.location.search);
  if(pp.get("cname"))rptUrl+="&cname="+encodeURIComponent(pp.get("cname"));
  if(pp.get("cphone"))rptUrl+="&cphone="+encodeURIComponent(pp.get("cphone"));
  if(pp.get("cemail"))rptUrl+="&cemail="+encodeURIComponent(pp.get("cemail"));
  if(pp.get("cinfo"))rptUrl+="&cinfo="+encodeURIComponent(pp.get("cinfo"));
  hero+='<a href="'+rptUrl+'" target="_blank" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-600/20 flex items-center gap-2 no-underline"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>ë¶„ì„ ë¦¬í¬íŠ¸ ë§Œë“¤ê¸°</a>';
  hero+='</div>';
  hero+='</div>';
  hero+='<div class="flex flex-col items-end gap-2">';
  hero+='<div class="flex items-center gap-2"><input id="analysis-quick-input" type="text" placeholder="ë‹¤ë¥¸ ì§€ì—­ ì…ë ¥ (ì˜ˆ: í™ëŒ€, íŒêµ)" class="px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-600 outline-none w-56" onkeydown="if(event.key===\'Enter\')analyzeFromInput()"><button onclick="analyzeFromInput()" class="bg-blue-600 text-white text-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-blue-700 transition">ë¶„ì„</button></div>';
  hero+='</div>';
  hero+='</div>';
  hero+='</div></div>';

  /* Main content area */
  let main='<div class="max-w-6xl mx-auto px-6 py-8">';
  /* Map */
  main+='<div class="mb-8"><div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden"><div id="analysis-map" style="height:100vh;width:100%;z-index:0"></div><div class="px-4 py-2 text-[11px] text-gray-400 border-t border-gray-100 bg-gray-50 text-right">ì§€ë„ ìš°ì¸¡ í•˜ë‹¨ì˜ <b>ë²”ë¡€</b>ì—ì„œ ë§ˆì»¤Â·ë°°ì§€ ì„¤ëª…ì„ í™•ì¸í•˜ì„¸ìš”</div></div><div id="clinic-list-container" class="mt-4"></div></div>';
  /* Tabs */
  main+='<div class="border-b border-gray-200 mb-8"><div class="flex gap-1"><button onclick="switchTab(\'overview\',\''+r.dong_code+'\')" class="px-5 py-3 text-sm font-semibold border-b-2 transition '+(tab==='overview'?'border-blue-600 text-blue-600':'border-transparent text-gray-500')+'">ì¢…í•© ë¶„ì„</button><button onclick="switchTab(\'investment\',\''+r.dong_code+'\')" class="px-5 py-3 text-sm font-semibold border-b-2 transition '+(tab==='investment'?'border-blue-600 text-blue-600':'border-transparent text-gray-500')+'">íˆ¬ì ì‹œë®¬ë ˆì´í„°</button><button onclick="switchTab(\'report\',\''+r.dong_code+'\')" class="px-5 py-3 text-sm font-semibold border-b-2 transition '+(tab==='report'?'border-blue-600 text-blue-600':'border-transparent text-gray-500')+'">AI ì…ì§€ë¶„ì„ ë¦¬í¬íŠ¸</button></div></div>';
  main+=tc;
  main+='</div>';

  document.getElementById('analysis-root').innerHTML=hero+main;
  setTimeout(()=>renderAnalysisMap(r),100);
}

/* â”€â”€ Overview Tab â”€â”€ */
function buildOverviewTab(r,tx){
  const axes=[{i:'ğŸ‘¥',l:'ì¸êµ¬/ìˆ˜ìš”',s:r.scores.population,t:tx.popText},{i:'ğŸ¥',l:'ê²½ìŸ í™˜ê²½',s:r.scores.competition,t:tx.compText},{i:'ğŸ’°',l:'ë¹„ìš© íš¨ìœ¨',s:r.scores.cost,t:tx.costText},{i:'ğŸš‡',l:'ì ‘ê·¼ì„±',s:r.scores.access,t:tx.accessText},{i:'ğŸ“ˆ',l:'ì„±ì¥ì„±',s:r.scores.growth,t:tx.growthText}];
  let h='<div class="space-y-8"><div class="grid grid-cols-2 md:grid-cols-5 gap-4">';axes.forEach(a=>{h+='<div class="bg-white rounded-xl border border-gray-100 p-4 text-center shadow-sm"><p class="text-2xl">'+a.i+'</p><p class="text-xs text-gray-500 mt-1">'+a.l+'</p><p class="text-2xl font-bold mt-1 '+getScoreColor(a.s)+'">'+a.s+'</p><div class="mt-2 w-full h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full rounded-full '+getScoreBarColor(a.s)+'" style="width:'+a.s+'%"></div></div></div>'});h+='</div>';
  h+='<div class="grid md:grid-cols-4 gap-4">';[{l:"ê±°ì£¼ì¸êµ¬",v:fmt(r.population)+"ëª…",s:"20~39ì„¸ "+r.age_20_39_pct+"%"},{l:"ì¹˜ê³¼ ìˆ˜",v:r.dental_count+"ê°œ",s:"1:"+fmt(r.pop_per_clinic)},{l:"ì„ëŒ€ë£Œ",v:r.avg_rent_pyeong+"ë§Œ/í‰",s:"ì›” "+fmt(r.avg_rent_pyeong*r.area_pyeong)+"ë§Œ"},{l:"ìœ ë™ì¸êµ¬",v:fmt(r.daily_floating)+"ëª…",s:r.subway_station+" "+r.subway_walk_min+"ë¶„"}].forEach(i=>{h+='<div class="bg-gray-50 rounded-xl p-4"><p class="text-xs text-gray-500">'+i.l+'</p><p class="text-xl font-bold mt-1">'+i.v+'</p><p class="text-xs text-gray-400 mt-1">'+i.s+'</p></div>'});h+='</div>';
  h+='<div class="space-y-4"><h2 class="text-lg font-bold">5ì¶• ìƒì„¸ ë¶„ì„</h2>';axes.forEach(a=>{h+='<div class="bg-white rounded-xl border border-gray-100 p-5 shadow-sm"><div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><span class="text-xl">'+a.i+'</span><h3 class="font-bold">'+a.l+'</h3></div><span class="text-lg font-bold '+getScoreColor(a.s)+'">'+a.s+'ì </span></div><div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-3"><div class="h-full rounded-full '+getScoreBarColor(a.s)+'" style="width:'+a.s+'%"></div></div><p class="text-sm text-gray-600 leading-relaxed">'+a.t+'</p></div>'});h+='</div></div>';return h;
}

/* â”€â”€ Investment Tab â”€â”€ */
let invState={};
function getInv(r){if(!invState[r.dong_code])invState[r.dong_code]={py:r.area_pyeong,dep:r.avg_rent_pyeong*r.area_pyeong*10,intr:r.area_pyeong*200,eq:12000,op:3000};return invState[r.dong_code]}
function buildInvestmentTab(r){
  const s=getInv(r),py=s.py,mr=r.avg_rent_pyeong*py,mt=Math.round(py*5),lb=py<=30?800:py<=45?1500:2200;
  const dp=Math.round(r.population/Math.max(r.dental_count,1)/120),up=15,rev=dp*up*25,mat=Math.round(rev*0.15),oth=300;
  const ti=s.dep+s.intr+s.eq+s.op,tc=mr+mt+lb+mat+oth,prof=rev-tc,be=prof>0?Math.ceil(ti/prof):999;
  const sc={o:Math.max(1,Math.round(be*0.75)),b:be,c:Math.round(be*1.4)};
  let ch='';const cl=Math.min(36,sc.c+6);for(let i=1;i<=cl;i++){const cum=-ti+prof*i;const mx=Math.max(ti,Math.abs(cum));const h=Math.abs(cum)/mx*100;ch+='<div class="flex-1 flex flex-col justify-end items-center" title="'+i+'ê°œì›”: '+fmt(Math.round(cum))+'ë§Œì›"><div class="w-full rounded-t '+(cum>=0?'bg-blue-400':'bg-red-300')+'" style="height:'+Math.max(4,h*0.8)+'%"></div></div>'}
  return '<div class="space-y-8"><div class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h2 class="font-bold mb-4">ë©´ì  ì„¤ì •</h2><div class="flex items-center gap-4"><span class="text-sm text-gray-500">20í‰</span><input type="range" min="20" max="80" value="'+py+'" oninput="updPy(\''+r.dong_code+'\',this.value)" class="flex-1 accent-blue-600"><span class="text-sm text-gray-500">80í‰</span></div><p class="text-center mt-2 text-lg font-bold text-blue-600">'+py+'í‰</p></div><div class="grid md:grid-cols-2 gap-6"><div class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h2 class="font-bold mb-4">ì´ˆê¸° íˆ¬ìê¸ˆ</h2><div class="space-y-4"><div class="flex items-center justify-between"><span class="text-sm text-gray-600">ë³´ì¦ê¸ˆ</span><div class="flex items-center gap-1"><input type="number" value="'+s.dep+'" onchange="updFld(\''+r.dong_code+'\',\'dep\',this.value)" class="w-28 text-right px-2 py-1 border border-gray-200 rounded text-sm font-medium focus:ring-2 focus:ring-blue-600 outline-none"><span class="text-xs text-gray-400">ë§Œì›</span></div></div><div class="flex items-center justify-between"><span class="text-sm text-gray-600">ì¸í…Œë¦¬ì–´</span><div class="flex items-center gap-1"><input type="number" value="'+s.intr+'" onchange="updFld(\''+r.dong_code+'\',\'intr\',this.value)" class="w-28 text-right px-2 py-1 border border-gray-200 rounded text-sm font-medium focus:ring-2 focus:ring-blue-600 outline-none"><span class="text-xs text-gray-400">ë§Œì›</span></div></div><div class="flex items-center justify-between"><span class="text-sm text-gray-600">ì˜ë£Œì¥ë¹„</span><div class="flex items-center gap-1"><input type="number" value="'+s.eq+'" onchange="updFld(\''+r.dong_code+'\',\'eq\',this.value)" class="w-28 text-right px-2 py-1 border border-gray-200 rounded text-sm font-medium focus:ring-2 focus:ring-blue-600 outline-none"><span class="text-xs text-gray-400">ë§Œì›</span></div></div><div class="flex items-center justify-between"><span class="text-sm text-gray-600">ìš´ì˜ìê¸ˆ</span><div class="flex items-center gap-1"><input type="number" value="'+s.op+'" onchange="updFld(\''+r.dong_code+'\',\'op\',this.value)" class="w-28 text-right px-2 py-1 border border-gray-200 rounded text-sm font-medium focus:ring-2 focus:ring-blue-600 outline-none"><span class="text-xs text-gray-400">ë§Œì›</span></div></div><hr class="border-gray-100"><div class="flex items-center justify-between font-bold"><span>í•©ê³„</span><span class="text-blue-600 text-lg">'+fmt(ti)+'ë§Œì›</span></div><p class="text-xs text-gray-400 text-right">ì•½ '+(ti/10000).toFixed(1)+'ì–µì›</p></div></div><div class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h2 class="font-bold mb-4">ì›”ê°„ ì†ìµ</h2><div class="space-y-3"><div class="bg-green-50 rounded-lg p-3"><div class="flex items-center justify-between"><span class="text-sm text-green-700 font-medium">ì˜ˆìƒ ì›”ë§¤ì¶œ</span><span class="font-bold text-green-700">'+fmt(rev)+'ë§Œì›</span></div><p class="text-xs text-green-600 mt-1">ì¼ '+dp+'ëª… &times; '+up+'ë§Œì› &times; 25ì¼</p></div><div class="flex items-center justify-between text-sm"><span class="text-gray-600">(-) ì„ëŒ€ë£Œ</span><span class="text-red-500">'+fmt(mr)+'ë§Œ</span></div><div class="flex items-center justify-between text-sm"><span class="text-gray-600">(-) ê´€ë¦¬ë¹„</span><span class="text-red-500">'+fmt(mt)+'ë§Œ</span></div><div class="flex items-center justify-between text-sm"><span class="text-gray-600">(-) ì¸ê±´ë¹„</span><span class="text-red-500">'+fmt(lb)+'ë§Œ</span></div><div class="flex items-center justify-between text-sm"><span class="text-gray-600">(-) ì¬ë£Œë¹„ 15%</span><span class="text-red-500">'+fmt(mat)+'ë§Œ</span></div><div class="flex items-center justify-between text-sm"><span class="text-gray-600">(-) ê¸°íƒ€</span><span class="text-red-500">'+fmt(oth)+'ë§Œ</span></div><hr class="border-gray-100"><div class="flex items-center justify-between font-bold text-lg"><span>ì›” ìˆœì´ìµ</span><span class="'+(prof>0?'text-blue-600':'text-red-500')+'">'+(prof>0?'+':'')+fmt(prof)+'ë§Œì›</span></div></div></div></div><div class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h2 class="font-bold mb-4">ì†ìµë¶„ê¸° ë¶„ì„</h2><div class="grid grid-cols-3 gap-4 mb-6"><div class="rounded-xl p-4 text-center text-green-600 bg-green-50"><p class="text-xs font-medium">ë‚™ê´€ì </p><p class="text-3xl font-bold mt-1">'+sc.o+'</p><p class="text-xs">ê°œì›”</p></div><div class="rounded-xl p-4 text-center text-blue-600 bg-blue-50"><p class="text-xs font-medium">ê¸°ë³¸</p><p class="text-3xl font-bold mt-1">'+sc.b+'</p><p class="text-xs">ê°œì›”</p></div><div class="rounded-xl p-4 text-center text-orange-600 bg-orange-50"><p class="text-xs font-medium">ë³´ìˆ˜ì </p><p class="text-3xl font-bold mt-1">'+sc.c+'</p><p class="text-xs">ê°œì›”</p></div></div><div class="h-48 flex items-end gap-1">'+ch+'</div><div class="flex justify-between text-xs text-gray-400 mt-2"><span>1ê°œì›”</span><span>'+cl+'ê°œì›”</span></div></div></div>';
}
function updPy(code,v){const r=REGIONS.find(x=>x.dong_code===code);if(!r)return;getInv(r).py=Number(v);renderAnalysisContent(r)}
function updFld(code,f,v){const r=REGIONS.find(x=>x.dong_code===code);if(!r)return;getInv(r)[f]=Number(v);renderAnalysisContent(r)}

/* â”€â”€ Report Tab â”€â”€ */
function buildReportTab(r,tx){
  if(!analysisState.generated)return '<div class="text-center py-20"><p class="text-5xl mb-4">ğŸ“‹</p><h2 class="text-xl font-bold">AI ì…ì§€ë¶„ì„ ë¦¬í¬íŠ¸</h2><p class="text-gray-500 mt-2">5ì¶• ë¶„ì„ê³¼ íˆ¬ì ì‹œë®¬ë ˆì´ì…˜ì„ ì¢…í•©í•˜ì—¬<br>AIê°€ ë§ì¶¤í˜• ê²°ì • ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p><button onclick="genReport(\''+r.dong_code+'\')" '+(analysisState.generating?'disabled':'')+' class="mt-6 bg-blue-600 text-white font-semibold px-8 py-3 rounded-xl hover:bg-blue-700 transition disabled:opacity-50">'+(analysisState.generating?'<span class="flex items-center gap-2"><svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>AI ë¶„ì„ ì¤‘...</span>':'AI ì…ì§€ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±')+'</button></div>';
  const ts=r.scores.total,sl=ts>=80?'ë§¤ìš° ìœ ë§':ts>=70?'ì¶”ì²œ':ts>=60?'ì¡°ê±´ë¶€ ì¶”ì²œ':'ì£¼ì˜ í•„ìš”';
  const ti=r.avg_rent_pyeong*r.area_pyeong*10+r.area_pyeong*200+12000+3000,mr=r.avg_rent_pyeong*r.area_pyeong;
  const dp=Math.round(r.population/Math.max(r.dental_count,1)/120),mRev=dp*15*25;
  const mP=mRev-mr-800-Math.round(mRev*0.15)-300-Math.round(r.area_pyeong*5),be=mP>0?Math.ceil(ti/mP):999;
  const es=ts>=80?r.dong+'ì—ì„œì˜ ì¹˜ê³¼ ê°œì›ì€ ë§¤ìš° ìœ ë§í•©ë‹ˆë‹¤. íˆ¬ìê¸ˆ ì•½ '+(ti/10000).toFixed(1)+'ì–µ ëŒ€ë¹„ '+be+'ê°œì›” ë‚´ ì†ìµë¶„ê¸°ê°€ ê¸°ëŒ€ë©ë‹ˆë‹¤.':ts>=70?r.dong+'ì€ ê°œì›ì— ì í•©í•œ ì…ì§€ì…ë‹ˆë‹¤. ì›” ë§¤ì¶œ '+fmt(mRev)+'ë§Œì›ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.':r.dong+'ì—ì„œì˜ ê°œì›ì€ ê°€ëŠ¥í•˜ë‚˜, ë³´ìˆ˜ì ìœ¼ë¡œ '+Math.round(be*1.4)+'ê°œì›”ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
  const sa=[{l:'ì¸êµ¬/ìˆ˜ìš”',s:r.scores.population},{l:'ê²½ìŸ í™˜ê²½',s:r.scores.competition},{l:'ë¹„ìš© íš¨ìœ¨',s:r.scores.cost},{l:'ì ‘ê·¼ì„±',s:r.scores.access},{l:'ì„±ì¥ì„±',s:r.scores.growth}];
  const da=[{l:'ì¸êµ¬/ìˆ˜ìš”',s:r.scores.population,t:tx.popText},{l:'ê²½ìŸ í™˜ê²½',s:r.scores.competition,t:tx.compText},{l:'ë¹„ìš© íš¨ìœ¨',s:r.scores.cost,t:tx.costText},{l:'ì ‘ê·¼ì„±',s:r.scores.access,t:tx.accessText},{l:'ì„±ì¥ì„±',s:r.scores.growth,t:tx.growthText}];
  let rk='';if(r.scores.competition<60)rk+='<div class="bg-red-50 rounded-lg p-3 text-sm text-red-800">ì¹˜ê³¼ '+r.dental_count+'ê°œë¡œ ê²½ìŸ ì¹˜ì—´</div>';if(r.scores.cost<60)rk+='<div class="bg-red-50 rounded-lg p-3 text-sm text-red-800">í‰ë‹¹ '+r.avg_rent_pyeong+'ë§Œì› ë†’ì€ ì„ëŒ€ë£Œ</div>';if(r.pop_growth_rate<1)rk+='<div class="bg-red-50 rounded-lg p-3 text-sm text-red-800">ì¸êµ¬ ì¦ê°€ìœ¨ '+r.pop_growth_rate+'%</div>';if(!rk)rk='<div class="bg-yellow-50 rounded-lg p-3 text-sm text-yellow-800">ì „ë°˜ì ìœ¼ë¡œ ë¦¬ìŠ¤í¬ ë‚®ìŒ</div>';
  let op='';if(r.scores.population>=70)op+='<div class="bg-green-50 rounded-lg p-3 text-sm text-green-800">ì¸êµ¬ '+fmt(r.population)+'ëª… ìˆ˜ìš” íƒ„íƒ„</div>';if(r.pop_growth_rate>=3)op+='<div class="bg-green-50 rounded-lg p-3 text-sm text-green-800">ì¸êµ¬ +'+r.pop_growth_rate+'% ì„±ì¥</div>';if(r.age_20_39_pct>=35)op+='<div class="bg-green-50 rounded-lg p-3 text-sm text-green-800">20~39ì„¸ '+r.age_20_39_pct+'% ê³ ë‹¨ê°€ ìˆ˜ìš”</div>';
  return '<div class="max-w-3xl mx-auto space-y-8"><div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-8 text-white"><div class="flex items-center justify-between mb-4"><p class="text-blue-200 text-sm">AI ì…ì§€ë¶„ì„ ë¦¬í¬íŠ¸</p><p class="text-blue-200 text-xs">'+new Date().toLocaleDateString('ko-KR')+'</p></div><h2 class="text-2xl font-bold">'+(function(){var p=[];if(r.sido)p.push(r.sido);if(r.sigungu&&r.sigungu!==r.dong)p.push(r.sigungu);p.push(r.dong);return p.join(' ')})()+'</h2><p class="mt-1 text-blue-100">ì¢…í•© '+ts+'ì  ('+r.grade+'ë“±ê¸‰) â€” '+sl+'</p></div><section class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h3 class="font-bold flex items-center gap-2 mb-3"><span class="text-blue-600">01</span> í•œ ì¤„ íŒì •</h3><div class="bg-blue-50 rounded-lg p-4"><p class="font-medium leading-relaxed">'+es+'</p></div></section><section class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h3 class="font-bold flex items-center gap-2 mb-4"><span class="text-blue-600">02</span> ì¢…í•© ì ìˆ˜</h3><div class="flex items-center gap-6"><div class="text-center"><p class="text-5xl font-bold '+getScoreColor(ts)+'">'+ts+'</p><p class="text-sm text-gray-500 mt-1">'+r.grade+'ë“±ê¸‰</p></div><div class="flex-1 space-y-2">'+sa.map(a=>'<div class="flex items-center gap-2"><span class="text-xs text-gray-500 w-16">'+a.l+'</span><div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden"><div class="h-full rounded-full '+getScoreBarColor(a.s)+'" style="width:'+a.s+'%"></div></div><span class="text-xs font-bold w-8 text-right '+getScoreColor(a.s)+'">'+a.s+'</span></div>').join('')+'</div></div></section><section class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h3 class="font-bold flex items-center gap-2 mb-4"><span class="text-blue-600">03</span> 5ì¶• ìƒì„¸</h3><div class="space-y-4">'+da.map(a=>'<div class="border-l-4 border-blue-100 pl-4 py-2"><div class="flex items-center gap-2 mb-1"><span class="font-semibold text-sm">'+a.l+'</span><span class="text-xs font-bold px-2 py-0.5 rounded '+getGradeColor(a.s>=80?'A':a.s>=60?'B':'C')+'">'+a.s+'ì </span></div><p class="text-sm text-gray-600">'+a.t+'</p></div>').join('')+'</div></section><section class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h3 class="font-bold flex items-center gap-2 mb-4"><span class="text-blue-600">04</span> íˆ¬ì ìš”ì•½</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="bg-gray-50 rounded-lg p-3 text-center"><p class="text-xs text-gray-500">ì´ íˆ¬ìê¸ˆ</p><p class="text-lg font-bold">'+(ti/10000).toFixed(1)+'ì–µ</p></div><div class="bg-gray-50 rounded-lg p-3 text-center"><p class="text-xs text-gray-500">ì›”ë§¤ì¶œ</p><p class="text-lg font-bold text-green-600">'+fmt(mRev)+'ë§Œ</p></div><div class="bg-gray-50 rounded-lg p-3 text-center"><p class="text-xs text-gray-500">ì›” ìˆœì´ìµ</p><p class="text-lg font-bold text-blue-600">'+fmt(mP)+'ë§Œ</p></div><div class="bg-gray-50 rounded-lg p-3 text-center"><p class="text-xs text-gray-500">ì†ìµë¶„ê¸°</p><p class="text-lg font-bold">'+be+'ê°œì›”</p></div></div></section><section class="bg-white rounded-xl border border-gray-100 p-6 shadow-sm"><h3 class="font-bold flex items-center gap-2 mb-4"><span class="text-blue-600">05</span> ë¦¬ìŠ¤í¬ & ê¸°íšŒ</h3><div class="grid md:grid-cols-2 gap-4"><div><p class="font-semibold text-red-600 text-sm mb-2">ë¦¬ìŠ¤í¬</p><div class="space-y-2">'+rk+'</div></div><div><p class="font-semibold text-green-600 text-sm mb-2">ê¸°íšŒ</p><div class="space-y-2">'+op+'</div></div></div></section><div class="bg-gray-50 rounded-xl p-4 text-xs text-gray-400">ë³¸ ë¦¬í¬íŠ¸ëŠ” ì°¸ê³  ìë£Œì´ë©°, ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤. | &copy; DentalMap</div><div class="flex gap-3 justify-center pb-8"><button class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700">PDF ë‹¤ìš´ë¡œë“œ</button><a href="map.html" class="border border-gray-300 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-50 text-center">ë‹¤ë¥¸ ì§€ì—­ ë¶„ì„</a></div></div>';
}
function genReport(code){analysisState.generating=true;const r=REGIONS.find(x=>x.dong_code===code);if(r)renderAnalysisContent(r);setTimeout(()=>{analysisState.generating=false;analysisState.generated=true;if(r)renderAnalysisContent(r)},2000)}

/* â”€â”€ Show Search Form (when no ?q= parameter) â”€â”€ */
function showSearchForm(){
  document.getElementById('analysis-root').innerHTML='<div class="min-h-[80vh] flex items-center justify-center bg-gradient-to-br from-white via-blue-50/30 to-white"><div class="max-w-xl mx-auto px-6 text-center"><div class="text-6xl mb-6">ğŸ—ºï¸</div><h1 class="text-3xl md:text-4xl font-bold">ì¹˜ê³¼ ê°œì› ì…ì§€ ë¶„ì„</h1><p class="mt-4 text-lg text-gray-500 leading-relaxed">ë¶„ì„í•  ì§€ì—­ëª…ì„ ì…ë ¥í•˜ë©´<br>AIê°€ ì¸êµ¬, ê²½ìŸ, ë¹„ìš©, ì ‘ê·¼ì„±, ì„±ì¥ì„±ì„ ì¢…í•© ë¶„ì„í•©ë‹ˆë‹¤.</p><div class="mt-8 flex flex-col sm:flex-row gap-2 max-w-lg mx-auto"><div class="relative flex-1"><svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input id="hero-search-input" type="text" placeholder="ì§€ì—­ëª… ì…ë ¥ (ì˜ˆ: ì ì‹¤ì—­, í™ëŒ€, ìˆ˜ì›, íŒêµ)" class="w-full pl-11 pr-4 py-4 border-2 border-gray-200 rounded-xl text-base focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition" onkeydown="if(event.key===\'Enter\')analyzeFromHero()"></div><button onclick="analyzeFromHero()" class="bg-blue-600 text-white text-lg font-semibold px-8 py-4 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-600/20 whitespace-nowrap">ë¶„ì„í•˜ê¸°</button></div><div class="mt-8 max-w-lg mx-auto bg-white border border-gray-200 rounded-2xl p-6 text-left"><h3 class="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2"><svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>ì˜ë¢°ì ì •ë³´</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="block text-xs font-medium text-gray-500 mb-1">ì˜ë¢°ìëª…</label><input id="client-name" type="text" placeholder="í™ê¸¸ë™" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition"></div><div><label class="block text-xs font-medium text-gray-500 mb-1">íœ´ëŒ€í° ë²ˆí˜¸</label><input id="client-phone" type="tel" placeholder="010-0000-0000" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition"></div><div><label class="block text-xs font-medium text-gray-500 mb-1">ì´ë©”ì¼ ì£¼ì†Œ</label><input id="client-email" type="email" placeholder="example@email.com" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition"></div><div><label class="block text-xs font-medium text-gray-500 mb-1">ì˜ë¢°ì ì •ë³´</label><input id="client-info" type="text" placeholder="ì¹˜ê³¼ ì „ë¬¸ì˜, ê°œì› 3ë…„ì°¨ ë“±" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition"></div></div><p class="mt-3 text-xs text-gray-400">* ì˜ë¢°ì ì •ë³´ëŠ” ë¦¬í¬íŠ¸ì— í¬í•¨ë©ë‹ˆë‹¤ (ì„ íƒ ì…ë ¥)</p></div><p class="mt-4 text-sm text-gray-400">ì•„ë¬´ ì§€ì—­ì´ë‚˜ ì…ë ¥í•˜ì„¸ìš” â€” ë°”ë¡œ AI ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p><div class="mt-8 flex flex-wrap justify-center gap-2"><span class="text-xs text-gray-400">ë¹ ë¥¸ ë¶„ì„:</span><a href="analysis.html?q=ì ì‹¤ì—­" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">ì ì‹¤ì—­</a><a href="analysis.html?q=ê°•ë‚¨" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">ê°•ë‚¨</a><a href="analysis.html?q=íŒêµ" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">íŒêµ</a><a href="analysis.html?q=í™ëŒ€" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">í™ëŒ€</a><a href="analysis.html?q=ìˆ˜ì›" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">ìˆ˜ì›</a><a href="analysis.html?q=í•´ìš´ëŒ€" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">í•´ìš´ëŒ€</a><a href="analysis.html?q=ëŒ€ì „" class="text-xs bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-700 px-3 py-1.5 rounded-full transition">ëŒ€ì „</a></div></div></div>';
  setTimeout(()=>{const inp=document.getElementById('hero-search-input');if(inp)inp.focus()},200);
}

/* â”€â”€ Init on DOMContentLoaded â”€â”€ */
document.addEventListener('DOMContentLoaded',function(){
  const params=new URLSearchParams(window.location.search);
  const q=params.get('q');
  if(!q||!q.trim()){
    window.location.href='analysis.html';
    return;
  }
  const name=q.trim();
  (async function(){
    /* Try to find in existing REGIONS by dong, sigungu, or sido */
    let r=REGIONS.find(x=>x.dong===name||x.dong.includes(name));
    if(!r){
      r=REGIONS.find(x=>x.sigungu.includes(name)||x.sido.includes(name));
    }
    if(!r){
      /* Generate a new region (async â€” ì¹´ì¹´ì˜¤ ì§€ì˜¤ì½”ë”© ì‚¬ìš©) */
      r=await addGeneratedRegion(name);
    }
    /* Update page title */
    document.title=r.dong+' ì…ì§€ ë¶„ì„ â€” ë´íƒˆë§µAI ì¹˜ê³¼ê°œì› ì…ì§€ë¶„ì„';
    analysisState={tab:'overview',generating:false,generated:false};
    renderAnalysisContent(r);
  })();
});
</script>
</body>
</html>
